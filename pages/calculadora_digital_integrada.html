
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧮 Calculadora Digital Expert</title>
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Comic Sans MS', cursive, sans-serif; }
        .font-dyslexic { font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const activityConfig = {
            title: "Calculadora Digital Expert",
            subject: "matematica",
            activity: "calculadora_digital",
            emoji: "🧮",
        };

        const MediaManager = {
            basePath: '../media',
            getQuestionMedia: function(blockNum, questionNum) {
                const blockPath = `${this.basePath}/${activityConfig.subject}/${activityConfig.activity}/bloco_${blockNum}`;
                return {
                    audio: {
                        enunciado: `${blockPath}/bloco_${blockNum}_questao_${questionNum}_enunciado.mp3`,
                        explicacao: `${blockPath}/bloco_${blockNum}_questao_${questionNum}_explicacao.mp3`
                    }
                };
            }
        };

        const SoundSystem = {
            play: (src) => { try { new Audio(src).play().catch(e => {}); } catch (e) {} },
            success: () => SoundSystem.play(`../media/sons/feedback/acertos/acerto_${Math.ceil(Math.random() * 4)}.mp3`),
            error: () => SoundSystem.play(`../media/sons/feedback/erros/erro_${Math.ceil(Math.random() * 4)}.mp3`),
            click: () => SoundSystem.play('../media/sons/feedback/click.mp3')
        };

        const CalculadoraDigitalIntegrada = () => {
            const [studentName, setStudentName] = useState('');
            const [hasStarted, setHasStarted] = useState(false);
            const [font, setFont] = useState('Comic Sans MS');
            const [currentScreen, setCurrentScreen] = useState('start');
            const [currentLevel, setCurrentLevel] = useState('bloco_1');
            const [currentMode, setCurrentMode] = useState('montador');
            const [questionModes, setQuestionModes] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [sessionResults, setSessionResults] = useState([]);
            const [startTime, setStartTime] = useState(null);
            const [currentQuestionData, setCurrentQuestionData] = useState(null);
            const [calculatorDisplay, setCalculatorDisplay] = useState('0');
            const [currentExpression, setCurrentExpression] = useState('');
            const [userAnswer, setUserAnswer] = useState(null);
            const [attempts, setAttempts] = useState(0);
            const [totalScore, setTotalScore] = useState(0);
            const [isCorrect, setIsCorrect] = useState(false);
            const [feedbackMessage, setFeedbackMessage] = useState('');
            const [showFeedback, setShowFeedback] = useState(false);
            const [audioError, setAudioError] = useState({});

            const levels = {
                bloco_1: { name: "🌟 Estrela Cadente", emoji: "🌟", description: "Primeiros passos", color: "from-blue-400 to-cyan-500", level: "Iniciante", questions: [ { context: "🎮 João comprou {a} V-Bucks e ganhou {b} de presente! Total? 💰", range: [10, 50] }, { context: "🍕 A pizzaria vendeu {a} pizzas de manhã e {b} à tarde. Total? 🍕", range: [15, 45] }, { context: "⚽ O time fez {a} gols no 1º jogo e {b} no 2º. Total? ⚽", range: [2, 8] }, { context: "📚 Ana leu {a} páginas ontem e {b} hoje. Total? 📖", range: [20, 60] }, { context: "🎵 O playlist tem {a} músicas pop e {b} rock. Total? 🎶", range: [12, 35] } ] },
                bloco_2: { name: "🚀 Foguete Espacial", emoji: "🚀", description: "Decolando nos números", color: "from-green-400 to-teal-500", level: "Iniciante", questions: [ { context: "🏗️ Maria precisa de {a} blocos vermelhos e {b} azuis. Total? 🧱", range: [25, 75] }, { context: "🎪 O circo vendeu {a} ingressos de manhã e {b} à noite. Total? 🎭", range: [30, 80] }, { context: "🛒 Papai comprou {a} frutas e {b} verduras. Total? 🥕", range: [15, 55] }, { context: "🎨 O artista usou {a} tintas vermelhas e {b} azuis. Total? 🖌️", range: [8, 25] }, { context: "🐾 No parque, vi {a} cachorros e {b} gatos. Total? 🐕", range: [12, 40] } ] },
                bloco_3: { name: "⭐ Constelação Brilhante", emoji: "⭐", description: "Conectando estrelas", color: "from-purple-400 to-pink-500", level: "Iniciante", questions: [ { context: "🎯 O arcade deu {a} tickets no basquete e {b} nos dardos. Total? 🏆", range: [40, 120] }, { context: "📱 O app teve {a} downloads de manhã e {b} à tarde. Total? 📈", range: [50, 150] }, { context: "🍔 A lanchonete fez {a} hambúrgueres e {b} batatas fritas. Total? 🍟", range: [35, 95] }, { context: "👾 No servidor, entraram {a} jogadores novos e {b} antigos. Total?", range: [60, 180] }, { context: "🎬 O cinema vendeu {a} ingressos de ação e {b} de comédia. Total? 🍿", range: [45, 135] } ] },
            };

            Object.keys(levels).forEach(blockKey => {
                const blockNum = parseInt(blockKey.split('_')[1]);
                levels[blockKey].questions.forEach((question, index) => {
                    question.media = MediaManager.getQuestionMedia(blockNum, index + 1);
                });
            });

            const handleStart = (name) => {
                if (name.trim()) {
                    setStudentName(name);
                    setHasStarted(true);
                    setCurrentScreen('selection');
                }
            };

            const handleLevelSelect = (level) => {
                setCurrentLevel(level);
                setCurrentQuestion(0);
                setCurrentScreen('game');
                setStartTime(Date.now());
                const modes = ['montador', 'detector', 'montador', 'detector', 'montador'];
                setQuestionModes(modes.sort(() => Math.random() - 0.5));
                generateQuestion(level, 0);
            };

            const generateQuestion = (level = currentLevel, questionIndex = currentQuestion) => {
                const levelData = levels[level];
                const qTemplate = levelData.questions[questionIndex];
                const [min, max] = qTemplate.range;
                const a = Math.floor(Math.random() * (max - min)) + min;
                const b = Math.floor(Math.random() * (max - min)) + min;
                setCurrentQuestionData({ a, b, result: a + b, context: qTemplate.context.replace('{a}', a).replace('{b}', b), level, questionIndex, media: qTemplate.media });
                setCalculatorDisplay('0');
                setCurrentExpression('');
                setUserAnswer(null);
                setAttempts(0);
                setShowFeedback(false);
                setAudioError({});
            };

            const checkAnswer = (answer) => {
                const isAnswerCorrect = answer === currentQuestionData.result;
                setAttempts(attempts + 1);
                setIsCorrect(isAnswerCorrect);

                if(isAnswerCorrect) {
                    SoundSystem.success();
                    setFeedbackMessage('🎉 INCRÍVEL! Você é um MESTRE da matemática! ⭐');
                } else {
                    SoundSystem.error();
                    if (attempts === 0) {
                        setFeedbackMessage('🎯 Quase lá! Tente mais uma vez! 💪');
                    } else {
                        setFeedbackMessage(`📚 Resposta correta: ${currentQuestionData.result.toLocaleString()}`);
                    }
                }
                setShowFeedback(true);

                if (isAnswerCorrect || attempts >= 1) {
                     setTimeout(() => nextQuestion(), isAnswerCorrect ? 2500 : 4000);
                }
            };
            
            const nextQuestion = () => {
                setShowFeedback(false);
                if (currentQuestion >= 4) { // 5 questions per block (0-4)
                    setCurrentScreen('result');
                    return;
                }
                const newQuestionIndex = currentQuestion + 1;
                setCurrentQuestion(newQuestionIndex);
                setCurrentMode(questionModes[newQuestionIndex]);
                setStartTime(Date.now());
                generateQuestion(currentLevel, newQuestionIndex);
            };

            const handleAudioError = (type) => setAudioError(prev => ({...prev, [type]: true}));

            if (!hasStarted) {
                return <div className={`min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-8"><div className="text-6xl mb-4">🧮</div><h1 className="text-3xl font-bold">Calculadora Digital Expert</h1></div>
                        <div className="space-y-6">
                            <input type="text" placeholder="Digite seu nome aqui" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full px-4 py-3 border-2 rounded-xl text-lg text-center" />
                            <button onClick={() => handleStart(studentName)} disabled={!studentName.trim()} className="w-full bg-purple-500 text-white font-bold py-4 rounded-xl text-lg disabled:opacity-50">🎯 COMEÇAR</button>
                        </div>
                    </div>
                </div>;
            }

            if (currentScreen === 'game') {
                return <div className={`min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl p-6 mb-6">
                            <h1 className="text-2xl font-bold">{levels[currentLevel].name}</h1>
                            <div className="text-center font-bold text-gray-700">Questão {currentQuestion + 1} de 5</div>
                        </div>
                        {currentQuestionData && (
                            <>
                                <div className="bg-yellow-100 border-4 border-yellow-300 rounded-2xl p-6 mb-6 text-center">
                                    <div className="text-xl font-bold text-gray-800">{currentQuestionData.context}</div>
                                </div>
                                <div className="media-controls mb-6 bg-gray-50 p-4 rounded-lg border">
                                    <label className="block text-sm font-semibold text-blue-700 mb-2">🔊 Ouvir Enunciado:</label>
                                    {!audioError.enunciado ? (
                                        <audio controls className="w-full" onError={() => handleAudioError('enunciado')} src={currentQuestionData.media.audio.enunciado} />
                                    ) : <div className="text-gray-500 italic text-sm">Áudio do enunciado indisponível.</div>}
                                    
                                    <label className="block text-sm font-semibold text-green-700 mb-2 mt-4">💡 Ouvir Explicação (após responder):</label>
                                    {!audioError.explicacao && userAnswer !== null ? (
                                        <audio controls className="w-full" onError={() => handleAudioError('explicacao')} src={currentQuestionData.media.audio.explicacao} />
                                    ) : <div className="text-gray-500 italic text-sm">{userAnswer !== null ? "Áudio da explicação indisponível." : "Responda para liberar a explicação."}</div>}
                                </div>
                                {/* Rest of the game UI */}
                            </>
                        )}
                    </div>
                </div>;
            }
            
            return <div>Carregando...</div>; // Fallback
        };

        ReactDOM.render(<CalculadoraDigitalIntegrada />, document.getElementById('root'));
    </script>
</body>
</html>
