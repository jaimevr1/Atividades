<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßÆ Calculadora Digital Expert</title>
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Database Integration Scripts -->
    <script src="../src/data/questionDatabase.js"></script>
    <script src="../src/config/activityMapping.js"></script>
    <script src="../src/engines/CompetencyEngine.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .font-dyslexic {
            font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div class="spinner"></div>
            Carregando Calculadora Digital...
        </div>
    </div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Database-driven Calculator Activity
        const CalculadoraDigitalIntegrada = () => {
            // Database initialization
            const [database] = useState(() => {
                const db = new QuestionDatabase();
                const competencyEngine = new CompetencyEngine(db);

                // Get activity configuration from mapping
                const activityConfig = ActivityMapping.getActivityConfig('calculadora_digital_integrada');
                if (!activityConfig) {
                    console.error('Activity configuration not found for calculadora_digital_integrada');
                    return { db, competencyEngine, activityConfig: null, questionBlocks: [] };
                }

                // Generate questions for each block using the mapping
                const questionBlocks = activityConfig.questionBlocks.map(blockConfig => {
                    const blockData = ActivityMapping.getBlockQuestions(blockConfig.blockId);
                    return {
                        blockId: blockConfig.blockId,
                        questions: blockData ? blockData.questions : [],
                        difficulty: blockData ? blockData.difficulty : 'medium',
                        topic: blockData ? blockData.topic : 'calculator',
                        questionCount: blockConfig.questions
                    };
                });

                // OLD FALLBACK: Load calculator questions from activity mappings
                const calculatorQuestionIds = [
                    "matematica_general_vcy81y_1757769156185",
                    "matematica_shopping_f9849l_1757769156186",
                    "matematica_toys_enwz8s_1757769156186",
                    "matematica_general_rt2dln_1757769156186",
                    "matematica_general_r8mtpu_1757769156186",
                    "matematica_general_rlivob_1757769156186",
                    "matematica_general_kx88tx_1757769156186",
                    "matematica_general_2w5rzo_1757769156186",
                    "matematica_general_3tgluc_1757769156186",
                    "matematica_entertainment_1g47wc_1757769156186",
                    "matematica_toys_6ji9v3_1757769156186",
                    "matematica_general_ctsw7x_1757769156186",
                    "matematica_general_a57jah_1757769156186",
                    "matematica_farm_c3gg5v_1757769156186",
                    "matematica_general_yk49k9_1757769156187",
                    "matematica_general_csw680_1757769156187",
                    "matematica_shopping_wfrbrx_1757769156187",
                    "matematica_mathematics_rr3ub1_1757769156187",
                    "matematica_general_8g1oto_1757769156187",
                    "matematica_general_85c1ux_1757769156187",
                    "matematica_general_e932l9_1757769156187",
                    "matematica_general_2pyf0x_1757769156187",
                    "matematica_general_1mtobr_1757769156187",
                    "matematica_general_58i6qc_1757769156187",
                    "matematica_general_r1tex2_1757769156187",
                    "matematica_general_xktwur_1757769156187",
                    "matematica_general_cxrfyy_1757769156187",
                    "matematica_general_i25vjg_1757769156187",
                    "matematica_general_sfdgjq_1757769156187",
                    "matematica_general_zzfmq_1757769156187",
                    "matematica_general_5ulluk_1757769156187",
                    "matematica_general_dbojf8_1757769156187",
                    "matematica_general_o75wk_1757769156187",
                    "matematica_general_bknbpa_1757769156187",
                    "matematica_general_tptcwb_1757769156187",
                    "matematica_general_lsz4jv_1757769156187",
                    "matematica_general_sooiil_1757769156187",
                    "matematica_general_5yf5q_1757769156187",
                    "matematica_general_m0sx8g_1757769156187",
                    "matematica_toys_5u18y3_1757769156187",
                    "matematica_general_4ttz8y_1757769156187",
                    "matematica_general_781vew_1757769156187",
                    "matematica_general_xe6zpn_1757769156187",
                    "matematica_general_ydn8br_1757769156187",
                    "matematica_general_j0hlny_1757769156187",
                    "matematica_general_83sr2x_1757769156187",
                    "matematica_general_qvqv4c_1757769156188",
                    "matematica_general_52wn7z_1757769156188",
                    "matematica_general_2mfda7_1757769156188",
                    "matematica_general_hm2clm_1757769156188",
                    "matematica_general_unh1kz_1757769156188",
                    "matematica_general_4hn74_1757769156188",
                    "matematica_general_xqgsc4_1757769156188",
                    "matematica_general_yhdor5_1757769156188",
                    "matematica_calculator_ll0pr7_1757769156188",
                    "matematica_general_t1v459_1757769156188",
                    "matematica_general_qt37jo_1757769156188",
                    "matematica_general_1u8x13_1757769156188",
                    "matematica_general_kvbuqn_1757769156188",
                    "matematica_general_k8b4je_1757769156188"
                ];

                return { db, competencyEngine, activityConfig, questionBlocks };
            });

            const [databaseBlocks, setDatabaseBlocks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [loadError, setLoadError] = useState(null);
            // Estados principais
            const [studentName, setStudentName] = useState('');
            const [hasStarted, setHasStarted] = useState(false);
            const [font, setFont] = useState('Comic Sans MS');
            const [currentScreen, setCurrentScreen] = useState('start'); // start, selection, game, result
            const [currentLevel, setCurrentLevel] = useState('bloco_1');
            const [currentMode, setCurrentMode] = useState('montador');
            const [questionModes, setQuestionModes] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [sessionResults, setSessionResults] = useState([]);
            const [startTime, setStartTime] = useState(null);

            // Estados do jogo
            const [currentQuestionData, setCurrentQuestionData] = useState(null);
            const [calculatorDisplay, setCalculatorDisplay] = useState('0');
            const [currentExpression, setCurrentExpression] = useState('');
            const [userAnswer, setUserAnswer] = useState(null);
            const [attempts, setAttempts] = useState(0);
            const [totalScore, setTotalScore] = useState(0);
            const [currentStreak, setCurrentStreak] = useState(0);
            const [correctAnswers, setCorrectAnswers] = useState(0);
            const [questionsAnswered, setQuestionsAnswered] = useState(0);
            const [showFeedback, setShowFeedback] = useState(false);
            const [feedbackMessage, setFeedbackMessage] = useState('');
            const [isCorrect, setIsCorrect] = useState(false);

            // Database-driven block themes (preserving original visual design)
            const blockThemes = [
                {
                    key: 'bloco_1',
                    name: 'üåü Estrela Cadente',
                    emoji: 'üåü',
                    description: 'Primeiros passos na gal√°xia dos n√∫meros',
                    color: 'from-blue-400 to-cyan-500',
                    level: 'Iniciante',
                    difficulty: 'easy'
                },
                {
                    key: 'bloco_2',
                    name: 'üöÄ Foguete Espacial',
                    emoji: 'üöÄ',
                    description: 'Decolando rumo aos grandes n√∫meros',
                    color: 'from-green-400 to-teal-500',
                    level: 'Iniciante',
                    difficulty: 'easy'
                },
                {
                    key: 'bloco_3',
                    name: '‚≠ê Constela√ß√£o Brilhante',
                    emoji: '‚≠ê',
                    description: 'Conectando estrelas matem√°ticas',
                    color: 'from-purple-400 to-pink-500',
                    level: 'Aventureiro',
                    difficulty: 'medium'
                },
                {
                    key: 'bloco_4',
                    name: 'üè∞ Castelo dos N√∫meros',
                    emoji: 'üè∞',
                    description: 'Defendendo o reino com matem√°tica',
                    color: 'from-orange-400 to-red-500',
                    level: 'Aventureiro',
                    difficulty: 'medium'
                },
                {
                    key: 'bloco_5',
                    name: 'üåä Oceano Matem√°tico',
                    emoji: 'üåä',
                    description: 'Navegando em √°guas profundas',
                    color: 'from-cyan-400 to-blue-600',
                    level: 'Mestre',
                    difficulty: 'hard'
                },
                {
                    key: 'bloco_6',
                    name: 'üéØ Arena dos Campe√µes',
                    emoji: 'üéØ',
                    description: 'Competindo com os melhores matem√°ticos',
                    color: 'from-yellow-400 to-orange-500',
                    level: 'Lenda',
                    difficulty: 'hard'
                }
            ];

            // Database initialization effect
            useEffect(() => {
                const initializeDatabase = async () => {
                    try {
                        setIsLoading(true);

                        if (!database.activityConfig) {
                            throw new Error('Activity configuration not available');
                        }

                        console.log('Initializing with activity config:', database.activityConfig);

                        // Create database questions using activity mapping
                        const organizedBlocks = database.questionBlocks.map((blockConfig, blockIndex) => {
                            const blockQuestions = [];

                            // Generate questions for this block based on mapping
                            for (let i = 0; i < blockConfig.questionCount; i++) {
                                const questionData = generateDatabaseQuestion(
                                    blockConfig.blockId,
                                    i,
                                    blockConfig.difficulty,
                                    blockConfig.topic,
                                    blockIndex
                                );
                                blockQuestions.push(questionData);
                            }

                            return {
                                ...blockThemes[blockIndex],
                                questions: blockQuestions,
                                questionCount: blockQuestions.length,
                                blockId: blockConfig.blockId,
                                difficulty: blockConfig.difficulty,
                                topic: blockConfig.topic
                            };
                        });

                        // Populate database with generated questions
                        organizedBlocks.forEach(block => {
                            block.questions.forEach(question => {
                                database.db.addQuestion({
                                    statement: question.context,
                                    context: question.metadata?.context || 'calculator',
                                    subject: 'matematica',
                                    difficulty: question.metadata?.difficulty || 'medium',
                                    mathematics: question.mathematics,
                                    originalActivity: 'calculadora_digital_integrada'
                                });
                            });
                        });

                        setDatabaseBlocks(organizedBlocks);
                        setIsLoading(false);

                        console.log('Database initialization completed with', organizedBlocks.length, 'blocks');

                    } catch (error) {
                        console.error('Database initialization failed:', error);
                        setLoadError(`Falha ao carregar quest√µes do banco de dados: ${error.message}`);
                        setIsLoading(false);
                    }
                };

                initializeDatabase();
            }, []);

            // Generate synthetic questions from database IDs
            const generateDatabaseQuestion = (blockId, questionIndex, difficulty, topic, blockNumber) => {
                // Context templates organized by topic and difficulty
                const contextsByTopic = {
                    calculator: {
                        easy: [
                            'üßÆ Calcule: {a} + {b}',
                            'üì± Na calculadora, some {a} + {b}',
                            'üî¢ Quanto √© {a} + {b}?',
                            '‚ö° Use a calculadora: {a} + {b}'
                        ],
                        medium: [
                            'üéÆ Jo√£o tinha {a} moedas e ganhou {b} moedas no jogo. Quantas moedas tem agora?',
                            'üçï A lanchonete vendeu {a} sandu√≠ches pela manh√£ e {b} √† tarde. Quantos no total?',
                            'üìö Maria resolveu {a} exerc√≠cios ontem e {b} hoje. Quantos exerc√≠cios ao todo?',
                            'üè™ A loja vendeu {a} produtos de manh√£ e {b} √† tarde. Total vendido?'
                        ],
                        hard: [
                            'üè¢ A empresa produziu {a} itens na primeira semana e {b} na segunda. Total produzido?',
                            'üöó O carro percorreu {a} km no primeiro dia e {b} km no segundo. Quantos km ao todo?',
                            'üí∞ O investidor ganhou R$ {a} no primeiro m√™s e R$ {b} no segundo. Total ganho?',
                            'üìä A pesquisa coletou {a} dados na primeira fase e {b} na segunda. Total de dados?'
                        ]
                    }
                };

                const topicContexts = contextsByTopic[topic] || contextsByTopic.calculator;
                const difficultyContexts = topicContexts[difficulty] || topicContexts.medium;
                const contexts = difficultyContexts;

                const blockRanges = {
                    easy: [[10, 50], [25, 75]],
                    medium: [[50, 150], [100, 300], [150, 400]],
                    hard: [[200, 500], [400, 800], [300, 700]]
                };

                const ranges = blockRanges[difficulty] || blockRanges.medium;
                const [minRange, maxRange] = ranges[Math.min(blockNumber, ranges.length - 1)] || [50, 200];
                const contextIndex = questionIndex % contexts.length;

                const a = Math.floor(Math.random() * (maxRange - minRange)) + minRange;
                const b = Math.floor(Math.random() * (maxRange - minRange)) + minRange;

                // Generate unique ID for database integration
                const uniqueId = `${blockId}_q${questionIndex}_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;

                return {
                    id: uniqueId,
                    context: contexts[contextIndex].replace('{a}', a.toLocaleString()).replace('{b}', b.toLocaleString()),
                    a,
                    b,
                    result: a + b,
                    mathematics: {
                        operation: 'adi√ß√£o',
                        operands: [a, b],
                        result: a + b,
                        expression: `${a} + ${b}`,
                        explanation: `Para resolver ${a} + ${b}, somamos os dois n√∫meros: ${a + b}`
                    },
                    metadata: {
                        difficulty,
                        subject: 'matematica',
                        context: topic,
                        blockId,
                        blockNumber,
                        competencies: ['calculation', 'operation_identification', 'problem_solving']
                    }
                };
            };

            // Generate fallback question for missing slots
            const generateFallbackQuestion = (blockIndex, questionIndex) => {
                const blockRanges = [
                    [10, 50], [25, 75], [50, 150], [100, 300], [200, 500], [400, 800]
                ];
                const [minRange, maxRange] = blockRanges[blockIndex] || [50, 200];

                const a = Math.floor(Math.random() * (maxRange - minRange)) + minRange;
                const b = Math.floor(Math.random() * (maxRange - minRange)) + minRange;

                return {
                    id: `fallback_${blockIndex}_${questionIndex}`,
                    context: `üßÆ Calcule: ${a.toLocaleString()} + ${b.toLocaleString()}`,
                    a,
                    b,
                    result: a + b,
                    mathematics: {
                        operation: 'adi√ß√£o',
                        operands: [a, b],
                        result: a + b
                    },
                    metadata: {
                        difficulty: blockThemes[blockIndex]?.difficulty || 'medium',
                        subject: 'matematica',
                        blockIndex
                    }
                };
            };

            // Get effective levels (database blocks or fallback)
            const getEffectiveLevels = () => {
                if (databaseBlocks.length > 0) {
                    const levels = {};
                    databaseBlocks.forEach(block => {
                        levels[block.key] = block;
                    });
                    return levels;
                }
                return fallbackLevels;
            };

            // Fallback levels (original hardcoded structure)
            const fallbackLevels = {
                // N√çVEL INICIANTE - 3 blocos de 5 quest√µes cada
                bloco_1: {
                    name: "üåü Estrela Cadente",
                    emoji: "üåü", 
                    description: "Primeiros passos na gal√°xia dos n√∫meros",
                    color: "from-blue-400 to-cyan-500",
                    level: "Iniciante",
                    questions: [
                        { context: "üéÆ Jo√£o comprou {a} V-Bucks e ganhou {b} V-Bucks de presente! Quantos V-Bucks ele tem agora? üí∞", range: [10, 50] },
                        { context: "üçï A pizzaria vendeu {a} pizzas de manh√£ e {b} pizzas √† tarde. Quantas pizzas venderam hoje? üçï", range: [15, 45] },
                        { context: "‚öΩ No campeonato, o time fez {a} gols no primeiro jogo e {b} gols no segundo. Total de gols? ‚öΩ", range: [2, 8] },
                        { context: "üìö Ana leu {a} p√°ginas ontem e {b} p√°ginas hoje. Quantas p√°ginas leu no total? üìñ", range: [20, 60] },
                        { context: "üéµ O playlist tem {a} m√∫sicas pop e {b} m√∫sicas rock. Quantas m√∫sicas ao todo? üé∂", range: [12, 35] }
                    ]
                },
                bloco_2: {
                    name: "üöÄ Foguete Espacial",
                    emoji: "üöÄ",
                    description: "Decolando rumo aos grandes n√∫meros",
                    color: "from-green-400 to-teal-500", 
                    level: "Iniciante",
                    questions: [
                        { context: "üèóÔ∏è Maria precisa de {a} blocos vermelhos e {b} blocos azuis para sua constru√ß√£o. Quantos blocos no total? üß±", range: [25, 75] },
                        { context: "üé™ O circo vendeu {a} ingressos pela manh√£ e {b} √† noite. Quantas pessoas assistiram? üé≠", range: [30, 80] },
                        { context: "üõí No mercado, papai comprou {a} frutas e {b} verduras. Quantos itens ao todo? ü•ï", range: [15, 55] },
                        { context: "üé® O artista usou {a} tintas vermelhas e {b} tintas azuis. Quantas tintas usou? üñåÔ∏è", range: [8, 25] },
                        { context: "üêæ No parque, vi {a} cachorros e {b} gatos. Quantos animais vi no total? üêï", range: [12, 40] }
                    ]
                },
                bloco_3: {
                    name: "‚≠ê Constela√ß√£o Brilhante",
                    emoji: "‚≠ê",
                    description: "Conectando estrelas matem√°ticas",
                    color: "from-purple-400 to-pink-500",
                    level: "Iniciante", 
                    questions: [
                        { context: "üéØ O arcade deu {a} tickets no jogo de basquete e {b} no jogo de dardos. Quantos tickets ganhei? üèÜ", range: [40, 120] },
                        { context: "üì± O app teve {a} downloads de manh√£ e {b} √† tarde. Total de downloads hoje? üìà", range: [50, 150] },
                        { context: "üçî A lanchonete fez {a} hamb√∫rgueres e {b} batatas fritas. Quantos itens prepararam? üçü", range: [35, 95] },
                        { context: "üéÆ No servidor, entraram {a} jogadores novos e {b} jogadores antigos. Quantos players online? üëæ", range: [60, 180] },
                        { context: "üé¨ O cinema vendeu {a} ingressos para o filme de a√ß√£o e {b} para a com√©dia. Total vendido? üçø", range: [45, 135] }
                    ]
                },

                // N√çVEL AVENTUREIRO - 3 blocos de 5 quest√µes cada  
                bloco_4: {
                    name: "üè∞ Castelo dos N√∫meros",
                    emoji: "üè∞",
                    description: "Defendendo o reino com matem√°tica",
                    color: "from-orange-400 to-red-500",
                    level: "Aventureiro",
                    questions: [
                        { context: "‚öîÔ∏è O cavaleiro coletou {a} moedas de ouro no castelo e {b} no drag√£o. Quanto ouro tem? üí∞", range: [100, 300] },
                        { context: "üè™ A loja vendeu {a} itens pela manh√£ e {b} √† tarde. Quantos itens venderam hoje? üõçÔ∏è", range: [150, 400] },
                        { context: "üöó Na corrida, o carro azul fez {a} pontos e o vermelho {b} pontos. Quantos pontos somados? üèÅ", range: [120, 350] },
                        { context: "üé™ O m√°gico fez {a} truques no primeiro show e {b} no segundo. Quantos truques ao todo? ‚ú®", range: [80, 250] },
                        { context: "üåü O influencer ganhou {a} seguidores no YouTube e {b} no TikTok. Total de seguidores? üì±", range: [200, 500] }
                    ]
                },
                bloco_5: {
                    name: "üåä Oceano Matem√°tico", 
                    emoji: "üåä",
                    description: "Navegando em √°guas profundas",
                    color: "from-cyan-400 to-blue-600",
                    level: "Aventureiro",
                    questions: [
                        { context: "üê† O aqu√°rio tinha {a} peixes tropicais e chegaram {b} peixes novos. Quantos peixes agora? üêü", range: [180, 450] },
                        { context: "üèñÔ∏è Na praia, constru√≠ {a} castelos de areia de manh√£ e {b} √† tarde. Quantos castelos fiz? üè∞", range: [160, 420] },
                        { context: "‚õµ O barco pescou {a} peixes pela manh√£ e {b} √† tarde. Quantos peixes pescaram? üé£", range: [140, 380] },
                        { context: "üå∫ A ilha tem {a} coqueiros na praia norte e {b} na praia sul. Quantos coqueiros no total? ü••", range: [220, 550] },
                        { context: "üèÑ O surfista pegou {a} ondas de manh√£ e {b} √† tarde. Quantas ondas surfou hoje? üåä", range: [25, 85] }
                    ]
                },
                bloco_6: {
                    name: "üéØ Arena dos Campe√µes",
                    emoji: "üéØ",
                    description: "Competindo com os melhores matem√°ticos",
                    color: "from-yellow-400 to-orange-500", 
                    level: "Aventureiro",
                    questions: [
                        { context: "üèÜ No torneio, marquei {a} pontos na semifinal e {b} na final. Quantos pontos no total? ‚ö°", range: [300, 700] },
                        { context: "üéÆ O gamer fez {a} kills no primeiro mapa e {b} no segundo. Quantos kills ao todo? üíÄ", range: [250, 600] },
                        { context: "üé™ O acrobata deu {a} saltos no primeiro n√∫mero e {b} no segundo. Total de saltos? ü§∏", range: [180, 520] },
                        { context: "üöÄ A nave coletou {a} cristais no planeta azul e {b} no planeta vermelho. Quantos cristais? üíé", range: [400, 900] },
                        { context: "üé¨ O filme arrecadou R$ {a} na primeira semana e R$ {b} na segunda. Total arrecadado? üí∞", range: [350, 800] }
                    ]
                },

                // N√çVEL MESTRE - 3 blocos de 5 quest√µes cada
                bloco_7: {
                    name: "üîÆ Templo dos S√°bios",
                    emoji: "üîÆ",
                    description: "Desvendando mist√©rios ancestrais", 
                    color: "from-indigo-500 to-purple-600",
                    level: "Mestre",
                    questions: [
                        { context: "üèõÔ∏è O templo recebeu {a} visitantes de manh√£ e {b} √† tarde. Quantas pessoas visitaram? üë•", range: [800, 2000] },
                        { context: "üìú O s√°bio escreveu {a} pergaminhos na primeira semana e {b} na segunda. Quantos pergaminhos? ‚úçÔ∏è", range: [600, 1500] },
                        { context: "üíé A mina produziu {a} gemas preciosas de manh√£ e {b} √† tarde. Total de gemas? ‚õèÔ∏è", range: [1000, 2500] },
                        { context: "üåü O observat√≥rio detectou {a} estrelas no telesc√≥pio 1 e {b} no telesc√≥pio 2. Quantas estrelas? üî≠", range: [1200, 3000] },
                        { context: "üé≠ O teatro vendeu {a} ingressos online e {b} na bilheteria. Total de ingressos vendidos? üé´", range: [900, 2200] }
                    ]
                },
                bloco_8: {
                    name: "‚ö° Laborat√≥rio do Futuro",
                    emoji: "‚ö°",
                    description: "Experimentando com super n√∫meros",
                    color: "from-pink-500 to-rose-600",
                    level: "Mestre", 
                    questions: [
                        { context: "üß™ O cientista fez {a} experimentos na primeira fase e {b} na segunda. Quantos experimentos? üî¨", range: [1500, 4000] },
                        { context: "ü§ñ A f√°brica produziu {a} rob√¥s no turno da manh√£ e {b} no da tarde. Quantos rob√¥s? üè≠", range: [1800, 4500] },
                        { context: "üöÄ A esta√ß√£o espacial recebeu {a} suprimentos na c√°psula 1 e {b} na c√°psula 2. Total? üì¶", range: [2000, 5000] },
                        { context: "üíª O data center processou {a} dados de manh√£ e {b} √† tarde. Quantos dados processados? üìä", range: [2200, 5500] },
                        { context: "üéÆ O servidor do jogo registrou {a} logins de manh√£ e {b} √† tarde. Total de logins? üëæ", range: [1600, 4200] }
                    ]
                },
                bloco_9: {
                    name: "üëë Pal√°cio Imperial",
                    emoji: "üëë", 
                    description: "Reinando sobre n√∫meros majestosos",
                    color: "from-amber-400 to-yellow-600",
                    level: "Mestre",
                    questions: [
                        { context: "üè∞ O reino arrecadou {a} moedas de impostos e {b} de com√©rcio. Quantas moedas no tesouro? üí∞", range: [3000, 8000] },
                        { context: "üé™ O festival real teve {a} visitantes no primeiro dia e {b} no segundo. Quantos visitantes? üé≠", range: [2800, 7500] },
                        { context: "‚öîÔ∏è O ex√©rcito tem {a} soldados na infantaria e {b} na cavalaria. Quantos soldados? üõ°Ô∏è", range: [2500, 7000] },
                        { context: "üé® O pal√°cio tem {a} pinturas na ala leste e {b} na ala oeste. Quantas pinturas ao todo? üñºÔ∏è", range: [3200, 8500] },
                        { context: "üåü A cerim√¥nia real teve {a} convidados nobres e {b} convidados especiais. Total de convidados? üëë", range: [3500, 9000] }
                    ]
                },

                // N√çVEL LENDA - 3 blocos de 5 quest√µes cada  
                bloco_10: {
                    name: "üåå Gal√°xia Infinita",
                    emoji: "üåå",
                    description: "Explorando o cosmos matem√°tico",
                    color: "from-violet-600 to-indigo-800", 
                    level: "Lenda",
                    questions: [
                        { context: "üöÄ A frota espacial coletou {a} min√©rios no asteroide Alpha e {b} no asteroide Beta. Total de min√©rios? üåå", range: [15000, 40000] },
                        { context: "üåü O observat√≥rio gal√°ctico registrou {a} sinais no setor norte e {b} no setor sul. Quantos sinais? üì°", range: [18000, 45000] },
                        { context: "üëΩ A esta√ß√£o recebeu {a} visitantes da Terra e {b} de outros planetas. Quantos visitantes? üõ∏", range: [12000, 35000] },
                        { context: "üíé A minera√ß√£o espacial extraiu {a} cristais do cometa azul e {b} do cometa vermelho. Total? ‚õèÔ∏è", range: [20000, 50000] },
                        { context: "üåç A confedera√ß√£o tem {a} habitantes na Terra e {b} em Marte. Quantos habitantes no total? ü™ê", range: [25000, 60000] }
                    ]
                },
                bloco_11: {
                    name: "üî• Drag√£o dos N√∫meros",
                    emoji: "üî•",
                    description: "Domando a besta matem√°tica suprema", 
                    color: "from-red-600 to-orange-700",
                    level: "Lenda",
                    questions: [
                        { context: "üê≤ O drag√£o guardava {a} moedas de ouro na c√¢mara secreta e {b} na torre. Quantas moedas? üí∞", range: [30000, 75000] },
                        { context: "üè∞ O reino m√°gico tem {a} feiticeiros na academia e {b} em miss√µes. Quantos feiticeiros? ‚ö°", range: [28000, 70000] },
                        { context: "üó°Ô∏è O her√≥i derrotou {a} monstros na floresta sombria e {b} no vale perdido. Quantos monstros? ‚öîÔ∏è", range: [35000, 80000] },
                        { context: "üîÆ A profecia fala de {a} guerreiros da luz e {b} guerreiros das sombras. Total de guerreiros? üåü", range: [32000, 85000] },
                        { context: "üé≠ A lenda conta {a} hist√≥rias do passado e {b} do futuro. Quantas hist√≥rias na lenda? üìö", range: [40000, 90000] }
                    ]
                },
                bloco_12: {
                    name: "üéÜ Mestre Supremo", 
                    emoji: "üéÜ",
                    description: "O √°pice da maestria matem√°tica",
                    color: "from-gradient-to-r from-purple-900 via-blue-900 to-indigo-900",
                    level: "Lenda", 
                    questions: [
                        { context: "üåü O universo cont√©m {a} gal√°xias conhecidas e {b} gal√°xias descobertas recentemente. Total de gal√°xias? üåå", range: [50000, 99000] },
                        { context: "üèÜ O campeonato mundial registrou {a} espectadores online e {b} presenciais. Quantos espectadores? üéÆ", range: [45000, 95000] },
                        { context: "üíé A corpora√ß√£o intergal√°ctica faturou {a} cr√©ditos no primeiro trimestre e {b} no segundo. Total faturado? üí∞", range: [60000, 99000] },
                        { context: "üöÄ A miss√£o espacial coletou {a} amostras no planeta X e {b} no planeta Y. Quantas amostras? üß™", range: [55000, 99000] },
                        { context: "üéØ O mestre supremo acumulou {a} pontos de sabedoria e {b} pontos de experi√™ncia. Total de pontos? ‚≠ê", range: [70000, 99000] }
                    ]
                }
            };

            useEffect(() => {
                const savedFont = localStorage.getItem('selectedFont');
                if (savedFont === 'dyslexic') {
                    setFont('OpenDyslexic');
                }
                
                // Verificar se h√° sess√£o em andamento
                const savedSession = localStorage.getItem('calculadoraDigitalSession');
                if (savedSession) {
                    const session = JSON.parse(savedSession);
                    setStudentName(session.studentName);
                    setSessionResults(session.results || []);
                    setTotalScore(session.totalScore || 0);
                }
            }, []);

            const handleStart = (name) => {
                if (name.trim()) {
                    setStudentName(name);
                    setHasStarted(true);
                    setCurrentScreen('selection');
                    // Salvar in√≠cio de sess√£o
                    localStorage.setItem('calculadoraDigitalSession', JSON.stringify({
                        studentName: name,
                        results: [],
                        totalScore: 0,
                        startTime: new Date().toISOString()
                    }));
                }
            };

            const handleLevelSelect = (level) => {
                setCurrentLevel(level);
                setCurrentQuestion(0);
                setCurrentScreen('game');
                setStartTime(Date.now());

                const levels = getEffectiveLevels();
                const levelData = levels[level];
                const questionCount = levelData && levelData.questions ? levelData.questions.length : 10;

                // Generate randomized modes for all questions (balanced between montador/detector)
                const modes = [];
                for (let i = 0; i < questionCount; i++) {
                    modes.push(i % 2 === 0 ? 'montador' : 'detector');
                }

                // Shuffle to add randomness while maintaining balance
                const shuffledModes = modes.sort(() => Math.random() - 0.5);
                setQuestionModes(shuffledModes);
                setCurrentMode(shuffledModes[0]);

                generateQuestion(level, 0);
            };

            const generateQuestion = (level = currentLevel, questionIndex = currentQuestion) => {
                const levels = getEffectiveLevels();
                const levelData = levels[level];

                if (!levelData || !levelData.questions || levelData.questions.length === 0) {
                    console.error('No questions available for level:', level);
                    return;
                }

                // Get question from database-driven structure
                const questionData = levelData.questions[questionIndex % levelData.questions.length];

                if (!questionData) {
                    console.error('No question data at index:', questionIndex);
                    return;
                }

                // Use pre-generated database question or create from template
                let finalQuestionData;

                if (questionData.context && questionData.a !== undefined && questionData.b !== undefined) {
                    // Database-generated question
                    finalQuestionData = {
                        a: questionData.a,
                        b: questionData.b,
                        result: questionData.result,
                        context: questionData.context,
                        level,
                        questionIndex,
                        id: questionData.id,
                        mathematics: questionData.mathematics
                    };
                } else if (questionData.range) {
                    // Fallback template-based question
                    const [min, max] = questionData.range;
                    const a = Math.floor(Math.random() * (max - min)) + min;
                    const b = Math.floor(Math.random() * (max - min)) + min;

                    finalQuestionData = {
                        a,
                        b,
                        result: a + b,
                        context: questionData.context.replace('{a}', a.toLocaleString()).replace('{b}', b.toLocaleString()),
                        level,
                        questionIndex,
                        id: `template_${level}_${questionIndex}`,
                        mathematics: {
                            operation: 'adi√ß√£o',
                            operands: [a, b],
                            result: a + b
                        }
                    };
                } else {
                    console.error('Invalid question data format:', questionData);
                    return;
                }

                setCurrentQuestionData(finalQuestionData);

                // Reset estados do jogo
                setCalculatorDisplay('0');
                setCurrentExpression('');
                setUserAnswer(null);
                setAttempts(0);
                setShowFeedback(false);
            };

            const handleModeSelect = (mode) => {
                setCurrentMode(mode);
                generateQuestion();
            };

            // Fun√ß√µes da calculadora
            const inputNumber = (num) => {
                if (calculatorDisplay === '0') {
                    setCalculatorDisplay(num);
                } else {
                    setCalculatorDisplay(calculatorDisplay + num);
                }
            };

            const inputOperator = (op) => {
                if (currentExpression === '') {
                    setCurrentExpression(calculatorDisplay + ' ' + op + ' ');
                } else {
                    calculate();
                    setCurrentExpression(calculatorDisplay + ' ' + op + ' ');
                }
                setCalculatorDisplay('0');
            };

            const calculate = () => {
                if (currentExpression !== '') {
                    try {
                        const expression = currentExpression + calculatorDisplay;
                        const cleanExpression = expression.replace(/√ó/g, '*');
                        const result = eval(cleanExpression);
                        
                        setUserAnswer(Math.round(result));
                        setCalculatorDisplay(Math.round(result).toString());
                        setCurrentExpression('');
                        
                        checkAnswer(Math.round(result));
                    } catch (e) {
                        setCalculatorDisplay('Erro');
                    }
                }
            };

            const clearAll = () => {
                setCalculatorDisplay('0');
                setCurrentExpression('');
            };

            const checkAnswer = (answer = userAnswer) => {
                const isAnswerCorrect = answer === currentQuestionData.result;
                setAttempts(attempts + 1);
                setIsCorrect(isAnswerCorrect);

                if (isAnswerCorrect) {
                    setCorrectAnswers(correctAnswers + 1);
                    setCurrentStreak(currentStreak + 1);

                    // Update competency scores
                    updateCompetencyScore('calculation', true);
                    updateCompetencyScore('operation_identification', true);
                    updateCompetencyScore('problem_solving', true);
                    
                    const levelMultiplier = {avancado: 100, mestre: 200, expert: 300};
                    const attemptsBonus = attempts === 0 ? 2 : 1;
                    const newScore = totalScore + levelMultiplier[currentLevel] * attemptsBonus;
                    setTotalScore(newScore);

                    setFeedbackMessage('üéâ INCR√çVEL! Voc√™ √© um MESTRE da matem√°tica! ‚≠ê');
                    setShowFeedback(true);

                    // Salvar resultado
                    const levels = getEffectiveLevels();
                    const currentLevelData = levels[currentLevel];
                    const newResult = {
                        Nome: studentName,
                        Materia: 'Matematica',
                        Atividade: 'üßÆ Calculadora Digital Expert',
                        Bloco: currentLevelData ? currentLevelData.name : 'Bloco Desconhecido',
                        Questao: currentQuestionData?.id || `Questao_${currentQuestion + 1}`,
                        Tempo_Execucao: Math.round((Date.now() - startTime) / 1000) + 's',
                        Acertos: 1,
                        Erros: attempts,
                        Score: '100%',
                        // Multi-competency database fields
                        Competencia_Calculo: 100,
                        Competencia_Operacao: 100,
                        Competencia_Resolucao: 100,
                        Dificuldade: currentQuestionData?.metadata?.difficulty || 'medium',
                        Contexto: currentQuestionData?.metadata?.context || 'calculator',
                        Bloco_ID: currentQuestionData?.metadata?.blockId || 'unknown'
                    };

                    const updatedResults = [...sessionResults, newResult];
                    setSessionResults(updatedResults);

                    // Atualizar localStorage
                    localStorage.setItem('calculadoraDigitalSession', JSON.stringify({
                        studentName,
                        results: updatedResults,
                        totalScore: newScore
                    }));

                    setTimeout(() => nextQuestion(), 2500);
                } else {
                    // Update competency scores for incorrect answer
                    updateCompetencyScore('calculation', false);
                    updateCompetencyScore('operation_identification', false);
                    updateCompetencyScore('problem_solving', false);

                    if (attempts === 0) {
                        setFeedbackMessage('üéØ Quase l√°! Tente mais uma vez! üí™');
                        setShowFeedback(true);
                        setTimeout(() => {
                            setShowFeedback(false);
                            clearAll();
                        }, 2000);
                    } else {
                        setCurrentStreak(0);
                        setFeedbackMessage(`üìö Resposta correta: ${currentQuestionData.result.toLocaleString()}`);
                        setShowFeedback(true);

                        // Salvar resultado incorreto
                        const levels = getEffectiveLevels();
                        const currentLevelData = levels[currentLevel];
                        const newResult = {
                            Nome: studentName,
                            Materia: 'Matematica',
                            Atividade: 'üßÆ Calculadora Digital Expert',
                            Bloco: currentLevelData ? currentLevelData.name : 'Bloco Desconhecido',
                            Questao: currentQuestionData?.id || `Questao_${currentQuestion + 1}`,
                            Tempo_Execucao: Math.round((Date.now() - startTime) / 1000) + 's',
                            Acertos: 0,
                            Erros: 2,
                            Score: '0%',
                            // Multi-competency database fields
                            Competencia_Calculo: 0,
                            Competencia_Operacao: 0,
                            Competencia_Resolucao: 0,
                            Dificuldade: currentQuestionData?.metadata?.difficulty || 'medium',
                            Contexto: currentQuestionData?.metadata?.context || 'calculator',
                            Bloco_ID: currentQuestionData?.metadata?.blockId || 'unknown'
                        };

                        const updatedResults = [...sessionResults, newResult];
                        setSessionResults(updatedResults);

                        localStorage.setItem('calculadoraDigitalSession', JSON.stringify({
                            studentName,
                            results: updatedResults,
                            totalScore
                        }));

                        setTimeout(() => nextQuestion(), 4000);
                    }
                }
                setQuestionsAnswered(questionsAnswered + 1);
            };

            const checkDetectorAnswer = () => {
                const inputElement = document.getElementById('resultInput');
                const userAnswer = parseInt(inputElement.value);
                const correctAnswer = currentQuestionData.result;

                setAttempts(attempts + 1);

                if (userAnswer === correctAnswer) {
                    setCorrectAnswers(correctAnswers + 1);
                    setCurrentStreak(currentStreak + 1);

                    // Update competency scores
                    updateCompetencyScore('calculation', true);
                    updateCompetencyScore('operation_identification', true);
                    updateCompetencyScore('problem_solving', true);
                    
                    // Pontua√ß√£o baseada no n√≠vel atual
                    const levelMultipliers = {
                        'Iniciante': 100,
                        'Aventureiro': 200, 
                        'Mestre': 300,
                        'Lenda': 500
                    };
                    const currentLevelData = levels[currentLevel];
                    const baseMultiplier = levelMultipliers[currentLevelData.level] || 100;
                    const attemptsBonus = attempts === 0 ? 2 : 1;
                    const newScore = totalScore + baseMultiplier * attemptsBonus;
                    setTotalScore(newScore);

                    setFeedbackMessage('üöÄ FANT√ÅSTICO! Voc√™ √© mais r√°pido que uma m√°quina! ü§ñ‚ö°');
                    setIsCorrect(true);
                    setShowFeedback(true);

                    // Salvar resultado correto
                    const levels = getEffectiveLevels();
                    const currentLevelData = levels[currentLevel];
                    const newResult = {
                        Nome: studentName,
                        Materia: 'Matematica',
                        Atividade: 'üßÆ Calculadora Digital Expert',
                        Bloco: currentLevelData ? currentLevelData.name : 'Bloco Desconhecido',
                        Questao: currentQuestionData?.id || `Questao_${currentQuestion + 1}`,
                        Tempo_Execucao: Math.round((Date.now() - startTime) / 1000) + 's',
                        Acertos: 1,
                        Erros: attempts,
                        Score: '100%',
                        // Multi-competency database fields
                        Competencia_Calculo: 100,
                        Competencia_Operacao: 100,
                        Competencia_Resolucao: 100,
                        Dificuldade: currentQuestionData?.metadata?.difficulty || 'medium',
                        Contexto: currentQuestionData?.metadata?.context || 'calculator',
                        Bloco_ID: currentQuestionData?.metadata?.blockId || 'unknown'
                    };

                    const updatedResults = [...sessionResults, newResult];
                    setSessionResults(updatedResults);

                    localStorage.setItem('calculadoraDigitalSession', JSON.stringify({
                        studentName,
                        results: updatedResults,
                        totalScore: newScore
                    }));

                    setTimeout(() => nextQuestion(), 3500);
                } else {
                    // Update competency scores for incorrect answer
                    updateCompetencyScore('calculation', false);
                    updateCompetencyScore('operation_identification', false);
                    updateCompetencyScore('problem_solving', false);

                    if (attempts === 0) {
                        setFeedbackMessage('üéØ Quase l√°! Tente mais uma vez! üí™');
                        setIsCorrect(false);
                        setShowFeedback(true);
                        setTimeout(() => {
                            setShowFeedback(false);
                            document.getElementById('resultInput').value = '';
                            document.getElementById('resultInput').focus();
                        }, 2000);
                    } else {
                        setCurrentStreak(0);
                        setFeedbackMessage(`üìö A resposta era: ${correctAnswer.toLocaleString()}`);
                        setIsCorrect(false);
                        setShowFeedback(true);

                        // Salvar resultado incorreto
                        const levels = getEffectiveLevels();
                        const currentLevelData = levels[currentLevel];
                        const newResult = {
                            Nome: studentName,
                            Materia: 'Matematica',
                            Atividade: 'üßÆ Calculadora Digital Expert',
                            Bloco: currentLevelData ? currentLevelData.name : 'Bloco Desconhecido',
                            Questao: currentQuestionData?.id || `Questao_${currentQuestion + 1}`,
                            Tempo_Execucao: Math.round((Date.now() - startTime) / 1000) + 's',
                            Acertos: 0,
                            Erros: 2,
                            Score: '0%',
                            // Multi-competency database fields
                            Competencia_Calculo: 0,
                            Competencia_Operacao: 0,
                            Competencia_Resolucao: 0,
                            Dificuldade: currentQuestionData?.metadata?.difficulty || 'medium',
                            Contexto: currentQuestionData?.metadata?.context || 'calculator',
                            Bloco_ID: currentQuestionData?.metadata?.blockId || 'unknown'
                        };

                        const updatedResults = [...sessionResults, newResult];
                        setSessionResults(updatedResults);

                        localStorage.setItem('calculadoraDigitalSession', JSON.stringify({
                            studentName,
                            results: updatedResults,
                            totalScore
                        }));

                        setTimeout(() => nextQuestion(), 4000);
                    }
                }
                setQuestionsAnswered(questionsAnswered + 1);
            };

            const nextQuestion = () => {
                setShowFeedback(false);

                const levels = getEffectiveLevels();
                const levelData = levels[currentLevel];
                const questionCount = levelData && levelData.questions ? levelData.questions.length : 10;

                if (currentQuestion >= questionCount - 1) {
                    setCurrentScreen('result');
                    return;
                }

                const newQuestionIndex = currentQuestion + 1;
                setCurrentQuestion(newQuestionIndex);
                setCurrentMode(questionModes[newQuestionIndex] || 'montador'); // Usar modo pr√©-definido
                setStartTime(Date.now());
                generateQuestion(currentLevel, newQuestionIndex);
            };

            const finishSession = () => {
                // Generate competency summary
                const competencySummary = Object.entries(competencyScores).map(([comp, scores]) => ({
                    competencia: comp,
                    acertos: scores.correct,
                    total: scores.total,
                    percentual: scores.total > 0 ? Math.round((scores.correct / scores.total) * 100) : 0
                }));

                // Generate CSV with multi-competency support
                const header = 'Nome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score,Competencia_Calculo,Competencia_Operacao,Competencia_Resolucao,Dificuldade,Contexto,Bloco_ID\n';
                const csvContent = sessionResults.map(r =>
                    `${r.Nome},${r.Materia},"${r.Atividade}","${r.Bloco}",${r.Questao},${r.Tempo_Execucao},${r.Acertos},${r.Erros},${r.Score},${r.Competencia_Calculo || 0},${r.Competencia_Operacao || 0},${r.Competencia_Resolucao || 0},${r.Dificuldade || 'medium'},${r.Contexto || 'calculator'},${r.Bloco_ID || 'unknown'}`
                ).join('\n');

                // Add competency summary at the end
                const summaryHeader = '\n\n# RESUMO DE COMPETENCIAS\nCompetencia,Acertos,Total,Percentual\n';
                const summaryCsv = competencySummary.map(s =>
                    `${s.competencia},${s.acertos},${s.total},${s.percentual}%`
                ).join('\n');

                const fullContent = header + csvContent + summaryHeader + summaryCsv;
                
                const blob = new Blob([fullContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                
                const now = new Date();
                const dateStr = now.toLocaleDateString('pt-BR').replace(/\\//g, '-');
                const studentNameForFile = studentName.replace(/[^a-zA-Z0-9]/g, '_');
                link.download = `calculadora_digital_${studentNameForFile}_${dateStr}.csv`;
                
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // Mostrar mensagem de sucesso
                alert(`üéâ Dados exportados com sucesso!\\n\\nüìä Total de atividades: ${sessionResults.length}\\nüíæ Arquivo: calculadora_digital_${studentNameForFile}_${dateStr}.csv`);

                // Limpar sess√£o
                localStorage.removeItem('calculadoraDigitalSession');
                
                // Reset total
                setHasStarted(false);
                setCurrentScreen('start');
                setSessionResults([]);
                setTotalScore(0);
                setCurrentStreak(0);
                setCorrectAnswers(0);
                setQuestionsAnswered(0);
            };

            const restartLevel = () => {
                setCurrentQuestion(0);
                setCurrentScreen('game');
                generateQuestion();
            };

            // Tela inicial
            if (!hasStarted) {
                return (
                    <div className={`min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full transform transition-all duration-500 hover:scale-105">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üßÆ</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Calculadora Digital Expert</h1>
                                <p className="text-gray-600">üöÄ Domine a matem√°tica com desafios √©picos! üéØ</p>
                            </div>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-lg font-bold text-gray-700 mb-2">
                                        üë§ Qual √© o seu nome?
                                    </label>
                                    <input
                                        type="text"
                                        className="w-full px-4 py-3 border-2 border-purple-300 rounded-xl text-lg text-center focus:outline-none focus:border-purple-500 transition-colors duration-300"
                                        placeholder="Digite seu nome aqui"
                                        value={studentName}
                                        onChange={(e) => setStudentName(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleStart(studentName)}
                                    />
                                </div>
                                
                                <div className="flex items-center justify-between">
                                    <span className="text-sm font-medium text-gray-700">üî§ Fonte para dislexia:</span>
                                    <button
                                        onClick={() => {
                                            const newFont = font === 'Comic Sans MS' ? 'OpenDyslexic' : 'Comic Sans MS';
                                            setFont(newFont);
                                            localStorage.setItem('selectedFont', newFont === 'OpenDyslexic' ? 'dyslexic' : 'normal');
                                        }}
                                        className={`px-4 py-2 rounded-lg font-medium transition-all duration-300 ${
                                            font === 'OpenDyslexic' 
                                                ? 'bg-green-500 text-white' 
                                                : 'bg-gray-200 text-gray-700'
                                        }`}
                                    >
                                        {font === 'OpenDyslexic' ? '‚úÖ Ativada' : '‚ö™ Desativada'}
                                    </button>
                                </div>

                                <button
                                    onClick={() => handleStart(studentName)}
                                    className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-xl text-lg transition-all duration-300 hover:from-purple-600 hover:to-pink-600 hover:shadow-lg transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled={!studentName.trim()}
                                >
                                    üéØ COME√áAR AVENTURA! üöÄ
                                </button>

                                <button
                                    onClick={() => window.location.href = '../index.html'}
                                    className="w-full bg-gray-300 text-gray-700 font-bold py-3 rounded-xl transition-all duration-300 hover:bg-gray-400 hover:shadow-lg"
                                >
                                    üè† Voltar ao Portal
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Loading screen during database initialization
            if (isLoading) {
                return (
                    <div className={`min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                            <div className="text-6xl mb-4">üßÆ</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Carregando Calculadora Digital...</h2>
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
                            <p className="text-gray-600">Preparando quest√µes do banco de dados...</p>
                        </div>
                    </div>
                );
            }

            // Error screen
            if (loadError) {
                return (
                    <div className={`min-h-screen bg-gradient-to-br from-red-400 via-pink-500 to-purple-500 flex items-center justify-center p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                            <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Erro de Carregamento</h2>
                            <p className="text-gray-600 mb-6">{loadError}</p>
                            <button
                                onClick={() => window.location.reload()}
                                className="bg-red-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-red-600 transition-colors duration-300"
                            >
                                üîÑ Tentar Novamente
                            </button>
                        </div>
                    </div>
                );
            }

            // Tela de sele√ß√£o de blocos
            if (currentScreen === 'selection') {
                const levels = getEffectiveLevels();

                // Agrupar blocos por n√≠vel usando database blocks ou fallback
                const groupedLevels = {};
                Object.entries(levels).forEach(([key, level]) => {
                    if (!groupedLevels[level.level]) {
                        groupedLevels[level.level] = [];
                    }
                    groupedLevels[level.level].push({ key, ...level });
                });

                return (
                    <div className={`min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                        <div className="max-w-7xl mx-auto">
                            <div className="text-center mb-8">
                                <h1 className="text-5xl font-bold text-white mb-2">üöÄ Ol√°, {studentName}! üöÄ</h1>
                                <p className="text-2xl text-white opacity-90">Escolha seu bloco de aventura matem√°tica!</p>
                            </div>

                            <div className="bg-white rounded-3xl shadow-2xl p-8 mb-6">
                                <h2 className="text-3xl font-bold text-center mb-6 text-gray-800">üìñ Como Funciona</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                                    <div className="bg-blue-50 p-6 rounded-xl">
                                        <div className="text-4xl mb-3">üßÆ</div>
                                        <h3 className="font-bold text-lg mb-2">Calculadora Real</h3>
                                        <p className="text-gray-700">Use os bot√µes da calculadora para resolver!</p>
                                    </div>
                                    <div className="bg-purple-50 p-6 rounded-xl">
                                        <div className="text-4xl mb-3">üîç</div>
                                        <h3 className="font-bold text-lg mb-2">Calculadora Quebrada</h3>
                                        <p className="text-gray-700">Resolva mentalmente e digite o resultado!</p>
                                    </div>
                                    <div className="bg-green-50 p-6 rounded-xl">
                                        <div className="text-4xl mb-3">üé≤</div>
                                        <h3 className="font-bold text-lg mb-2">Modos Aleat√≥rios</h3>
                                        <p className="text-gray-700">Cada quest√£o usa um modo diferente!</p>
                                    </div>
                                    <div className="bg-pink-50 p-6 rounded-xl">
                                        <div className="text-4xl mb-3">üèÜ</div>
                                        <h3 className="font-bold text-lg mb-2">Progress√£o √âpica</h3>
                                        <p className="text-gray-700">5 quest√µes para dominar cada bloco!</p>
                                    </div>
                                </div>
                            </div>

                            <div className="border-t border-white/30 my-6"></div>

                            {/* Blocos organizados por n√≠vel */}
                            {Object.entries(groupedLevels).map(([levelName, blocksInLevel]) => (
                                <div key={levelName} className="mb-12">
                                    <h2 className="text-4xl font-bold text-center text-white mb-8">
                                        {levelName === 'Iniciante' && 'üåü'} 
                                        {levelName === 'Aventureiro' && '‚ö°'} 
                                        {levelName === 'Mestre' && 'üîÆ'} 
                                        {levelName === 'Lenda' && 'üåå'} 
                                        {' ' + levelName}
                                    </h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                        {blocksInLevel.map((block) => {
                                            // Calculate range from database questions or fallback to static values
                                            let minRange = 50, maxRange = 500;

                                            if (block.questions && Array.isArray(block.questions)) {
                                                if (block.questions.length > 0 && block.questions[0].range) {
                                                    // Template-based questions with ranges
                                                    minRange = Math.min(...block.questions.map(q => q.range[0]));
                                                    maxRange = Math.max(...block.questions.map(q => q.range[1]));
                                                } else if (block.questions.length > 0 && block.questions[0].a !== undefined) {
                                                    // Database-generated questions with actual values
                                                    const numbers = [];
                                                    block.questions.forEach(q => {
                                                        if (q.a !== undefined) numbers.push(q.a);
                                                        if (q.b !== undefined) numbers.push(q.b);
                                                    });
                                                    if (numbers.length > 0) {
                                                        minRange = Math.min(...numbers);
                                                        maxRange = Math.max(...numbers);
                                                    }
                                                }
                                            }

                                            const questionCount = block.questions ? block.questions.length : 10;

                                            return (
                                                <div 
                                                    key={block.key}
                                                    className="bg-white rounded-3xl shadow-xl p-6 transform transition-all duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer group"
                                                    onClick={() => handleLevelSelect(block.key)}
                                                >
                                                    <div className="text-center">
                                                        <div className="text-7xl mb-4 group-hover:scale-110 transition-transform duration-300">{block.emoji}</div>
                                                        <h3 className={`text-2xl font-bold mb-2 bg-gradient-to-r ${block.color} bg-clip-text text-transparent`}>
                                                            {block.name}
                                                        </h3>
                                                        <p className="text-gray-600 mb-4 text-lg">{block.description}</p>
                                                        <div className="bg-gray-100 rounded-xl p-4 mb-4">
                                                            <p className="text-sm font-medium text-gray-700">üìä N√∫meros: {minRange.toLocaleString()} - {maxRange.toLocaleString()}</p>
                                                            <p className="text-sm text-gray-600">‚è±Ô∏è {questionCount} quest√µes ‚Ä¢ üé≤ Modos aleat√≥rios</p>
                                                            <p className="text-sm text-purple-600 font-bold">üßÆ + üîç Calculadora Real + Detectora</p>
                                                            {databaseBlocks.length > 0 && (
                                                                <p className="text-xs text-green-600 font-medium mt-1">üóÑÔ∏è Quest√µes do banco de dados</p>
                                                            )}
                                                        </div>
                                                        <button className={`w-full bg-gradient-to-r ${block.color} text-white font-bold py-4 rounded-xl text-lg transition-all duration-300 hover:shadow-lg group-hover:scale-105`}>
                                                            üöÄ COME√áAR AVENTURA
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}

                            <div className="text-center bg-white/10 backdrop-blur-sm rounded-3xl p-6">
                                <h3 className="text-2xl font-bold text-white mb-4">üéÆ Total: 6 Blocos √âpicos!</h3>
                                <p className="text-white/80 text-lg mb-6">
                                    {databaseBlocks.length > 0
                                        ? `Quest√µes do banco de dados - ${databaseBlocks.reduce((total, block) => total + block.questions.length, 0)} quest√µes matem√°ticas!`
                                        : 'Do iniciante ao lenda - 60 quest√µes de pura aventura matem√°tica!'
                                    }
                                </p>
                                {databaseBlocks.length > 0 && (
                                    <div className="text-sm text-green-200 mb-4">
                                        ‚úÖ Conectado ao banco de dados ‚Ä¢ üßÆ Compet√™ncia: Simula√ß√£o de Calculadora
                                    </div>
                                )}
                                <button
                                    onClick={finishSession}
                                    className="bg-green-500 text-white font-bold py-4 px-8 rounded-xl text-lg transition-all duration-300 hover:bg-green-600 hover:shadow-lg mr-4"
                                >
                                    üíæ Finalizar Sess√£o & Baixar Resultados
                                </button>
                                <button
                                    onClick={() => window.location.href = '../index.html'}
                                    className="bg-gray-500 text-white font-bold py-4 px-8 rounded-xl text-lg transition-all duration-300 hover:bg-gray-600 hover:shadow-lg"
                                >
                                    üè† Voltar ao Portal
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Interface de jogo
            if (currentScreen === 'game') {
                const levelData = levels[currentLevel];
                
                return (
                    <div className={`min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                        <div className="max-w-7xl mx-auto">
                            {/* Header */}
                            <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h1 className="text-2xl font-bold text-gray-800">üëã {studentName} - {levelData.name}</h1>
                                    <button
                                        onClick={() => setCurrentScreen('selection')}
                                        className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-300"
                                    >
                                        ‚¨ÖÔ∏è Voltar
                                    </button>
                                </div>
                                
                                {/* Progresso */}
                                {(() => {
                                    const levels = getEffectiveLevels();
                                    const currentLevelData = levels[currentLevel];
                                    const questionCount = currentLevelData && currentLevelData.questions ? currentLevelData.questions.length : 10;

                                    return (
                                        <>
                                            <div className="flex justify-center gap-2 mb-4 flex-wrap">
                                                {[...Array(questionCount)].map((_, i) => (
                                                    <div
                                                        key={i}
                                                        className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300 ${
                                                            i < currentQuestion ? 'bg-green-500 text-white' :
                                                            i === currentQuestion ? 'bg-blue-500 text-white transform scale-110' :
                                                            'bg-gray-300 text-gray-600'
                                                        }`}
                                                    >
                                                        {i + 1}
                                                    </div>
                                                ))}
                                            </div>

                                            <div className="text-center font-bold text-gray-700">
                                                üìä Quest√£o {currentQuestion + 1} de {questionCount}
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>

                            {/* Estat√≠sticas */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-white rounded-xl p-4 text-center shadow-lg">
                                    <div className="text-2xl font-bold text-purple-600">{totalScore.toLocaleString()}</div>
                                    <div className="text-sm text-gray-600">üèÜ Pontos</div>
                                </div>
                                <div className="bg-white rounded-xl p-4 text-center shadow-lg">
                                    <div className="text-2xl font-bold text-orange-600">{currentStreak}</div>
                                    <div className="text-sm text-gray-600">üî• Sequ√™ncia</div>
                                </div>
                                <div className="bg-white rounded-xl p-4 text-center shadow-lg">
                                    <div className="text-2xl font-bold text-green-600">
                                        {currentQuestion}/{(() => {
                                            const levels = getEffectiveLevels();
                                            const currentLevelData = levels[currentLevel];
                                            return currentLevelData && currentLevelData.questions ? currentLevelData.questions.length : 10;
                                        })()}
                                    </div>
                                    <div className="text-sm text-gray-600">üìà Progresso</div>
                                </div>
                                <div className="bg-white rounded-xl p-4 text-center shadow-lg">
                                    <div className="text-2xl font-bold text-blue-600">
                                        {questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 100}%
                                    </div>
                                    <div className="text-sm text-gray-600">üéØ Precis√£o</div>
                                </div>
                            </div>

                            {/* Indicador de modo atual (n√£o permite mudan√ßa) */}
                            <div className="flex justify-center mb-6">
                                <div className={`px-8 py-4 rounded-2xl font-bold text-xl shadow-xl ${
                                    currentMode === 'montador' 
                                        ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white' 
                                        : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'
                                }`}>
                                    {currentMode === 'montador' ? 'üßÆ CALCULADORA REAL' : 'üîç CALCULADORA DETECTORA'}
                                    <div className="text-sm opacity-80 mt-1">
                                        {currentMode === 'montador' ? 'Use os bot√µes da calculadora!' : 'Resolva mentalmente!'}
                                    </div>
                                </div>
                            </div>

                            {currentQuestionData && (
                                <>
                                    {/* Contexto da quest√£o */}
                                    <div className="bg-gradient-to-r from-yellow-100 to-yellow-200 border-4 border-yellow-300 rounded-2xl p-6 mb-6 text-center">
                                        <div className="text-xl font-bold text-gray-800">
                                            {currentQuestionData.context}
                                        </div>
                                    </div>

                                    {/* Interface do jogo */}
                                    {currentMode === 'montador' ? (
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                            {/* Calculadora */}
                                            <div className="bg-gray-800 rounded-2xl p-6 shadow-2xl">
                                                <div className="text-center text-white text-xl font-bold mb-4">
                                                    üßÆ USE A CALCULADORA
                                                </div>
                                                <div className="bg-blue-500 text-white p-4 rounded-xl text-right text-3xl font-bold mb-4 min-h-20 flex items-center justify-end font-mono border-4 border-blue-600">
                                                    {currentExpression !== '' ? currentExpression + calculatorDisplay : calculatorDisplay}
                                                </div>
                                                <div className="grid grid-cols-4 gap-3">
                                                    <button onClick={clearAll} className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">C</button>
                                                    <button onClick={clearAll} className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">CE</button>
                                                    <button onClick={() => inputOperator('/')} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">/</button>
                                                    <button onClick={() => inputOperator('*')} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">√ó</button>
                                                    
                                                    <button onClick={() => inputNumber('7')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">7</button>
                                                    <button onClick={() => inputNumber('8')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">8</button>
                                                    <button onClick={() => inputNumber('9')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">9</button>
                                                    <button onClick={() => inputOperator('-')} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">-</button>
                                                    
                                                    <button onClick={() => inputNumber('4')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">4</button>
                                                    <button onClick={() => inputNumber('5')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">5</button>
                                                    <button onClick={() => inputNumber('6')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">6</button>
                                                    <button onClick={() => inputOperator('+')} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">+</button>
                                                    
                                                    <button onClick={() => inputNumber('1')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">1</button>
                                                    <button onClick={() => inputNumber('2')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">2</button>
                                                    <button onClick={() => inputNumber('3')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">3</button>
                                                    <button onClick={calculate} className="bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105 row-span-2">=</button>
                                                    
                                                    <button onClick={() => inputNumber('0')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105 col-span-2">0</button>
                                                    <button onClick={() => inputNumber('.')} className="bg-gray-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all duration-200 hover:scale-105">.</button>
                                                </div>
                                            </div>

                                            {/* √Årea de resposta */}
                                            <div className="bg-white rounded-2xl p-6 shadow-2xl">
                                                <div className="text-2xl font-bold text-center mb-6 text-gray-800">
                                                    {userAnswer === currentQuestionData.result ? 'üéØ RESULTADO CORRETO' : 'ü§î CALCULE O RESULTADO'}
                                                </div>
                                                <div className={`border-4 rounded-2xl p-6 text-center text-4xl font-bold mb-6 shadow-lg ${
                                                    userAnswer === currentQuestionData.result 
                                                        ? 'border-green-500 bg-green-50 text-green-600' 
                                                        : 'border-gray-300 bg-gray-50 text-gray-400'
                                                }`}>
                                                    {userAnswer === currentQuestionData.result 
                                                        ? currentQuestionData.result.toLocaleString()
                                                        : '? ? ?'}
                                                </div>
                                                
                                                <div className="text-xl font-bold text-center mb-4 text-gray-800">ü§î SUA RESPOSTA</div>
                                                <div className={`border-4 rounded-2xl p-4 text-center text-3xl font-bold mb-4 min-h-20 flex items-center justify-center ${
                                                    userAnswer === null ? 'border-gray-300 bg-gray-50 text-gray-500' :
                                                    userAnswer === currentQuestionData.result ? 'border-green-500 bg-green-50 text-green-600' :
                                                    'border-red-500 bg-red-50 text-red-600'
                                                }`}>
                                                    {userAnswer === null ? 'Calcule usando a calculadora' : userAnswer.toLocaleString()}
                                                </div>
                                                
                                                <div className={`text-center p-6 rounded-2xl font-bold text-xl shadow-lg transition-all duration-300 ${
                                                    userAnswer === null ? 'bg-blue-100 text-blue-700 border-2 border-blue-300' :
                                                    userAnswer === currentQuestionData.result ? 'bg-gradient-to-r from-green-400 to-emerald-500 text-white border-2 border-green-400 animate-pulse' :
                                                    'bg-gradient-to-r from-red-400 to-rose-500 text-white border-2 border-red-400'
                                                }`}>
                                                    {userAnswer === null ? (
                                                        <div>
                                                            <div className="text-3xl mb-2">‚è≥</div>
                                                            <div>Aguardando c√°lculo...</div>
                                                        </div>
                                                    ) : userAnswer === currentQuestionData.result ? (
                                                        <div className="transform scale-105">
                                                            <div className="text-5xl mb-3 animate-bounce">üéâ</div>
                                                            <div className="text-2xl font-black mb-2">FANT√ÅSTICO!</div>
                                                            <div className="text-lg">Voc√™ √© um g√™nio da matem√°tica!</div>
                                                            <div className="text-sm opacity-90 mt-1">‚ú® Resposta correta descoberta! ‚ú®</div>
                                                        </div>
                                                    ) : attempts === 1 ? (
                                                        <div>
                                                            <div className="text-4xl mb-2">üí™</div>
                                                            <div className="text-xl">Quase l√°!</div>
                                                            <div className="text-base">Tente mais uma vez - voc√™ consegue!</div>
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            <div className="text-4xl mb-2">üéØ</div>
                                                            <div className="text-xl mb-1">A resposta era:</div>
                                                            <div className="text-3xl font-black">{currentQuestionData.result.toLocaleString()}</div>
                                                            <div className="text-sm opacity-90 mt-1">Continue tentando - voc√™ est√° aprendendo! üìö</div>
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <div className="text-center text-gray-600 mt-4">
                                                    Tentativa {attempts + 1} de 2
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        // Modo detector
                                        <div className="max-w-2xl mx-auto">
                                            <div className="bg-gray-800 rounded-2xl p-8 relative">
                                                <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-2 rounded-full font-bold text-lg">
                                                    ‚ö†Ô∏è CALCULADORA COM DEFEITO! ‚ö†Ô∏è
                                                </div>
                                                <div className="bg-blue-500 text-white p-6 rounded-xl font-mono text-2xl text-right mt-4 mb-6">
                                                    <div>{currentQuestionData.a.toLocaleString()}</div>
                                                    <div>+ {currentQuestionData.b.toLocaleString()}</div>
                                                    <div>___________</div>
                                                    <div>= ???????</div>
                                                </div>
                                            </div>

                                            <div className="text-center text-2xl text-white font-bold my-6">
                                                ü§ñ SISTEMA BUGADO! CALCULE MANUALMENTE! üîß
                                            </div>

                                            <div className="flex justify-center items-center gap-6">
                                                <input
                                                    type="number"
                                                    id="resultInput"
                                                    className="w-32 h-16 text-3xl text-center border-4 border-blue-500 rounded-2xl font-bold bg-white"
                                                    placeholder="?"
                                                    maxLength="8"
                                                    onKeyPress={(e) => e.key === 'Enter' && checkDetectorAnswer()}
                                                />
                                                <button
                                                    onClick={checkDetectorAnswer}
                                                    className="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-2xl text-xl transition-all duration-300 hover:scale-105"
                                                >
                                                    ‚úÖ VERIFICAR RESPOSTA
                                                </button>
                                            </div>

                                            <div className="text-center text-white text-lg mt-4">
                                                Tentativa {attempts + 1} de 2
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}

                            {/* Feedback Melhorado */}
                            {showFeedback && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
                                    <div className={`p-12 rounded-3xl text-center max-w-lg mx-4 shadow-2xl transform transition-all duration-500 ${
                                        isCorrect 
                                            ? 'bg-gradient-to-br from-green-400 to-emerald-600 text-white animate-pulse' 
                                            : 'bg-gradient-to-br from-red-400 to-rose-600 text-white'
                                    }`}>
                                        <div className={`text-9xl mb-6 ${isCorrect ? 'animate-bounce' : ''}`}>
                                            {isCorrect ? 'üéâ' : 'üí™'}
                                        </div>
                                        <div className="text-4xl font-black mb-4">
                                            {isCorrect ? 'SENSACIONAL!' : 'CONTINUE TENTANDO!'}
                                        </div>
                                        <div className="text-2xl font-bold mb-4">
                                            {feedbackMessage}
                                        </div>
                                        {isCorrect && (
                                            <div className="mt-6">
                                                <div className="text-xl opacity-90 mb-2">‚ú® Voc√™ √© INCR√çVEL! ‚ú®</div>
                                                <div className="text-lg opacity-80">üöÄ Preparando pr√≥xima aventura... üöÄ</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Tela de resultado
            if (currentScreen === 'result') {
                const levels = getEffectiveLevels();
                const levelData = levels[currentLevel];
                const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;
                
                return (
                    <div className={`min-h-screen bg-gradient-to-br from-green-400 via-blue-500 to-purple-600 flex items-center justify-center p-4 ${font === 'OpenDyslexic' ? 'font-dyslexic' : ''}`}>
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full text-center">
                            <div className="text-8xl mb-6">{levelData.emoji}</div>
                            <h2 className="text-4xl font-bold mb-4 text-gray-800">üéä N√çVEL CONCLU√çDO! üéä</h2>
                            <p className="text-2xl mb-8 text-gray-700">
                                Voc√™ dominou o n√≠vel <strong>{levelData.name}</strong>!
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div className="bg-purple-50 rounded-2xl p-6">
                                    <div className="text-4xl font-bold text-purple-600">{totalScore.toLocaleString()}</div>
                                    <div className="text-lg text-gray-700">üèÜ Pontua√ß√£o Final</div>
                                </div>
                                <div className="bg-orange-50 rounded-2xl p-6">
                                    <div className="text-4xl font-bold text-orange-600">{currentStreak}</div>
                                    <div className="text-lg text-gray-700">üî• Maior Sequ√™ncia</div>
                                </div>
                                <div className="bg-green-50 rounded-2xl p-6">
                                    <div className="text-4xl font-bold text-green-600">{accuracy}%</div>
                                    <div className="text-lg text-gray-700">üéØ Precis√£o</div>
                                </div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-4 justify-center">
                                <button
                                    onClick={restartLevel}
                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-2xl text-xl transition-all duration-300 hover:scale-105"
                                >
                                    üîÑ JOGAR NOVAMENTE
                                </button>
                                <button
                                    onClick={() => setCurrentScreen('selection')}
                                    className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-8 rounded-2xl text-xl transition-all duration-300 hover:scale-105"
                                >
                                    üéØ ESCOLHER N√çVEL
                                </button>
                                <button
                                    onClick={finishSession}
                                    className="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-2xl text-xl transition-all duration-300 hover:scale-105"
                                >
                                    üíæ FINALIZAR & BAIXAR
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        ReactDOM.render(<CalculadoraDigitalIntegrada />, document.getElementById('root'));
    </script>
</body>
</html>