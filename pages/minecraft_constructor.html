<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtor Minecraft</title>
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif;
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div class="spinner"></div>
            Carregando Atividade...
        </div>
    </div>

    <!-- Database Integration Scripts -->
    <script src="../src/data/questionDatabase.js"></script>
    <script src="../src/config/activityMapping.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const MinecraftConstructor = () => {
            const [studentName, setStudentName] = useState('');
            const [selectedFont, setSelectedFont] = useState(localStorage.getItem('selectedFont') || 'comic');
            const [currentPhase, setCurrentPhase] = useState('inicio');
            const [currentBlock, setCurrentBlock] = useState(0);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [sessionResults, setSessionResults] = useState([]);
            const [startTime, setStartTime] = useState(null);
            const [grid, setGrid] = useState([]);
            const [availableBlocks, setAvailableBlocks] = useState([]);
            const [currentSum, setCurrentSum] = useState(0);
            const [budget, setBudget] = useState(null);
            const [targetStructure, setTargetStructure] = useState('');
            const [isComplete, setIsComplete] = useState(false);
            const [feedback, setFeedback] = useState('');
            const [score, setScore] = useState(0);

            // Database integration state
            const [databaseQuestions, setDatabaseQuestions] = useState([]);
            const [currentQuestionData, setCurrentQuestionData] = useState(null);
            const [competencyScores, setCompetencyScores] = useState({
                calculation: { correct: 0, total: 0 },
                problem_solving: { correct: 0, total: 0 }
            });
            const [loading, setLoading] = useState(true);
            const [activityConfig, setActivityConfig] = useState(null);
            const [blockData, setBlockData] = useState([]);

            const initializeDatabase = async () => {
                try {
                    setLoading(true);
                    const config = window.ActivityMapping?.getActivityConfig('minecraft_constructor');
                    if (!config) {
                        console.error('Activity configuration not found for minecraft_constructor');
                        setLoading(false);
                        return;
                    }
                    setActivityConfig(config);

                    // Carregar todas as questões e configurações de bloco
                    const loadedBlockData = config.questionBlocks.map(blockInfo => {
                        const blockDetails = window.BLOCK_QUESTION_MAPPING[blockInfo.blockId];
                        if (!blockDetails) {
                            console.error(`Block details not found for ${blockInfo.blockId}`);
                            return null;
                        }
                        
                        const questionId = blockDetails.questions[0]; // Apenas uma questão por bloco
                        const question = window.questionDB.getQuestionForCompetency(questionId, 'problem_solving');

                        if (!question) {
                             console.error(`Question with ID ${questionId} not found in database.`);
                             return null;
                        }

                        return {
                            ...blockInfo,
                            ...blockDetails,
                            question: question,
                            name: `Minecraft - ${blockInfo.blockId.replace('minecraft_', 'Bloco ')}`
                        };
                    }).filter(Boolean);
                    
                    setBlockData(loadedBlockData);

                } catch (error) {
                    console.error('Error initializing database:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            useEffect(() => {
                // Simula o carregamento do banco de dados exportado
                // Em um cenário real, isso viria de um fetch
                const exportedDb = window.exportedDatabase;
                if (exportedDb) {
                    window.questionDB.importDatabase(exportedDb);
                }
                initializeDatabase();
            }, []);


            const getFontStyle = () => ({
                fontFamily: selectedFont === 'dyslexic' ? "'OpenDyslexic', sans-serif" : "'Comic Sans MS', cursive"
            });

            const initializeGrid = (rows, cols) => Array(rows).fill().map(() => Array(cols).fill(null));

            const calculateSum = (gridToCalculate) => {
                let sum = 0;
                gridToCalculate.forEach(row => row.forEach(cell => { if (cell) sum += cell.value; }));
                return sum;
            };

            const startQuestion = () => {
                if (currentBlock === null || !blockData.length || !blockData[currentBlock]) return;

                const currentBlockInfo = blockData[currentBlock];
                const questionData = currentBlockInfo.question;
                
                if (!questionData || !questionData.metadata || !questionData.metadata.gridSize) {
                    console.error("Dados da questão ou gridSize faltando", questionData);
                    return;
                };

                const { rows, cols } = questionData.metadata.gridSize;

                setCurrentQuestionData(questionData);
                setGrid(initializeGrid(rows, cols));
                setAvailableBlocks(questionData.metadata.blockTypes || []);
                setCurrentSum(0);
                setBudget(questionData.metadata.budget || null);
                setTargetStructure(questionData.metadata.structure || `Desafio ${currentBlock + 1}`);
                setIsComplete(false);
                setFeedback('');
                setStartTime(Date.now());
            };

            useEffect(() => {
                startQuestion();
            }, [currentBlock, blockData]);

            useEffect(() => {
                if (currentBlock === null || !grid.length || !currentQuestionData) return;

                const sum = calculateSum(grid);
                setCurrentSum(sum);

                const target = currentQuestionData.mathematics.result;
                let success = sum === target;
                let newFeedback = "";

                if (budget && sum > budget) {
                    success = false;
                    newFeedback = `Orçamento estourado! Limite: ${budget}, Usado: ${sum}`;
                } else if (sum !== target) {
                    if (sum > 0) newFeedback = `Soma atual: ${sum} | Necessário: ${target}`;
                    success = false;
                } else {
                    newFeedback = "Parabéns! Estrutura construída com sucesso!";
                }

                if (success && !isComplete) {
                    setIsComplete(true);
                    setScore(prev => prev + 1);
                    updateCompetencyScores(currentQuestionData, true);
                } else if (!success && isComplete) {
                    setIsComplete(false);
                }

                setFeedback(newFeedback);
            }, [grid, currentBlock, budget, isComplete, currentQuestionData]);

            const updateCompetencyScores = (questionData, isCorrect) => {
                setCompetencyScores(prevScores => {
                    const newScores = { ...prevScores };
                    const competencies = activityConfig?.competencies || [];
                    
                    competencies.forEach(competency => {
                        if (newScores[competency]) {
                            newScores[competency].total += 1;
                            if (isCorrect) {
                                newScores[competency].correct += 1;
                            }
                        }
                    });

                    return newScores;
                });
            };

            const handleDrop = (rowIndex, colIndex, blockType) => {
                const newGrid = [...grid];
                newGrid[rowIndex][colIndex] = blockType;
                setGrid(newGrid);
            };

            const handleRemove = (rowIndex, colIndex) => {
                const newGrid = [...grid];
                newGrid[rowIndex][colIndex] = null;
                setGrid(newGrid);
            };

            const nextQuestion = () => {
                if (currentBlock < blockData.length - 1) {
                    setCurrentBlock(currentBlock + 1);
                } else {
                    saveResult(true); // Salva o último resultado
                    setCurrentPhase('resultado');
                }
            };
            
            const saveResult = (isFinalResult = false) => {
                const timeSpent = Math.round((Date.now() - startTime) / 1000);
                const currentBlockInfo = blockData[currentBlock];

                const result = {
                    Nome: studentName,
                    Materia: activityConfig?.subject || 'matematica',
                    Atividade: activityConfig?.name || 'Construtor Minecraft',
                    Bloco: currentBlockInfo.name,
                    Questao: `Bloco_${currentBlock + 1}`,
                    Tempo_Execucao: `${timeSpent}s`,
                    Acertos: isComplete ? 1 : 0,
                    Erros: isComplete ? 0 : 1,
                    Score: isComplete ? '100%' : '0%',
                    Questao_ID: currentQuestionData?.id || 'N/A'
                };
                
                const updatedResults = [...sessionResults, result];
                setSessionResults(updatedResults);
                localStorage.setItem('minecraftConstructorResults', JSON.stringify(updatedResults));
            };

            const downloadCSV = () => {
                const resultsToExport = JSON.parse(localStorage.getItem('minecraftConstructorResults') || '[]');
                if (resultsToExport.length === 0) {
                    alert("Nenhum dado para exportar!");
                    return;
                }
                const header = 'Nome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score\n';
                const csvContent = resultsToExport.map(r => `${r.Nome},${r.Materia},${r.Atividade},${r.Bloco},${r.Questao},${r.Tempo_Execucao},${r.Acertos},${r.Erros},${r.Score}`).join('\n');
                const fullContent = header + csvContent;
                const blob = new Blob([fullContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('download', `resultados-minecraft_constructor-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                localStorage.removeItem('minecraftConstructorResults');
                setSessionResults([]);
                setCurrentPhase('inicio');
            };

            if (loading) {
                return (
                    <div className="loading">
                        <div className="spinner"></div>
                        Carregando Banco de Dados...
                    </div>
                );
            }

            if (currentPhase === 'inicio') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-green-400 to-blue-500 p-4 flex items-center justify-center" style={getFontStyle()}>
                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                            <h1 className="text-4xl font-bold text-gray-800 mb-4">🏗️ Construtor Minecraft</h1>
                            <p className="text-lg text-gray-600 mb-6">Use blocos para construir estruturas e resolver desafios de soma.</p>
                            <input type="text" placeholder="Digite seu nome" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full p-4 border-2 border-gray-300 rounded-lg text-xl mb-6" />
                            <button onClick={() => studentName.trim() && setCurrentPhase('selecao')} disabled={!studentName.trim()} className="w-full py-4 bg-green-600 text-white font-bold text-xl rounded-lg hover:bg-green-700 disabled:opacity-50">
                                Iniciar
                            </button>
                            <a href="../index.html" className="block w-full mt-4 px-6 py-3 text-center bg-gray-500 text-white rounded-lg hover:bg-gray-600">Voltar ao Portal</a>
                        </div>
                    </div>
                );
            }

            if (currentPhase === 'selecao') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-green-400 to-blue-500 p-4" style={getFontStyle()}>
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-4xl font-bold text-white text-center mb-8">Olá, {studentName}! Escolha um bloco:</h1>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                {blockData.map((block, index) => (
                                    <div key={index} className="bg-white rounded-lg p-6 shadow-lg cursor-pointer" onClick={() => { setCurrentBlock(index); setScore(0); setSessionResults([]); setCurrentPhase('jogo'); }}>
                                        <h3 className="text-xl font-bold mb-2">{block.name}</h3>
                                        <p className="text-gray-600">Grid: {block.question.metadata.gridSize.rows}x{block.question.metadata.gridSize.cols}</p>
                                        <p className="text-gray-600">Tópico: {block.topic}</p>
                                    </div>
                                ))}
                            </div>
                             <button onClick={downloadCSV} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-bold">
                                Finalizar Sessão e Baixar CSV
                            </button>
                        </div>
                    </div>
                );
            }

            if (currentPhase === 'jogo' && currentQuestionData) {
                const currentBlockInfo = blockData[currentBlock];
                const question = currentQuestionData;
                
                return (
                    <div className="min-h-screen bg-gradient-to-b from-green-400 to-blue-500 p-4" style={getFontStyle()}>
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-lg p-4 mb-6 flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold">{currentBlockInfo.name}</h2>
                                    <p className="text-gray-600">{question.metadata.structure}</p>
                                </div>
                                <button onClick={() => setCurrentPhase('selecao')} className="bg-gray-500 text-white p-2 rounded">Voltar</button>
                            </div>
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-lg p-6 shadow-lg">
                                        <h3 className="text-2xl font-bold mb-4 text-center">🎯 Objetivo da Missão 🎯</h3>
                                         <p className="text-center text-lg mb-4">{question.content.statement}</p>
                                        <div className="space-y-4 text-lg">
                                            <p>🏗️ Construa: <span className="font-bold text-blue-600 text-xl">{question.metadata.structure}</span></p>
                                            <p>🔢 Soma Alvo: <span className="bg-green-500 text-white px-3 py-1 rounded-full font-bold text-2xl">{question.mathematics.result}</span></p>
                                            {budget && <p>💰 Orçamento: <span className="bg-yellow-500 text-white px-3 py-1 rounded-full font-bold text-2xl">{budget}</span></p>}
                                            <p>📊 Soma Atual: <span className={`font-bold text-2xl px-3 py-1 rounded-full ${currentSum > (budget || Infinity) ? 'bg-red-500 text-white' : currentSum === question.mathematics.result ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}`}>{currentSum}</span></p>
                                        </div>
                                        {feedback && <p className={`mt-4 p-3 rounded-lg font-semibold ${isComplete ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{feedback}</p>}
                                        {isComplete && <button onClick={nextQuestion} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg mt-4 text-xl font-bold">🚀 Próxima Questão</button>}
                                    </div>
                                    <div className="bg-white rounded-lg p-6 flex items-center justify-center border-4 border-dashed border-gray-300 min-h-[250px]">
                                        <div className="text-center text-gray-500">
                                            <div className="text-6xl mb-2">🖼️</div>
                                            <div className="font-semibold">Exemplo da Estrutura</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-lg p-6 shadow-lg">
                                        <h3 className="text-2xl font-bold mb-4 text-center">🧱 Blocos Disponíveis</h3>
                                        <div className="space-y-3">
                                            {availableBlocks.map((block, index) => (
                                                <div key={index} className="p-4 rounded-lg cursor-move text-white shadow-md" style={{backgroundColor: block.color}} draggable onDragStart={(e) => e.dataTransfer.setData('blockType', JSON.stringify(block))}>
                                                    <span className="font-bold text-lg">{block.name}</span> (Valor: <span className="font-bold">{block.value}</span>)
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-lg p-6 shadow-lg">
                                        <h3 className="text-2xl font-bold mb-4 text-center">🏗️ Área de Construção</h3>
                                        <div className="grid gap-2 mx-auto w-fit" style={{gridTemplateColumns: `repeat(${question.metadata.gridSize.cols}, 1fr)`}}>
                                            {grid.map((row, rowIndex) => row.map((cell, colIndex) => (
                                                <div key={`${rowIndex}-${colIndex}`} 
                                                     className="w-24 h-24 border-4 border-gray-300 rounded-lg cursor-pointer flex items-center justify-center bg-gray-100 hover:bg-gray-200"
                                                     style={{backgroundColor: cell ? cell.color : '#f0f0f0'}}
                                                     onDragOver={(e) => e.preventDefault()}
                                                     onDrop={(e) => handleDrop(rowIndex, colIndex, JSON.parse(e.dataTransfer.getData('blockType')))}
                                                     onClick={() => handleRemove(rowIndex, colIndex)}>
                                                    {cell && <div className="text-center font-bold text-white text-2xl" style={{textShadow: '2px 2px 4px #000'}}>{cell.value}</div>}
                                                </div>
                                            )))
                                        }
                                        <p className="text-center text-gray-600 mt-4 text-sm">💡 Clique em um bloco na área para removê-lo.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        ReactDOM.render(<MinecraftConstructor />, document.getElementById('root'));
    </script>
</body>
</html>
