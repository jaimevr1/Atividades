<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtor Minecraft</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Regular.otf') format('opentype');
          font-weight: normal; font-style: normal;
        }
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Bold.otf') format('opentype');
          font-weight: bold; font-style: normal;
        }
        body { font-family: 'Comic Sans MS', cursive, sans-serif; }
        .font-dyslexic { font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const backgroundMusicPlaylist = [
            '../media/musicas/theme_1.mp3',
            '../media/musicas/theme_2.mp3',
            '../media/musicas/theme_3.mp3'
        ];

        const MusicPlayer = () => {
            const audioRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(() => localStorage.getItem('musicIsPlaying') === 'true');
            const [currentTrackIndex, setCurrentTrackIndex] = useState(() => parseInt(localStorage.getItem('musicTrackIndex'), 10) || 0);

            useEffect(() => {
                localStorage.setItem('musicIsPlaying', isPlaying);
                if (isPlaying) {
                    audioRef.current.play().catch(e => console.error("Erro ao tocar m√∫sica:", e));
                } else {
                    audioRef.current.pause();
                }
            }, [isPlaying]);

            useEffect(() => {
                localStorage.setItem('musicTrackIndex', currentTrackIndex);
                if (audioRef.current) {
                    audioRef.current.src = backgroundMusicPlaylist[currentTrackIndex];
                    if (isPlaying) {
                        audioRef.current.play().catch(e => console.error("Erro ao tocar m√∫sica:", e));
                    }
                }
            }, [currentTrackIndex]);

            const handleNextTrack = () => {
                setCurrentTrackIndex(prevIndex => (prevIndex + 1) % backgroundMusicPlaylist.length);
            };

            const handleAudioEnded = () => {
                handleNextTrack();
            };

            useEffect(() => {
                const audio = audioRef.current;
                audio.volume = 0.5;
                audio.addEventListener('ended', handleAudioEnded);
                return () => {
                    audio.removeEventListener('ended', handleAudioEnded);
                };
            }, []);

            return (
                <div className="fixed bottom-4 right-4 bg-white/20 backdrop-blur-md text-white p-3 rounded-full shadow-lg flex items-center gap-3 z-50">
                    <audio ref={audioRef} src={backgroundMusicPlaylist[currentTrackIndex]} />
                    <button onClick={() => setIsPlaying(!isPlaying)} className="w-12 h-12 rounded-full bg-white/30 hover:bg-white/50 transition-all flex items-center justify-center">
                        {isPlaying ? '‚ùö‚ùö' : '‚ñ∂'}
                    </button>
                    <button onClick={handleNextTrack} className="w-12 h-12 rounded-full bg-white/30 hover:bg-white/50 transition-all flex items-center justify-center">
                        {'‚è≠'}
                    </button>
                </div>
            );
        };

        const activityConfig = {
            title: "Construtor Minecraft",
            subject: "matematica",
            activity: "minecraft_constructor",
            emoji: "üß±",
            primaryColor: "green",
        };

        const activityBlocks = [
            {
                id: 1,
                title: "Explorador (6-7 anos)",
                difficulty: "Iniciante",
                emoji: "üå≥",
                color: "from-green-500 to-lime-600",
                description: "Constru√ß√µes simples com somas b√°sicas.",
                gridSize: { rows: 2, cols: 2 },
                blockTypes: [
                    { name: "Madeira", color: "#8B4513", value: 1 },
                    { name: "Pedra", color: "#808080", value: 2 },
                    { name: "Terra", color: "#654321", value: 3 }
                ],
                questions: [
                    { id: "q1", structure: "Casa Pequena", target: 4, budget: null },
                    { id: "q2", structure: "Torre Simples", target: 6, budget: null },
                    { id: "q3", structure: "Ponte B√°sica", target: 5, budget: null },
                ]
            },
            {
                id: 2,
                title: "Construtor (8-9 anos)",
                difficulty: "Intermedi√°rio",
                emoji: "‚öîÔ∏è",
                color: "from-gray-500 to-slate-600",
                description: "Projetos maiores com or√ßamento limitado.",
                gridSize: { rows: 3, cols: 3 },
                blockTypes: [
                    { name: "Madeira", color: "#8B4513", value: 2 },
                    { name: "Pedra", color: "#808080", value: 3 },
                    { name: "Ferro", color: "#C0C0C0", value: 4 },
                    { name: "Ouro", color: "#FFD700", value: 5 }
                ],
                questions: [
                    { id: "q1", structure: "Casa M√©dia", target: 12, budget: 25 },
                    { id: "q2", structure: "Torre com Base", target: 15, budget: 30 },
                    { id: "q3", structure: "Ponte Refor√ßada", target: 18, budget: 35 },
                ]
            },
            {
                id: 3,
                title: "Arquiteto (10-11 anos)",
                difficulty: "Avan√ßado",
                emoji: "üíé",
                color: "from-cyan-500 to-blue-600",
                description: "Constru√ß√µes complexas com regras especiais.",
                gridSize: { rows: 3, cols: 4 },
                blockTypes: [
                    { name: "Madeira", color: "#8B4513", value: 3 },
                    { name: "Pedra", color: "#808080", value: 5 },
                    { name: "Ferro", color: "#C0C0C0", value: 7 },
                    { name: "Diamante", color: "#00FFFF", value: 10 },
                    { name: "Obsidiana", color: "#1a0033", value: 8 }
                ],
                questions: [
                    { id: "q1", structure: "Mans√£o", target: 35, budget: 60, special: "Use pelo menos 2 tipos diferentes" },
                    { id: "q2", structure: "Castelo Grande", target: 42, budget: 70, special: "Base de Pedra ou Ferro" },
                    { id: "q3", structure: "Torre M√°gica", target: 50, budget: 80, special: "Deve conter Diamante" },
                ]
            }
        ];

        const SoundSystem = {
            play: (src) => {
                try {
                    if (window.musicPlayerSetVolume) {
                        window.musicPlayerSetVolume(0.2); // Reduce background music volume
                    }
                    const audio = new Audio(src);
                    audio.play().catch(e => {});
                    audio.onended = () => {
                        if (window.musicPlayerSetVolume) {
                            window.musicPlayerSetVolume(0.5); // Restore background music volume
                        }
                    };
                } catch (e) {}
            },
            success: () => SoundSystem.play(`../media/sons/feedback/acertos/acerto_${Math.ceil(Math.random() * 4)}.mp3`),
            error: () => SoundSystem.play(`../media/sons/feedback/erros/erro_${Math.ceil(Math.random() * 4)}.mp3`),
            click: () => SoundSystem.play('../media/sons/feedback/click.mp3')
        };

        const InitialScreen = ({ onStart, studentName, setStudentName, font, setFont }) => (
            <div className={`min-h-screen bg-gradient-to-br from-${activityConfig.primaryColor}-500 via-teal-500 to-blue-600 flex items-center justify-center p-4`}>
                <MusicPlayer />
                <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                    <h1 className="text-4xl font-bold text-gray-800 mb-4">{activityConfig.emoji} {activityConfig.title}</h1>
                    <p className="text-lg text-gray-600 mb-6">Use blocos para construir estruturas e resolver desafios de soma.</p>
                    <input type="text" placeholder="Digite seu nome" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full p-4 border-2 border-gray-300 rounded-lg text-xl mb-6" />
                    <div className="flex items-center justify-center my-4 gap-4">
                        <span className="text-sm font-medium text-gray-700">üî§ Fonte para dislexia:</span>
                        <button onClick={() => { const newFont = font === 'Comic Sans MS' ? 'OpenDyslexic' : 'Comic Sans MS'; setFont(newFont); localStorage.setItem('selectedFont', newFont === 'OpenDyslexic' ? 'dyslexic' : 'normal'); }} className={`px-4 py-2 rounded-lg font-medium transition-all ${font === 'OpenDyslexic' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}`}>
                            {font === 'OpenDyslexic' ? '‚úÖ Ativada' : '‚ö™ Desativada'}
                        </button>
                    </div>
                    <button onClick={() => onStart(studentName)} disabled={!studentName.trim()} className={`w-full py-4 mt-4 bg-green-600 text-white font-bold text-xl rounded-lg hover:bg-green-700 disabled:opacity-50`}>Iniciar</button>
                    <a href="../index.html" className="block w-full mt-4 px-6 py-3 text-center bg-gray-500 text-white rounded-lg hover:bg-gray-600">Voltar ao Portal</a>
                </div>
            </div>
        );

        const BlockSelectionScreen = ({ studentName, onSelectBlock, onFinishSession }) => (
            <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-4">
                <MusicPlayer />
                <div className="max-w-7xl mx-auto">
                    <div className="text-center mb-8">
                        <h1 className="text-5xl font-bold text-white mb-2">Ol√°, {studentName}!</h1>
                        <p className="text-2xl text-white opacity-90">Escolha seu n√≠vel de desafio:</p>
                    </div>
                    <div className="bg-white/20 backdrop-blur-sm rounded-xl p-6 mb-8 text-white text-center">
                        <h3 className="text-2xl font-bold mb-2">üìú Como Jogar</h3>
                        <p>Arraste os blocos da paleta para a √°rea de constru√ß√£o. Seu objetivo √© fazer com que a soma dos valores dos blocos seja igual √† Soma Alvo, sem estourar o or√ßamento!</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {activityBlocks.map(block => (
                            <div key={block.id} className="bg-white rounded-3xl shadow-xl p-6 transform transition-all hover:scale-105 cursor-pointer group" onClick={() => onSelectBlock(block)}>
                                <div className="text-center">
                                    <div className="text-7xl mb-4">{block.emoji}</div>
                                    <h3 className={`text-2xl font-bold mb-2 bg-gradient-to-r ${block.color} bg-clip-text text-transparent`}>{block.title}</h3>
                                    <p className="text-gray-600 mb-4 text-lg">Grid: {block.gridSize.rows}x{block.gridSize.cols}</p>
                                    <button className={`w-full bg-gradient-to-r ${block.color} text-white font-bold py-4 rounded-xl text-lg`}>Construir</button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="text-center mt-8 bg-white/10 backdrop-blur-sm rounded-3xl p-6">
                        <button onClick={onFinishSession} className="bg-green-500 text-white font-bold py-4 px-8 rounded-xl text-lg hover:bg-green-600 mr-4">üíæ Finalizar Sess√£o & Baixar Resultados</button>
                    </div>
                </div>
            </div>
        );
        
        const SummaryScreen = ({ result, onRestart, onBackToSelection }) => (
            <div className="min-h-screen bg-gradient-to-br from-green-400 via-blue-500 to-purple-600 flex items-center justify-center p-4">
                <MusicPlayer />
                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full text-center">
                    <h2 className="text-4xl font-bold mb-4 text-gray-800">üéä Desafios Conclu√≠dos! üéä</h2>
                    <p className="text-2xl mb-8 text-gray-700">Voc√™ completou o n√≠vel <strong>{result.Bloco}</strong>!</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-purple-50 rounded-2xl p-6">
                            <div className="text-4xl font-bold text-purple-600">{result.Acertos} / {result.Acertos + result.Erros}</div>
                            <div className="text-lg text-gray-700">Acertos</div>
                        </div>
                        <div className="bg-orange-50 rounded-2xl p-6">
                            <div className="text-4xl font-bold text-orange-600">{result.Tempo_Execucao}</div>
                            <div className="text-lg text-gray-700">Tempo Total</div>
                        </div>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onClick={onRestart} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-2xl text-xl">üîÑ Jogar Novamente</button>
                        <button onClick={onBackToSelection} className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-8 rounded-2xl text-xl">üìö Escolher Outro N√≠vel</button>
                    </div>
                </div>
            </div>
        );

        const ActivityScreen = ({ block, onBack, onComplete }) => {
            const [qIndex, setQIndex] = useState(0);
            const [grid, setGrid] = useState([]);
            const [currentSum, setCurrentSum] = useState(0);
            const [isComplete, setIsComplete] = useState(false);
            const [feedback, setFeedback] = useState('');
            const [score, setScore] = useState(0);
            const [startTime, setStartTime] = useState(Date.now());

            const question = block.questions[qIndex];

            useEffect(() => {
                const { rows, cols } = block.gridSize;
                setGrid(Array(rows).fill().map(() => Array(cols).fill(null)));
                setIsComplete(false);
                setFeedback('');
                setCurrentSum(0);
            }, [qIndex, block]);

            useEffect(() => {
                const sum = grid.flat().reduce((acc, cell) => acc + (cell ? cell.value : 0), 0);
                setCurrentSum(sum);

                if (sum > 0 && sum === question.target) {
                    if (!isComplete) {
                        SoundSystem.success();
                        setFeedback('Parab√©ns! Estrutura constru√≠da com sucesso!');
                        setIsComplete(true);
                        setScore(s => s + 1);
                    }
                } else if (question.budget && sum > question.budget) {
                    SoundSystem.error();
                    setFeedback(`Or√ßamento estourado! Limite: ${question.budget}`);
                    setIsComplete(false);
                } else {
                    setIsComplete(false);
                    setFeedback(sum > 0 ? `Soma atual: ${sum} | Alvo: ${question.target}`: '');
                }
            }, [grid]);

            const handleDrop = (r, c, blockType) => {
                const newGrid = grid.map(row => [...row]);
                newGrid[r][c] = blockType;
                setGrid(newGrid);
                SoundSystem.click();
            };

            const handleRemove = (r, c) => {
                const newGrid = grid.map(row => [...row]);
                newGrid[r][c] = null;
                setGrid(newGrid);
            };

            const nextQuestion = () => {
                if (qIndex < block.questions.length - 1) {
                    setQIndex(qIndex + 1);
                } else {
                    onComplete({ block, acertos: score, erros: block.questions.length - score, tempoTotal: Math.round((Date.now() - startTime) / 1000) });
                }
            };

            return (
                <div className={`min-h-screen bg-gradient-to-b from-green-400 to-blue-500 p-4`}>
                    <MusicPlayer />
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg p-4 mb-6 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold">{block.title}</h2>
                                <p className="text-gray-600">Desafio {qIndex + 1}/{block.questions.length}: {question.structure}</p>
                            </div>
                            <button onClick={onBack} className="bg-gray-500 text-white p-2 rounded-lg">Voltar</button>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white rounded-lg p-6 shadow-lg space-y-4">
                                <h3 className="text-2xl font-bold text-center">üéØ Miss√£o</h3>
                                <p>üèóÔ∏è Construa: <span className="font-bold text-blue-600">{question.structure}</span></p>
                                <p>üî¢ Soma Alvo: <span className="bg-green-500 text-white px-3 py-1 rounded-full font-bold">{question.target}</span></p>
                                {question.budget && <p>üí∞ Or√ßamento: <span className="bg-yellow-500 text-white px-3 py-1 rounded-full font-bold">{question.budget}</span></p>}
                                <p>üìä Soma Atual: <span className={`font-bold px-3 py-1 rounded-full ${currentSum > (question.budget || Infinity) ? 'bg-red-500 text-white' : currentSum === question.target ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}`}>{currentSum}</span></p>
                                {feedback && <p className={`mt-2 p-3 rounded-lg font-semibold ${isComplete ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{feedback}</p>}
                                {isComplete && <button onClick={nextQuestion} className="w-full bg-green-600 text-white py-3 rounded-lg mt-2 font-bold">üöÄ Pr√≥ximo Desafio</button>}
                            </div>
                            <div className="bg-white rounded-lg p-6 shadow-lg">
                                <h3 className="text-2xl font-bold text-center mb-4">üß± Blocos</h3>
                                <div className="flex flex-wrap gap-3 justify-center">
                                    {block.blockTypes.map((b, i) => (
                                        <div key={i} draggable onDragStart={(e) => e.dataTransfer.setData('block', JSON.stringify(b))} className="p-3 rounded-lg cursor-move text-white shadow-md text-center" style={{backgroundColor: b.color}}>
                                            <div className="font-bold">{b.name}</div>
                                            <div>Valor: {b.value}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="bg-white rounded-lg p-6 shadow-lg mt-6">
                            <h3 className="text-2xl font-bold text-center mb-4">üèóÔ∏è √Årea de Constru√ß√£o</h3>
                            <div className="grid gap-1 mx-auto w-fit" style={{gridTemplateColumns: `repeat(${block.gridSize.cols}, 1fr)`}}>
                                {grid.map((row, r) => row.map((cell, c) => (
                                    <div key={`${r}-${c}`} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(r, c, JSON.parse(e.dataTransfer.getData('block')))} onClick={() => handleRemove(r, c)} className="w-20 h-20 border-2 border-gray-400 rounded-md flex items-center justify-center bg-gray-200 hover:bg-gray-300" style={{backgroundColor: cell ? cell.color : null}}>
                                        {cell && <div className="font-bold text-white text-xl" style={{textShadow: '1px 1px 2px #000'}}>{cell.value}</div>}
                                    </div>
                                )))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AtividadeTemplate = () => {
            const [studentName, setStudentName] = useState(localStorage.getItem('studentName') || '');
            const [font, setFont] = useState(localStorage.getItem('selectedFont') === 'dyslexic' ? 'OpenDyslexic' : 'Comic Sans MS');
            const [currentScreen, setCurrentScreen] = useState('initial');
            const [selectedBlock, setSelectedBlock] = useState(null);
            const [sessionResults, setSessionResults] = useState([]);
            const [lastResult, setLastResult] = useState(null);

            useEffect(() => {
                document.title = activityConfig.title;
                document.body.className = font === 'OpenDyslexic' ? 'font-dyslexic' : '';
            }, [font]);

            const handleStart = (name) => {
                if (name.trim()) {
                    setStudentName(name);
                    localStorage.setItem('studentName', name);
                    setCurrentScreen('blockSelection');
                }
            };

            const handleSelectBlock = (block) => {
                setSelectedBlock(block);
                setCurrentScreen('activity');
            };
            
            const handleCompleteBlock = (result) => {
                const newResult = {
                    Nome: studentName,
                    Materia: activityConfig.subject,
                    Atividade: activityConfig.activity,
                    Bloco: result.block.title,
                    Questao: `${result.block.questions.length}_desafios`,
                    Tempo_Execucao: `${result.tempoTotal}s`,
                    Acertos: result.acertos,
                    Erros: result.erros,
                    Score: `${Math.round((result.acertos / result.block.questions.length) * 100)}%`
                };
                setSessionResults(prev => [...prev, newResult]);
                setLastResult(newResult);
                setCurrentScreen('summary');
            };

            const handleFinishSession = () => {
                if (sessionResults.length === 0) {
                    alert("Nenhuma atividade foi completada para gerar o relat√≥rio.");
                    return;
                }
                const header = 'Nome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score\n';
                const csvContent = sessionResults.map(r => Object.values(r).join(',')).join('\n');
                const blob = new Blob([header + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-') ;
                const studentNameForFile = studentName.replace(/[^a-zA-Z0-9]/g, '_');
                link.download = `${activityConfig.activity}_${studentNameForFile}_${dateStr}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert("üéâ Dados exportados com sucesso!");
            };

            const restartBlock = () => {
                setCurrentScreen('activity');
            };

            switch (currentScreen) {
                case 'initial':
                    return <InitialScreen onStart={handleStart} studentName={studentName} setStudentName={setStudentName} font={font} setFont={setFont} />;
                case 'blockSelection':
                    return <BlockSelectionScreen studentName={studentName} onSelectBlock={handleSelectBlock} onFinishSession={handleFinishSession} />;
                case 'activity':
                    return <ActivityScreen block={selectedBlock} onBack={() => setCurrentScreen('blockSelection')} onComplete={handleCompleteBlock} />;
                case 'summary':
                    return <SummaryScreen result={lastResult} onRestart={restartBlock} onBackToSelection={() => setCurrentScreen('blockSelection')} />;
                default:
                    return <InitialScreen onStart={handleStart} studentName={studentName} setStudentName={setStudentName} font={font} setFont={setFont} />;
            }
        };

        ReactDOM.render(<AtividadeTemplate />, document.getElementById('root'));
    </script>
</body>
</html>
