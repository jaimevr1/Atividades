<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazenda de Mobs</title>
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Database Integration Scripts -->
    <script src="../src/data/questionDatabase.js"></script>
    <script src="../src/config/activityMapping.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif;
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div class="spinner"></div>
            Carregando Atividade...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const FazendaMobs = () => {
            const [studentName, setStudentName] = useState('');
            const [selectedFont, setSelectedFont] = useState(localStorage.getItem('selectedFont') || 'comic');
            const [currentPhase, setCurrentPhase] = useState('inicio');
            const [currentBlock, setCurrentBlock] = useState(null);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [sessionResults, setSessionResults] = useState([]);
            const [startTime, setStartTime] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [showFeedback, setShowFeedback] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [score, setScore] = useState(0);
            const [questionsData, setQuestionsData] = useState(null);
            const [competencyScores, setCompetencyScores] = useState({
                calculation: { correct: 0, total: 0 },
                operation_identification: { correct: 0, total: 0 }
            });
            const [loading, setLoading] = useState(true);

            // Database loader function with fallback to hardcoded data
            const loadFazendaQuestions = async () => {
                try {
                    // Load the exported database first
                    const response = await fetch('../src/data/exported-database.json');
                    const database = await response.json();

                    // Get activity configuration
                    const activityConfig = window.ACTIVITY_MAPPING['fazenda_mobs'];

                    if (!activityConfig) {
                        throw new Error('Activity configuration not found');
                    }

                    // Get fazenda questions from database
                    const fazendaQuestions = database.questions.filter(([id, question]) =>
                        question.metadata.originalActivity === 'Fazenda de Mobs'
                    );

                    // Use fallback data if database questions are insufficient
                    if (fazendaQuestions.length < 20) {
                        console.warn('Using fallback hardcoded fazenda questions');
                        return getFallbackFazendaQuestions();
                    }

                    // Build questions structure
                    const questionsBlocks = {};

                    // Map each block
                    activityConfig.questionBlocks.forEach((blockConfig, index) => {
                        const blockNumber = index + 1;
                        const blockQuestions = [];

                        // Select questions for this block (5 per block)
                        const startIndex = index * 5;
                        const endIndex = startIndex + 5;
                        const blockQuestionsData = fazendaQuestions.slice(startIndex, endIndex);

                        blockQuestionsData.forEach(([id, questionData]) => {
                            // Calculate answer from numbers if not available
                            let calculatedAnswer = questionData.mathematics.result;
                            if (!calculatedAnswer && questionData.mathematics.numbers && questionData.mathematics.numbers.length === 2) {
                                // Assume multiplication for fazenda context
                                calculatedAnswer = questionData.mathematics.numbers[0] * questionData.mathematics.numbers[1];
                            }

                            // Transform database question to expected format
                            const transformedQuestion = {
                                id: id,
                                scenario: questionData.content.statement,
                                visual: questionData.content.visual?.emoji || generateFarmVisual(questionData),
                                calculation: questionData.mathematics.expression || `${questionData.mathematics.numbers?.[0] || 0} √ó ${questionData.mathematics.numbers?.[1] || 0}`,
                                answer: calculatedAnswer || 0,
                                multiplication: `${questionData.mathematics.numbers?.[0] || 0} √ó ${questionData.mathematics.numbers?.[1] || 0}`,
                                hint: 'Resolva a multiplica√ß√£o!',
                                context: questionData.content.context,
                                competencies: {
                                    calculation: {
                                        type: 'input_number',
                                        question: questionData.content.statement,
                                        correctAnswer: calculatedAnswer,
                                        explanation: 'Calcule o resultado da multiplica√ß√£o.'
                                    },
                                    operation_identification: questionData.competencies.operation_identification || {
                                        type: 'multiple_choice',
                                        question: `Qual opera√ß√£o usar?`,
                                        options: ['adi√ß√£o', 'subtra√ß√£o', 'multiplica√ß√£o', 'divis√£o'],
                                        correctAnswer: 'multiplica√ß√£o',
                                        explanation: 'Esta quest√£o requer multiplica√ß√£o.'
                                    }
                                }
                            };
                            blockQuestions.push(transformedQuestion);
                        });

                        questionsBlocks[blockNumber] = {
                            title: getBlockTitle(blockNumber),
                            ageRange: "6-8 anos",
                            questions: blockQuestions
                        };
                    });

                    return questionsBlocks;

                } catch (error) {
                    console.error('Error loading fazenda questions:', error);
                    console.warn('Using fallback hardcoded fazenda questions');
                    return getFallbackFazendaQuestions();
                }
            };

            // Fallback function with hardcoded fazenda questions
            const getFallbackFazendaQuestions = () => {
                return {
                    1: {
                        title: "üêÑ Fazenda dos Novi√ßos - Primeiros Animais",
                        ageRange: "6-8 anos",
                        questions: [
                            {
                                id: 'fazenda_01_q1',
                                scenario: 'Na sua fazenda, voc√™ tem 3 currais. Cada curral tem 4 vacas. Quantas vacas voc√™ tem no total?',
                                visual: 'üêÑüêÑüêÑüêÑ | üêÑüêÑüêÑüêÑ | üêÑüêÑüêÑüêÑ',
                                calculation: '4 + 4 + 4',
                                answer: 12,
                                multiplication: '3 √ó 4',
                                hint: 'Conte as vacas de cada curral!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 12, explanation: 'Multiplique 3 √ó 4' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_01_q2',
                                scenario: 'Suas galinhas botaram ovos! Voc√™ tem 5 ninhos, cada ninho tem 3 ovos. Quantos ovos voc√™ coletou?',
                                visual: 'ü•öü•öü•ö | ü•öü•öü•ö | ü•öü•öü•ö | ü•öü•öü•ö | ü•öü•öü•ö',
                                calculation: '3 + 3 + 3 + 3 + 3',
                                answer: 15,
                                multiplication: '5 √ó 3',
                                hint: 'Some os ovos de todos os ninhos!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 15, explanation: 'Multiplique 5 √ó 3' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_01_q3',
                                scenario: 'Voc√™ plantou 4 fileiras de cenouras. Cada fileira tem 6 cenouras. Quantas cenouras cresceram?',
                                visual: 'ü•ïü•ïü•ïü•ïü•ïü•ï (√ó4 fileiras)',
                                calculation: '6 + 6 + 6 + 6',
                                answer: 24,
                                multiplication: '4 √ó 6',
                                hint: 'Conte as cenouras de cada fileira!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 24, explanation: 'Multiplique 4 √ó 6' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_01_q4',
                                scenario: 'Seus porcos est√£o em 2 chiqueiros. Cada chiqueiro tem 7 porcos. Quantos porcos voc√™ tem?',
                                visual: 'üê∑üê∑üê∑üê∑üê∑üê∑üê∑ | üê∑üê∑üê∑üê∑üê∑üê∑üê∑',
                                calculation: '7 + 7',
                                answer: 14,
                                multiplication: '2 √ó 7',
                                hint: 'Conte os porcos de cada chiqueiro!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 14, explanation: 'Multiplique 2 √ó 7' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_01_q5',
                                scenario: 'Voc√™ tem 3 ovelhas e cada ovelha teve 5 filhotes. Quantos cordeiros nasceram?',
                                visual: 'üêë‚Üíüêëüêëüêëüêëüêë (√ó3 ovelhas)',
                                calculation: '5 + 5 + 5',
                                answer: 15,
                                multiplication: '3 √ó 5',
                                hint: 'Cada ovelha teve 5 filhotes!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 15, explanation: 'Multiplique 3 √ó 5' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            }
                        ]
                    },
                    2: {
                        title: "üê∑ Fazenda Crescente - Mais Variedade",
                        ageRange: "6-8 anos",
                        questions: [
                            {
                                id: 'fazenda_02_q1',
                                scenario: 'Voc√™ expandiu! Agora tem 6 cercados com 8 animais cada. Quantos animais voc√™ tem?',
                                visual: 'üêÑüê∑üêîüêëüêêü¶Üüê¥üêï (√ó6 cercados)',
                                calculation: '8 + 8 + 8 + 8 + 8 + 8',
                                answer: 48,
                                multiplication: '6 √ó 8',
                                hint: 'Cada cercado tem 8 animais!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 48, explanation: 'Multiplique 6 √ó 8' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_02_q2',
                                scenario: 'Suas 4 vacas produzem leite. Cada vaca d√° 9 litros por dia. Quantos litros voc√™ coleta?',
                                visual: 'üêÑ‚Üíü•õü•õü•õü•õü•õü•õü•õü•õü•õ (√ó4 vacas)',
                                calculation: '9 + 9 + 9 + 9',
                                answer: 36,
                                multiplication: '4 √ó 9',
                                hint: 'Cada vaca produz 9 litros!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 36, explanation: 'Multiplique 4 √ó 9' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_02_q3',
                                scenario: 'Voc√™ tem 7 fileiras de milho. Cada fileira tem 7 plantas. Quantas plantas de milho voc√™ tem?',
                                visual: 'üåΩüåΩüåΩüåΩüåΩüåΩüåΩ (√ó7 fileiras)',
                                calculation: '7 + 7 + 7 + 7 + 7 + 7 + 7',
                                answer: 49,
                                multiplication: '7 √ó 7',
                                hint: 'S√£o 7 fileiras com 7 plantas cada!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 49, explanation: 'Multiplique 7 √ó 7' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_02_q4',
                                scenario: 'Seus 8 patos nadam no lago. Cada pato come 6 peixes pequenos. Quantos peixes eles comem?',
                                visual: 'ü¶Ü‚Üíüêüüêüüêüüêüüêüüêü (√ó8 patos)',
                                calculation: '6 + 6 + 6 + 6 + 6 + 6 + 6 + 6',
                                answer: 48,
                                multiplication: '8 √ó 6',
                                hint: 'Cada pato come 6 peixes!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 48, explanation: 'Multiplique 8 √ó 6' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_02_q5',
                                scenario: 'Voc√™ colheu ma√ß√£s! Em 5 √°rvores, cada uma deu 8 ma√ß√£s. Quantas ma√ß√£s voc√™ colheu?',
                                visual: 'üå≥‚Üíüçéüçéüçéüçéüçéüçéüçéüçé (√ó5 √°rvores)',
                                calculation: '8 + 8 + 8 + 8 + 8',
                                answer: 40,
                                multiplication: '5 √ó 8',
                                hint: 'Cada √°rvore deu 8 ma√ß√£s!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 40, explanation: 'Multiplique 5 √ó 8' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            }
                        ]
                    },
                    3: {
                        title: "üêî Fazenda Organizada - Controle Total",
                        ageRange: "6-8 anos",
                        questions: [
                            {
                                id: 'fazenda_03_q1',
                                scenario: 'Sua fazenda cresceu! Voc√™ tem 9 celeiros, cada um guarda 9 sacos de ra√ß√£o. Quantos sacos voc√™ tem?',
                                visual: 'üè†‚Üíüì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶ (√ó9 celeiros)',
                                calculation: '9 + 9 + 9 + 9 + 9 + 9 + 9 + 9 + 9',
                                answer: 81,
                                multiplication: '9 √ó 9',
                                hint: 'S√£o 9 celeiros com 9 sacos cada!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 81, explanation: 'Multiplique 9 √ó 9' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_03_q2',
                                scenario: 'Suas galinhas s√£o produtivas! 12 galinhas, cada uma bota 6 ovos por semana. Quantos ovos por semana?',
                                visual: 'üêî‚Üíü•öü•öü•öü•öü•öü•ö (√ó12 galinhas)',
                                calculation: '6 √ó 12',
                                answer: 72,
                                multiplication: '12 √ó 6',
                                hint: 'Cada galinha bota 6 ovos por semana!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 72, explanation: 'Multiplique 12 √ó 6' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_03_q3',
                                scenario: 'Voc√™ plantou um pomar! 8 fileiras com 11 √°rvores frut√≠feras cada. Quantas √°rvores voc√™ plantou?',
                                visual: 'üå≥üå≥üå≥üå≥üå≥üå≥üå≥üå≥üå≥üå≥üå≥ (√ó8 fileiras)',
                                calculation: '11 √ó 8',
                                answer: 88,
                                multiplication: '8 √ó 11',
                                hint: 'S√£o 8 fileiras com 11 √°rvores cada!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 88, explanation: 'Multiplique 8 √ó 11' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_03_q4',
                                scenario: 'Seus 6 cavalos pastam no campo. Cada cavalo come 12 kg de capim por dia. Quanto capim precisam?',
                                visual: 'üê¥‚Üíüåæüåæüåæüåæüåæüåæüåæüåæüåæüåæüåæüåæ (√ó6 cavalos)',
                                calculation: '12 √ó 6',
                                answer: 72,
                                multiplication: '6 √ó 12',
                                hint: 'Cada cavalo come 12 kg por dia!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 72, explanation: 'Multiplique 6 √ó 12' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_03_q5',
                                scenario: 'Voc√™ tem abelhas! 7 colmeias, cada uma produz 10 potes de mel por m√™s. Quanto mel voc√™ obt√©m?',
                                visual: 'üè†‚ÜíüçØüçØüçØüçØüçØüçØüçØüçØüçØüçØ (√ó7 colmeias)',
                                calculation: '10 √ó 7',
                                answer: 70,
                                multiplication: '7 √ó 10',
                                hint: 'Cada colmeia produz 10 potes de mel!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 70, explanation: 'Multiplique 7 √ó 10' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            }
                        ]
                    },
                    4: {
                        title: "üêë Fazenda Master - Desafios Avan√ßados",
                        ageRange: "6-8 anos",
                        questions: [
                            {
                                id: 'fazenda_04_q1',
                                scenario: 'Sua fazenda √© enorme! 15 setores, cada setor tem 12 animais diferentes. Quantos animais ao todo?',
                                visual: 'üêÑüê∑üêîüêëüêêü¶Üüê¥üêïüêàü¶Éüê∞üêπ (√ó15 setores)',
                                calculation: '12 √ó 15',
                                answer: 180,
                                multiplication: '15 √ó 12',
                                hint: 'S√£o 15 setores com 12 animais cada!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 180, explanation: 'Multiplique 15 √ó 12' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_04_q2',
                                scenario: 'Voc√™ vende seus produtos! 14 clientes, cada um compra 13 produtos. Quantos produtos voc√™ vendeu?',
                                visual: 'üõí‚Üíüì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶ (√ó14 clientes)',
                                calculation: '13 √ó 14',
                                answer: 182,
                                multiplication: '14 √ó 13',
                                hint: 'Cada cliente comprou 13 produtos!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 182, explanation: 'Multiplique 14 √ó 13' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_04_q3',
                                scenario: 'Seu campo de trigo √© gigante! 16 fileiras com 14 plantas cada. Quantas plantas de trigo voc√™ tem?',
                                visual: 'üåæüåæüåæüåæüåæüåæüåæüåæüåæüåæüåæüåæüåæüåæ (√ó16 fileiras)',
                                calculation: '14 √ó 16',
                                answer: 224,
                                multiplication: '16 √ó 14',
                                hint: 'S√£o 16 fileiras com 14 plantas cada!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 224, explanation: 'Multiplique 16 √ó 14' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_04_q4',
                                scenario: 'Suas ovelhas d√£o muita l√£! 18 ovelhas, cada uma produz 11 kg de l√£. Quanta l√£ voc√™ obt√©m?',
                                visual: 'üêë‚Üíüß∂üß∂üß∂üß∂üß∂üß∂üß∂üß∂üß∂üß∂üß∂ (√ó18 ovelhas)',
                                calculation: '11 √ó 18',
                                answer: 198,
                                multiplication: '18 √ó 11',
                                hint: 'Cada ovelha produz 11 kg de l√£!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 198, explanation: 'Multiplique 18 √ó 11' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            },
                            {
                                id: 'fazenda_04_q5',
                                scenario: 'Parab√©ns! Sua fazenda √© um sucesso! 20 caminh√µes v√£o buscar produtos, cada um leva 15 caixas. Quantas caixas no total?',
                                visual: 'üöõ‚Üíüì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶üì¶ (√ó20 caminh√µes)',
                                calculation: '15 √ó 20',
                                answer: 300,
                                multiplication: '20 √ó 15',
                                hint: 'Cada caminh√£o leva 15 caixas!',
                                context: 'farm',
                                competencies: {
                                    calculation: { type: 'input_number', correctAnswer: 300, explanation: 'Multiplique 20 √ó 15' },
                                    operation_identification: { type: 'multiple_choice', correctAnswer: 'multiplica√ß√£o' }
                                }
                            }
                        ]
                    }
                };
            };

            const generateFarmVisual = (questionData) => {
                // Generate appropriate farm-themed visual based on question content
                const statement = questionData.content.statement.toLowerCase();
                if (statement.includes('animais') || statement.includes('pets')) return 'üêÑüê∑üêîüêë';
                if (statement.includes('ovos')) return 'ü•öü•öü•öü•ö';
                if (statement.includes('moedas')) return 'ü™ôü™ôü™ôü™ô';
                if (statement.includes('cercado')) return 'üêÑüêÑüêÑüêÑ';
                return 'üöúüåæüêÑüê∑';
            };

            const getBlockTitle = (blockNumber) => {
                const titles = {
                    1: "üêÑ Fazenda dos Novi√ßos - Primeiros Animais",
                    2: "üê∑ Fazenda Crescente - Mais Variedade",
                    3: "üêî Fazenda Organizada - Controle Total",
                    4: "üêë Fazenda Master - Desafios Avan√ßados"
                };
                return titles[blockNumber] || `üöú Fazenda N√≠vel ${blockNumber}`;
            };

            // Load questions on component mount
            useEffect(() => {
                const initializeQuestions = async () => {
                    setLoading(true);
                    try {
                        const loadedQuestions = await loadFazendaQuestions();
                        setQuestionsData(loadedQuestions);
                    } catch (error) {
                        console.error('Failed to initialize questions:', error);
                        setCurrentPhase('erro');
                    } finally {
                        setLoading(false);
                    }
                };

                initializeQuestions();
            }, []);

            const getFontStyle = () => ({
                fontFamily: selectedFont === 'dyslexic' ? "'OpenDyslexic', sans-serif" : "'Comic Sans MS', cursive"
            });

            const handleStartName = () => {
                if (studentName.trim()) {
                    setCurrentPhase('selecao');
                }
            };

            const selecionarBloco = (bloco) => {
                setCurrentBlock(bloco);
                setCurrentQuestion(0);
                setScore(0);
                setCurrentPhase('jogo');
                setStartTime(Date.now());
            };

            const submitAnswer = () => {
                const questionData = questionsData[currentBlock].questions[currentQuestion];
                const correct = parseInt(userAnswer) === questionData.answer;

                if(correct) {
                    setScore(prev => prev + 1);
                    // Update competency scores
                    updateCompetencyScores(questionData, true);
                } else {
                    updateCompetencyScores(questionData, false);
                }

                setIsCorrect(correct);
                setShowFeedback(true);

                setTimeout(() => {
                    nextQuestion();
                }, 3000);
            };

            const updateCompetencyScores = (questionData, isCorrect) => {
                setCompetencyScores(prev => {
                    const newScores = { ...prev };

                    // Update calculation competency
                    if (questionData.competencies?.calculation) {
                        newScores.calculation.total += 1;
                        if (isCorrect) newScores.calculation.correct += 1;
                    }

                    // Update operation identification competency
                    if (questionData.competencies?.operation_identification) {
                        newScores.operation_identification.total += 1;
                        if (isCorrect) newScores.operation_identification.correct += 1;
                    }

                    return newScores;
                });
            };

            const nextQuestion = () => {
                setShowFeedback(false);
                setUserAnswer('');
                if (currentQuestion < questionsData[currentBlock].questions.length - 1) {
                    setCurrentQuestion(prev => prev + 1);
                } else {
                    saveResult();
                    setCurrentPhase('selecao');
                }
            };
            
            const saveResult = () => {
                const timeSpent = Math.round((Date.now() - startTime) / 1000);
                const config = questionsData[currentBlock];

                // Calculate competency percentages
                const calcPercentage = competencyScores.calculation.total > 0 ?
                    Math.round((competencyScores.calculation.correct / competencyScores.calculation.total) * 100) : 0;
                const opIdPercentage = competencyScores.operation_identification.total > 0 ?
                    Math.round((competencyScores.operation_identification.correct / competencyScores.operation_identification.total) * 100) : 0;

                const result = {
                    Nome: studentName,
                    Materia: 'Matematica',
                    Atividade: 'Fazenda de Mobs',
                    Bloco: config.title,
                    Questao: `Bloco_${currentBlock}`,
                    Tempo_Execucao: `${timeSpent}s`,
                    Acertos: score,
                    Erros: config.questions.length - score,
                    Score: `${Math.round((score / config.questions.length) * 100)}%`,
                    // Competency scores
                    Competencia_Calculo: `${calcPercentage}%`,
                    Competencia_Identificacao: `${opIdPercentage}%`,
                    Acertos_Calculo: competencyScores.calculation.correct,
                    Total_Calculo: competencyScores.calculation.total,
                    Acertos_Identificacao: competencyScores.operation_identification.correct,
                    Total_Identificacao: competencyScores.operation_identification.total
                };
                const updatedResults = [...sessionResults, result];
                setSessionResults(updatedResults);
                localStorage.setItem('fazendaMobsResults', JSON.stringify(updatedResults));

                // Reset competency scores for next block
                setCompetencyScores({
                    calculation: { correct: 0, total: 0 },
                    operation_identification: { correct: 0, total: 0 }
                });
            };

            const downloadCSV = () => {
                const resultsToExport = JSON.parse(localStorage.getItem('fazendaMobsResults') || '[]');
                if (resultsToExport.length === 0) {
                    alert("Nenhum dado para exportar!");
                    return;
                }
                const header = 'Nome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score,Competencia_Calculo,Competencia_Identificacao,Acertos_Calculo,Total_Calculo,Acertos_Identificacao,Total_Identificacao\n';
                const csvContent = resultsToExport.map(r =>
                    `${r.Nome},${r.Materia},${r.Atividade},"${r.Bloco}",${r.Questao},${r.Tempo_Execucao},${r.Acertos},${r.Erros},${r.Score},${r.Competencia_Calculo || '0%'},${r.Competencia_Identificacao || '0%'},${r.Acertos_Calculo || 0},${r.Total_Calculo || 0},${r.Acertos_Identificacao || 0},${r.Total_Identificacao || 0}`
                ).join('\n');
                const fullContent = header + csvContent;
                const blob = new Blob([fullContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `resultados-fazenda_mobs-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                localStorage.removeItem('fazendaMobsResults');
                setSessionResults([]);
                setCurrentPhase('inicio');
            };

            // Audio integration function
            const playAudio = (type, questionId) => {
                try {
                    // Map questionId to block and question number for audio file structure
                    // For now, we'll generate placeholder audio paths based on block structure
                    const blockNumber = currentBlock.toString().padStart(2, '0');
                    const questionNumber = (currentQuestion + 1).toString();

                    let audioPath;
                    if (type === 'enunciado') {
                        audioPath = `../media/audios/matematica/fazenda_${blockNumber}/fazenda_${blockNumber}_questao_${questionNumber}_enunciado.mp3`;
                    } else if (type === 'explicacao') {
                        audioPath = `../media/audios/matematica/fazenda_${blockNumber}/fazenda_${blockNumber}_questao_${questionNumber}_explicacao.mp3`;
                    }

                    const audio = new Audio(audioPath);
                    audio.play().catch(error => {
                        console.log('Audio file not found or failed to play:', audioPath);
                        // Fallback: show text message
                        alert(`√Åudio n√£o dispon√≠vel: ${audioPath}`);
                    });
                } catch (error) {
                    console.log('Error playing audio:', error);
                }
            };

            if (loading || !questionsData) {
                return (
                    <div className="loading">
                        <div className="spinner"></div>
                        Carregando quest√µes da fazenda...
                    </div>
                );
            }

            if (currentPhase === 'erro') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-red-400 to-red-600 p-4 flex items-center justify-center" style={getFontStyle()}>
                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                            <h1 className="text-4xl font-bold text-red-600 mb-4">‚ùå Erro</h1>
                            <p className="text-lg text-gray-600 mb-6">N√£o foi poss√≠vel carregar as quest√µes da fazenda. Tente novamente mais tarde.</p>
                            <a href="../index.html" className="block w-full px-6 py-3 text-center bg-gray-500 text-white rounded-lg hover:bg-gray-600">Voltar ao Portal</a>
                        </div>
                    </div>
                );
            }

            if (currentPhase === 'inicio') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-green-400 to-blue-500 p-4 flex items-center justify-center" style={getFontStyle()}>
                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                            <h1 className="text-4xl font-bold text-gray-800 mb-4">üêÑ Fazenda de Mobs</h1>
                            <p className="text-lg text-gray-600 mb-6">Aprenda multiplica√ß√£o gerenciando sua fazenda de mobs do Roblox!</p>
                            <input type="text" placeholder="Digite seu nome" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full p-4 border-2 border-gray-300 rounded-lg text-xl mb-6" />
                            <button onClick={handleStartName} disabled={!studentName.trim()} className="w-full py-4 bg-green-600 text-white font-bold text-xl rounded-lg hover:bg-green-700 disabled:opacity-50">
                                Come√ßar
                            </button>
                            <a href="../index.html" className="block w-full mt-4 px-6 py-3 text-center bg-gray-500 text-white rounded-lg hover:bg-gray-600">Voltar ao Portal</a>
                        </div>
                    </div>
                );
            }

            if (currentPhase === 'selecao') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-green-400 to-blue-500 p-4" style={getFontStyle()}>
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-4xl font-bold text-white text-center mb-8">Ol√°, {studentName}! Escolha um bloco de desafios:</h1>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                {Object.entries(questionsData).map(([key, config]) => (
                                    <div key={key} className="bg-white rounded-lg p-6 shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onClick={() => selecionarBloco(parseInt(key))}>
                                        <h3 className="text-xl font-bold mb-2">{config.title}</h3>
                                        <p className="text-gray-600 mb-2">{config.ageRange}</p>
                                        <p className="text-sm text-blue-600">{config.questions.length} quest√µes</p>
                                    </div>
                                ))}
                            </div>
                            <div className="text-center">
                                <button onClick={downloadCSV} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-bold">
                                    Finalizar Sess√£o e Baixar CSV
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentPhase === 'jogo') {
                const questionData = questionsData[currentBlock].questions[currentQuestion];
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-400 via-purple-400 to-pink-400 p-4 flex items-center justify-center" style={getFontStyle()}>
                        <div className="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8">
                            <div className="mb-6">
                                <p className="text-lg text-gray-600 text-center">Quest√£o {currentQuestion + 1} de {questionsData[currentBlock].questions.length}</p>
                                <div className="w-full bg-gray-200 rounded-full h-4 mt-2">
                                    <div className="bg-green-500 h-4 rounded-full" style={{width: `${((currentQuestion + 1) / questionsData[currentBlock].questions.length) * 100}%`}}></div>
                                </div>
                            </div>
                            <div className="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-r-lg">
                                <h3 className="text-xl font-semibold text-gray-800">{questionData.scenario}</h3>
                            </div>
                            <div className="text-center my-6 text-3xl font-mono text-gray-700">{questionData.visual}</div>

                            {/* Audio integration for enunciado */}
                            {questionData.id && (
                                <div className="text-center mb-4">
                                    <button
                                        onClick={() => playAudio('enunciado', questionData.id)}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 mr-2"
                                    >
                                        üîä Ouvir Quest√£o
                                    </button>
                                </div>
                            )}

                            {!showFeedback ? (
                                <div className="space-y-4">
                                    <input
                                        type="number"
                                        value={userAnswer}
                                        onChange={(e) => setUserAnswer(e.target.value)}
                                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-xl text-center"
                                        placeholder="Sua resposta..."
                                    />
                                    <button onClick={submitAnswer} disabled={!userAnswer} className="w-full py-4 bg-blue-600 text-white font-bold text-xl rounded-lg disabled:opacity-50">
                                        Confirmar
                                    </button>
                                </div>
                            ) : (
                                <div className={`text-center p-6 rounded-lg ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`}>
                                    <h4 className={`text-2xl font-bold ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>{isCorrect ? 'Correto!' : 'Quase l√°!'}</h4>
                                    <p className="text-lg mt-2">A resposta √© {questionData.answer}. {questionData.multiplication && `(${questionData.multiplication})`}</p>
                                    <p className="text-sm text-gray-600 mt-2">{questionData.hint}</p>

                                    {/* Audio integration for explica√ß√£o */}
                                    {questionData.id && (
                                        <div className="mt-4">
                                            <button
                                                onClick={() => playAudio('explicacao', questionData.id)}
                                                className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                                            >
                                                üîä Ouvir Explica√ß√£o
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
        };

        ReactDOM.render(<FazendaMobs />, document.getElementById('root'));
    </script>
</body>
</html>