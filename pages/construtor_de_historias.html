<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtor de Hist√≥rias com IA</title>
    <link rel="stylesheet" href="../VariableProximity.css">
    <script src="../variable-proximity-effect.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');
        body { font-family: 'Comic Neue', 'Comic Sans MS', cursive; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-4 md:p-8 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // WARNING: Do not expose your API key in client-side code.
        const API_KEY = "AIzaSyDvXhx3Gcm5qtG264l6rFC86siccCrV-Fk";
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";

        // Direct API integration without library dependencies
        let apiReady = false;

        async function initializeGenerativeAI(apiKey) {
            try {
                // Test API connection with a simple request
                const testUrl = `${API_URL}?key=${apiKey}`;
                console.log("üì° Testing API connection...");

                const testResponse = await fetch(testUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: "Hello" }]
                        }]
                    })
                });

                if (testResponse.ok) {
                    apiReady = true;
                    console.log("‚úÖ Gemini API initialized successfully");
                    return true;
                } else {
                    const error = await testResponse.json();
                    console.error("‚ùå API test failed:");
                    console.error("Status:", testResponse.status);
                    console.error("Error details:", JSON.stringify(error, null, 2));

                    if (error.error?.message) {
                        console.error("Error message:", error.error.message);
                    }

                    return false;
                }
            } catch (error) {
                console.error("‚ùå Error initializing Gemini API:", error);
                console.error("Error details:", error.message);
                return false;
            }
        }

        async function generateContent(prompt) {
            if (!apiReady) {
                console.error("‚ùå API not ready");
                return "Erro: API n√£o inicializada. Recarregue a p√°gina.";
            }

            try {
                const url = `${API_URL}?key=${API_KEY}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            maxOutputTokens: 800,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                console.log("‚úÖ Story generated successfully");
                return text;
            } catch (error) {
                console.error("‚ùå Error generating content:", error);
                return `A imagina√ß√£o falhou desta vez. üòî\n\nErro: ${error.message}\n\nTente novamente!`;
            }
        }

        const App = () => {
            const [phase, setPhase] = useState('start');
            const [studentName, setStudentName] = useState('');
            const [sessionResults, setSessionResults] = useState([]);
            const [font, setFont] = useState('Comic Sans MS');

            useEffect(() => {
                document.body.style.fontFamily = font;
            }, [font]);

            const handleStart = (name, selectedFont) => {
                setStudentName(name);
                setFont(selectedFont);
                setPhase('game');
            };

            const handleSaveResult = (result) => {
                setSessionResults(prev => [...prev, result]);
            };

            const downloadCSV = () => {
                if (sessionResults.length === 0) {
                    alert("Nenhuma hist√≥ria foi gerada para exportar!");
                    return;
                }
                const header = 'Nome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score\n';
                const csvContent = sessionResults.map(r =>
                    `${r.Nome},${r.Materia},${r.Atividade},${r.Bloco},${r.Questao},${r.Tempo_Execucao},${r.Acertos},${r.Erros},${r.Score}`
                ).join('\n');
                const blob = new Blob(["\uFEFF" + header + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.download = `resultados_construtor_historias_${studentName}_${timestamp}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            if (phase === 'start') return <StartScreen onStart={handleStart} />;
            return <ConstrutorHistorias studentName={studentName} onSaveResult={handleSaveResult} downloadCSV={downloadCSV} />;
        }

        function StartScreen({ onStart }) {
            const [name, setName] = useState('');
            const [selectedFont, setSelectedFont] = useState('Comic Sans MS');

            useEffect(() => {
                // Initialize VariableProximity effects
                if (window.VariableProximityEffect) {
                    const titles = document.querySelectorAll('[data-proximity]');
                    titles.forEach(title => {
                        if (!title.proximityEffect) {
                            title.proximityEffect = new VariableProximityEffect(title);
                        }
                    });
                }
            }, []);

            return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="bg-white/90 p-8 rounded-2xl shadow-xl text-center max-w-lg w-full">
                        <h1 className="text-4xl font-black text-gray-800 mb-4" data-proximity data-radius="150" data-from-font-variation-settings="'wght' 300, 'opsz' 9" data-to-font-variation-settings="'wght' 900, 'opsz' 50" data-falloff="exponential">Construtor de Hist√≥rias</h1>
                        <input type="text" placeholder="Digite seu nome" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-center text-xl text-black" />
                        <div className="mb-6">
                            <p className="text-gray-700 mb-2">Escolha sua fonte:</p>
                            <div className="flex justify-center gap-4">
                                <button onClick={() => setSelectedFont('Comic Sans MS')} className={`px-4 py-2 rounded-lg ${selectedFont === 'Comic Sans MS' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-black'}`}>Comic Sans</button>
                                <button onClick={() => setSelectedFont('OpenDyslexic')} className={`px-4 py-2 rounded-lg ${selectedFont === 'OpenDyslexic' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-black'}`}>OpenDyslexic</button>
                            </div>
                        </div>
                        <button onClick={() => onStart(name, selectedFont)} disabled={!name.trim()} className="w-full py-3 bg-purple-600 text-white font-bold rounded-lg disabled:opacity-50">Come√ßar a Criar</button>
                    </div>
                </div>
            );
        }

        function ConstrutorHistorias({ studentName, onSaveResult, downloadCSV }) {
          const [selectedElements, setSelectedElements] = useState({personagens: null, personalidades: null, objetivos: null, antagonistas: null});
          const [generatedStory, setGeneratedStory] = useState('');
          const [isGenerating, setIsGenerating] = useState(false);
          const [startTime, setStartTime] = useState(null);
          const [totalStories, setTotalStories] = useState(0);
          const [showFeedback, setShowFeedback] = useState(false);
          const [aiReady, setAiReady] = useState(false);

          useEffect(() => {
            console.log("üîÑ Initializing Gemini API...");
            initializeGenerativeAI(API_KEY).then(success => {
              if (success) {
                setAiReady(true);
                console.log("‚úÖ Gemini API ready to generate stories!");
              } else {
                console.error("‚ùå Failed to initialize Gemini API");
                console.warn("‚ö†Ô∏è Tentando modo de fallback (sem teste pr√©vio)");
                // Modo fallback: marca como pronto mesmo sem teste inicial
                apiReady = true;
                setAiReady(true);
                console.log("üîÑ API marcada como pronta (modo fallback)");
              }
            }).catch(error => {
              console.error("‚ùå Initialization error:", error);
              // Modo fallback em caso de erro
              apiReady = true;
              setAiReady(true);
              console.log("üîÑ API marcada como pronta (fallback ap√≥s erro)");
            });
          }, []);

          const handleSelect = (item, category) => setSelectedElements(prev => ({ ...prev, [category]: item }));
          const clearAll = () => {
            setSelectedElements({personagens: null, personalidades: null, objetivos: null, antagonistas: null});
            setGeneratedStory('');
          };

          const canGenerate = Object.values(selectedElements).every(el => el !== null);

          const finishAndDownload = () => {
              downloadCSV();
              window.parent.postMessage('close-activity', '*');
          }

          const generateStory = async () => {
            if (!canGenerate) {
              console.warn("‚ö†Ô∏è Cannot generate: Not all elements selected");
              return;
            }

            if (!apiReady) {
              alert("‚ö†Ô∏è A IA do Gemini ainda n√£o foi inicializada. Aguarde alguns segundos e tente novamente.");
              return;
            }

            console.log("üöÄ Starting story generation...");
            setIsGenerating(true);
            const generationStartTime = Date.now();
            setStartTime(generationStartTime);
            setGeneratedStory('');
            setShowFeedback(false);

            const prompt = `Crie uma hist√≥ria CURTA e DIVERTIDA (m√°ximo 10 linhas) em portugu√™s brasileiro para crian√ßas, com os seguintes elementos:
- Personagem: ${selectedElements.personagens.text}
- Personalidade: ${selectedElements.personalidades.text}
- Objetivo: ${selectedElements.objetivos.text}
- Antagonista: ${selectedElements.antagonistas.text}

Escreva APENAS o texto da hist√≥ria, sem t√≠tulos ou introdu√ß√µes.`;

            console.log("üìù Prompt:", prompt);

            try {
              const storyText = await generateContent(prompt);
              console.log("‚úÖ Story received:", storyText.substring(0, 50) + "...");
              setGeneratedStory(storyText);
              setIsGenerating(false);

              const time = Math.round((Date.now() - generationStartTime) / 1000);
              setTotalStories(prev => prev + 1);
              setShowFeedback(true);

              onSaveResult({
                  Nome: studentName,
                  Materia: 'Portugu√™s',
                  Atividade: 'Construtor de Hist√≥rias',
                  Bloco: 'N/A',
                  Questao: `historia_${totalStories + 1}`,
                  Tempo_Execucao: `${time}s`,
                  Acertos: 1, Erros: 0, Score: '100%'
              });

              setTimeout(() => setShowFeedback(false), 3000);
            } catch (error) {
              console.error("‚ùå Error in generateStory:", error);
              setGeneratedStory(`Erro ao gerar hist√≥ria: ${error.message}`);
              setIsGenerating(false);
            }
          };


          useEffect(() => {
              // Initialize VariableProximity effects for game screen
              if (window.VariableProximityEffect) {
                  const titles = document.querySelectorAll('[data-proximity]');
                  titles.forEach(title => {
                      if (!title.proximityEffect) {
                          title.proximityEffect = new VariableProximityEffect(title);
                      }
                  });
              }
          }, []);

          return (
            <div className="max-w-full mx-auto">
                <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-4 mb-6 flex items-center justify-between">
                    <div>
                        <h1 className="text-2xl font-black" data-proximity data-radius="150" data-from-font-variation-settings="'wght' 300, 'opsz' 9" data-to-font-variation-settings="'wght' 900, 'opsz' 50" data-falloff="exponential">Construtor de Hist√≥rias</h1>
                        <p className="text-sm mt-1">Hist√≥rias criadas: {totalStories} üìö</p>
                    </div>
                    <div>
                        <button onClick={downloadCSV} className="px-4 py-2 bg-blue-600 text-white rounded-lg mr-2">Baixar CSV</button>
                        <button onClick={finishAndDownload} className="px-4 py-2 bg-red-600 text-white rounded-lg">Finalizar</button>
                    </div>
                </div>

                <div className="grid lg:grid-cols-3 gap-6">
                    {/* Coluna 1: Op√ß√µes */}
                    <div className="space-y-4">
                        {categories.map(category => (
                            <div key={category.id} className="bg-white/80 p-4 rounded-2xl text-gray-800">
                                <h3 className={`font-black text-lg mb-3`}>{category.name}</h3>
                                <div className="flex flex-wrap gap-2">
                                    {storyElements[category.id].map(element => (
                                        <div key={element.id} onClick={() => handleSelect(element, category.id)} className={`px-3 py-2 rounded-xl font-bold cursor-pointer transition-all border-2 ${selectedElements[category.id]?.id === element.id ? 'border-purple-600 bg-purple-200' : 'border-gray-200 bg-white'}`}>
                                            {element.emoji} {element.text}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Coluna 2: Sele√ß√£o e Gera√ß√£o */}
                    <div className="bg-white/90 p-6 rounded-2xl text-gray-800">
                        <h2 className="text-2xl font-black mb-4">Sua Sele√ß√£o</h2>
                        <div className="space-y-3 mb-6">
                            {categories.map(category => {
                                const selected = selectedElements[category.id];
                                return (
                                    <div key={category.id} className={`rounded-xl p-3 border-2 ${selected ? `text-white bg-gradient-to-r ${category.color}` : 'bg-gray-100'}`}>
                                        <p className={`font-bold text-sm ${selected ? '' : 'text-gray-500'}`}>{category.name}</p>
                                        {selected ? <p className="font-bold flex items-center gap-2">{selected.emoji} {selected.text}</p> : <p className="text-gray-400 text-xs">Selecione um item</p>}
                                    </div>
                                );
                            })}
                        </div>
                        <div className="space-y-2">
                            <div className="flex items-center justify-center gap-2 text-sm">
                                <span className={`w-3 h-3 rounded-full ${aiReady ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}`}></span>
                                <span className={aiReady ? 'text-green-700' : 'text-gray-500'}>
                                    {aiReady ? 'IA Pronta ‚úì' : 'Inicializando IA...'}
                                </span>
                            </div>
                            <button onClick={generateStory} disabled={!canGenerate || isGenerating || !aiReady} className="w-full h-14 text-lg font-bold bg-yellow-400 text-black rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-yellow-500 transition-colors">
                                {isGenerating ? '‚ú® Gerando Hist√≥ria...' : !aiReady ? '‚è≥ Aguardando IA...' : 'üé® Gerar Hist√≥ria'}
                            </button>
                        </div>
                    </div>

                    {/* Coluna 3: Hist√≥ria Gerada */}
                    <div className="bg-white/90 p-6 rounded-2xl text-gray-800 min-h-[300px] relative">
                        <h2 className="text-2xl font-black mb-4">Sua Hist√≥ria M√°gica</h2>
                        {showFeedback && (
                            <div className="absolute top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg font-bold animate-bounce">
                                +100 pontos! üéâ
                            </div>
                        )}
                        {isGenerating ? (
                            <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div></div>
                        ) : (
                            <div className="bg-gray-100 rounded-xl p-4 shadow-inner whitespace-pre-wrap">{generatedStory || "Aguardando gera√ß√£o..."}</div>
                        )}
                    </div>
                </div>
            </div>
          );
        }
        
        const storyElements = {
          personagens: [ { id: 'p1', text: 'Steve (Minecraft)', emoji: 'üß±' }, { id: 'p3', text: 'Jogador de Roblox', emoji: 'üéÆ' }, { id: 'p4', text: 'YouTuber Famoso', emoji: 'üé¨' } ],
          personalidades: [ { id: 'pe1', text: 'Corajoso', emoji: 'üí™'}, { id: 'pe2', text: 'Engra√ßado', emoji: 'üòÑ'}, { id: 'pe3', text: 'Inteligente', emoji: 'üß†'} ],
          objetivos: [ { id: 'o1', text: 'Encontrar um tesouro', emoji: 'üíé' }, { id: 'o4', text: 'Construir algo incr√≠vel', emoji: 'üèóÔ∏è' }, { id: 'o5', text: 'Descobrir um mist√©rio', emoji: 'üïµÔ∏è' } ],
          antagonistas: [ { id: 'a1', text: 'Creeper explosivo', emoji: 'üí•' }, { id: 'a2', text: 'Hacker misterioso', emoji: 'üë§' }, { id: 'a3', text: 'Drag√£o do End', emoji: 'üêâ' } ],
        };

        const categories = [
          { id: 'personagens', name: 'PERSONAGEM', icon: 'üë§', color: 'from-blue-500 to-cyan-500' },
          { id: 'personalidades', name: 'PERSONALIDADE', icon: '‚ú®', color: 'from-purple-500 to-pink-500' },
          { id: 'objetivos', name: 'OBJETIVO', icon: 'üéØ', color: 'from-green-500 to-emerald-500' },
          { id: 'antagonistas', name: 'ANTAGONISTA', icon: '‚öîÔ∏è', color: 'from-red-500 to-orange-500' },
        ];

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>