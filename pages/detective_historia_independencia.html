<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective da Hist√≥ria - Independ√™ncia</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS:wght@400;700&amp;display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../js/playlist.js"></script>

    <style>
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Regular.otf') format('opentype');
          font-weight: normal; font-style: normal;
        }
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Bold.otf') format('opentype');
          font-weight: bold; font-style: normal;
        }
        body { font-family: 'Comic Sans MS', cursive, sans-serif; }
        .font-dyslexic { font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        

        const MusicPlayer = () => {
            const audioRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(() => localStorage.getItem('musicIsPlaying') === 'true');
            const [currentTrackIndex, setCurrentTrackIndex] = useState(() => parseInt(localStorage.getItem('musicTrackIndex'), 10) || 0);

            useEffect(() => {
                localStorage.setItem('musicIsPlaying', isPlaying);
                if (isPlaying) {
                    audioRef.current.play().catch(e => console.error("Erro ao tocar m√∫sica:", e));
                } else {
                    audioRef.current.pause();
                }
            }, [isPlaying]);

            useEffect(() => {
                localStorage.setItem('musicTrackIndex', currentTrackIndex);
                if (audioRef.current) {
                    audioRef.current.src = backgroundMusicPlaylist[currentTrackIndex];
                    if (isPlaying) {
                        audioRef.current.play().catch(e => console.error("Erro ao tocar m√∫sica:", e));
                    }
                }
            }, [currentTrackIndex]);

            const handleNextTrack = () => {
                setCurrentTrackIndex(prevIndex => (prevIndex + 1) % backgroundMusicPlaylist.length);
            };

            const handleAudioEnded = () => {
                handleNextTrack();
            };

            useEffect(() => {
                const audio = audioRef.current;
                audio.volume = 0.5;
                audio.addEventListener('ended', handleAudioEnded);
                return () => {
                    audio.removeEventListener('ended', handleAudioEnded);
                };
            }, []);

            return (
                <div className="fixed bottom-4 right-4 bg-white/20 backdrop-blur-md text-white p-3 rounded-full shadow-lg flex items-center gap-3 z-50">
                    <audio ref={audioRef} src={backgroundMusicPlaylist[currentTrackIndex]} />
                    <button onClick={() => setIsPlaying(!isPlaying)} className="w-12 h-12 rounded-full bg-white/30 hover:bg-white/50 transition-all flex items-center justify-center">
                        {isPlaying ? '‚ùö‚ùö' : '‚ñ∂'}
                    </button>
                    <button onClick={handleNextTrack} className="w-12 h-12 rounded-full bg-white/30 hover:bg-white/50 transition-all flex items-center justify-center">
                        {'‚è≠'}
                    </button>
                </div>
            );
        };

        // ===================================================================================
        // --- CONFIGURA√á√ÉO DA ATIVIDADE ---
        // ===================================================================================
        const activityConfig = {
            title: "Detective da Hist√≥ria: Independ√™ncia",
            subject: "historia",
            activity: "detective_historia",
            emoji: "üïµÔ∏è",
            primaryColor: "amber",
        };

        const activityBlocks = [
            {
                id: 1,
                title: "O Caso da Independ√™ncia",
                difficulty: "Intermedi√°rio",
                emoji: "üìú",
                color: "from-amber-500 to-red-600",
                description: "Investigue 5 dossi√™s para desvendar os segredos da Independ√™ncia do Brasil.",
                questions: [
                    {
                        id: "misterio_1",
                        year: 1808,
                        code: "MIST√âRIO-001",
                        icon: "üö¢",
                        clues: [
                            "A fam√≠lia de um rei precisou fugir de Napole√£o Bonaparte.",
                            "Eles atravessaram o oceano e trouxeram a corte para o Brasil.",
                            "O Brasil deixou de ser apenas uma col√¥nia e o porto do Rio de Janeiro foi aberto."
                        ],
                        options: [
                            { id: "a", text: "Abertura dos Portos √†s Na√ß√µes Amigas", correct: true },
                            { id: "b", text: "Cria√ß√£o do Reino Unido" },
                            { id: "c", text: "Invas√£o Napole√¥nica no Brasil" }
                        ]
                    },
                    {
                        id: "misterio_2",
                        year: 1821,
                        code: "MIST√âRIO-002",
                        icon: "üëë",
                        clues: [
                            "A fam√≠lia real precisou voltar para Portugal.",
                            "A corte portuguesa queria que o Brasil voltasse a ser apenas uma col√¥nia.",
                            "O pr√≠ncipe herdeiro, Dom Pedro, foi aconselhado a ficar no Brasil."
                        ],
                        options: [
                            { id: "a", text: "O Dia do Fico", correct: true },
                            { id: "b", text: "Regresso Real For√ßado" },
                            { id: "c", text: "Revolu√ß√£o Pernambucana" }
                        ]
                    },
                    {
                        id: "misterio_3",
                        year: 1822,
                        code: "MIST√âRIO-003",
                        icon: "üì¢",
                        clues: [
                            "Um pr√≠ncipe estava viajando por S√£o Paulo.",
                            "Ele recebeu uma carta de Portugal exigindo que voltasse imediatamente.",
                            "√Äs margens de um rio, ele levantou sua espada e gritou 'Independ√™ncia ou Morte!'."
                        ],
                        options: [
                            { id: "a", text: "O Grito do Ipiranga", correct: true },
                            { id: "b", text: "Batalha do Ipiranga" },
                            { id: "c", text: "Revolta Paulista" }
                        ]
                    },
                    {
                        id: "misterio_4",
                        year: 1889,
                        code: "MIST√âRIO-004",
                        icon: "üèõÔ∏è",
                        clues: [
                            "A monarquia do Brasil j√° n√£o era popular.",
                            "Um grupo de militares se juntou a l√≠deres civis para mudar a forma de governo.",
                            "O imperador Dom Pedro II foi deposto e o Brasil se tornou uma Rep√∫blica."
                        ],
                        options: [
                            { id: "a", text: "Proclama√ß√£o da Rep√∫blica", correct: true },
                            { id: "b", text: "Golpe Imperial" },
                            { id: "c", text: "Revolu√ß√£o Federalista" }
                        ]
                    },
                    {
                        id: "misterio_5",
                        year: 1988,
                        code: "MIST√âRIO-005",
                        icon: "‚öñÔ∏è",
                        clues: [
                            "Depois de um longo per√≠odo sem liberdade, o Brasil precisava de novas leis.",
                            "Essa Constitui√ß√£o garantiu muitos direitos importantes, como o voto para todos.",
                            "Por isso, ela √© chamada de 'Constitui√ß√£o Cidad√£'."
                        ],
                        options: [
                            { id: "a", text: "Constitui√ß√£o Federal de 1988", correct: true },
                            { id: "b", text: "Lei √Åurea" },
                            { id: "c", text: "C√≥digo Civil Brasileiro" }
                        ]
                    }
                ]
            }
        ];

        const MediaManager = {
            basePath: '../media',
            getClueAudioPath: (blockId, questionId, clueIndex) => {
                return `${MediaManager.basePath}/audios/${activityConfig.subject}/${activityConfig.activity}/bloco_${blockId}/${questionId}_pista_${clueIndex + 1}.mp3`;
            }
        };

        activityBlocks.forEach(block => {
            block.questions.forEach(q => {
                q.clues = q.clues.map((clueText, index) => ({
                    text: clueText,
                    audio: MediaManager.getClueAudioPath(block.id, q.id, index)
                }));
            });
        });

        const SoundSystem = {
            play: (src) => {
                try {
                    if (window.musicPlayerSetVolume) {
                        window.musicPlayerSetVolume(0.2); // Reduce background music volume
                    }
                    const audio = new Audio(src);
                    audio.play().catch(e => {});
                    audio.onended = () => {
                        if (window.musicPlayerSetVolume) {
                            window.musicPlayerSetVolume(0.5); // Restore background music volume
                        }
                    };
                } catch (e) {}
            },
            success: () => SoundSystem.play(`../media/sons/feedback/acertos/acerto_${Math.ceil(Math.random() * 4)}.mp3`),
            error: () => SoundSystem.play(`../media/sons/feedback/erros/erro_${Math.ceil(Math.random() * 4)}.mp3`),
            click: () => SoundSystem.play('../media/sons/feedback/click.mp3')
        };

        const InitialScreen = ({ onStart, studentName, setStudentName, font, setFont }) => (
            <div className={`min-h-screen bg-gradient-to-br from-${activityConfig.primaryColor}-800 via-orange-900 to-red-900 flex items-center justify-center p-4`}>
                <MusicPlayer />
                <div className="bg-amber-100 rounded-lg shadow-xl p-8 border-4 border-amber-600 max-w-2xl w-full">
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-amber-900 mb-4">{activityConfig.emoji} {activityConfig.title}</h1>
                        <div className="bg-amber-200 rounded-lg p-4 border-2 border-amber-400">
                            <p className="text-lg text-amber-800">MISS√ÉO: Investigar 5 dossi√™s hist√≥ricos e resolver o caso da Independ√™ncia do Brasil.</p>
                        </div>
                    </div>
                    <div className="mb-6">
                        <label className="block text-lg font-semibold text-amber-900 mb-3">üë§ Nome do Detective:</label>
                        <input type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full p-4 border-2 border-amber-400 rounded-lg text-lg focus:border-amber-600" placeholder="Digite seu nome, detetive..." />
                    </div>
                    <div className="flex items-center justify-between my-4">
                        <span className="text-sm font-medium text-amber-900">üî§ Fonte para dislexia:</span>
                        <button onClick={() => { const newFont = font === 'Comic Sans MS' ? 'OpenDyslexic' : 'Comic Sans MS'; setFont(newFont); localStorage.setItem('selectedFont', newFont === 'OpenDyslexic' ? 'dyslexic' : 'normal'); }} className={`px-4 py-2 rounded-lg font-medium transition-all ${font === 'OpenDyslexic' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}`}>
                            {font === 'OpenDyslexic' ? '‚úÖ Ativada' : '‚ö™ Desativada'}
                        </button>
                    </div>
                    <div className="space-y-4 mt-6">
                        <button onClick={() => onStart(studentName)} disabled={!studentName.trim()} className={`w-full py-4 rounded-lg text-xl font-bold transition-all ${studentName.trim() ? 'bg-amber-600 text-white hover:bg-amber-700' : 'bg-gray-400 text-gray-600 cursor-not-allowed'}`}>üîç Iniciar Investiga√ß√£o</button>
                        <a href="../index.html" className="block w-full py-3 text-center bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-lg font-semibold">üè† Voltar ao Portal</a>
                    </div>
                </div>
            </div>
        );
        
        const SummaryScreen = ({ result, onRestart, onBackToInitial }) => (
            <div className="min-h-screen bg-gradient-to-br from-green-400 via-blue-500 to-purple-600 flex items-center justify-center p-4">
                <MusicPlayer />
                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full text-center">
                    <h2 className="text-4xl font-bold mb-4 text-gray-800">üéä Caso Conclu√≠do! üéä</h2>
                    <p className="text-2xl mb-8 text-gray-700">Voc√™ desvendou os mist√©rios do bloco <strong>{result.Bloco}</strong>!</p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-purple-50 rounded-2xl p-6">
                            <div className="text-4xl font-bold text-purple-600">{result.Acertos}</div>
                            <div className="text-lg text-gray-700">Acertos</div>
                        </div>
                        <div className="bg-red-50 rounded-2xl p-6">
                            <div className="text-4xl font-bold text-red-600">{result.Erros}</div>
                            <div className="text-lg text-gray-700">Erros</div>
                        </div>
                        <div className="bg-orange-50 rounded-2xl p-6">
                            <div className="text-4xl font-bold text-orange-600">{result.Tempo_Execucao}</div>
                            <div className="text-lg text-gray-700">Tempo Total</div>
                        </div>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onClick={onRestart} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-2xl text-xl">üîÑ Investigar Novamente</button>
                        <button onClick={onBackToInitial} className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-8 rounded-2xl text-xl">üè† Voltar ao In√≠cio</button>
                    </div>
                </div>
            </div>
        );

        const ActivityScreen = ({ block, onBack, onComplete }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [revealedClues, setRevealedClues] = useState(0);
            const [errors, setErrors] = useState(0);
            const [startTime, setStartTime] = useState(Date.now());
            const [feedback, setFeedback] = useState({ show: false, message: '' });

            const question = block.questions[currentQuestionIndex];

            const revealNextClue = () => {
                if (revealedClues < 3) {
                    SoundSystem.click();
                    setRevealedClues(revealedClues + 1);
                }
            };

            const handleAnswer = (option) => {
                if (revealedClues < 3) return;

                const isCorrect = option.correct === true;
                let updatedErrors = errors;

                if (isCorrect) {
                    SoundSystem.success();
                    setFeedback({ show: true, message: 'Correto!' });
                } else {
                    SoundSystem.error();
                    updatedErrors = errors + 1;
                    setErrors(updatedErrors);
                    setFeedback({ show: true, message: 'Incorreto!' });
                }

                setTimeout(() => {
                    setFeedback({ show: false, message: '' });
                    if (currentQuestionIndex < block.questions.length - 1) {
                        setCurrentQuestionIndex(currentQuestionIndex + 1);
                        setRevealedClues(0);
                    } else {
                        onComplete({ block, acertos: block.questions.length - updatedErrors, erros: updatedErrors, tempoTotal: Math.round((Date.now() - startTime) / 1000) });
                    }
                }, 1500);
            };

            return (
                <div className={`min-h-screen bg-gradient-to-br from-amber-800 via-orange-900 to-red-900 p-4`}>
                    <MusicPlayer />
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-amber-100 rounded-xl border-4 border-amber-600 p-4 mb-6">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl font-bold text-amber-900">{block.emoji} {block.title}</h1>
                                <button onClick={onBack} className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">‚¨ÖÔ∏è Voltar</button>
                            </div>
                            <div className="w-full bg-amber-200 rounded-full h-4 mt-2"><div className={`bg-gradient-to-r from-green-500 to-blue-500 h-full rounded-full`} style={{ width: `${(currentQuestionIndex / block.questions.length) * 100}%` }}></div></div>
                            <div className="text-center font-bold text-amber-800 mt-2">Mist√©rio {currentQuestionIndex + 1} de {block.questions.length}</div>
                        </div>

                        <div className="bg-amber-100 rounded-xl border-4 border-amber-600 p-6">
                            <h2 className="text-2xl font-bold text-amber-900 mb-4">üìã {question.code}</h2>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bg-white p-4 rounded-lg border-2 border-gray-300">
                                    <h3 className="font-bold text-lg text-center mb-2">üîç Pistas</h3>
                                    <div className="space-y-2">
                                        {[...Array(3)].map((_, i) => (
                                            <div key={i} className={`p-3 rounded-lg border-2 ${i < revealedClues ? 'bg-yellow-100 border-yellow-400' : 'bg-gray-100 border-gray-300'}`}>
                                                {i < revealedClues ? (
                                                    <div className="flex items-center justify-between">
                                                        <p className="text-gray-800">{question.clues[i].text}</p>
                                                        <button onClick={() => SoundSystem.play(question.clues[i].audio)} className="ml-2 text-xl">üîä</button>
                                                    </div>
                                                ) : <p className="text-gray-500">Pista {i + 1} Bloqueada</p>}
                                            </div>
                                        ))}
                                    </div>
                                    {revealedClues < 3 && <button onClick={revealNextClue} className="w-full mt-4 py-2 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600">Revelar Pista</button>}
                                </div>
                                <div className="bg-white p-4 rounded-lg border-2 border-gray-300">
                                    <h3 className="font-bold text-lg text-center mb-2">üéØ Solu√ß√£o</h3>
                                    {revealedClues < 3 ? (
                                        <div className="text-center text-gray-500 p-8">Revele todas as pistas para deduzir a solu√ß√£o.</div>
                                    ) : (
                                        <div className="space-y-3">
                                            {question.options.map(opt => <button key={opt.id} onClick={() => handleAnswer(opt)} className="w-full p-3 text-left rounded-lg border-2 border-blue-300 bg-blue-50 hover:bg-blue-100">{opt.text}</button>)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        {feedback.show && <div className="fixed top-10 left-1/2 -translate-x-1/2 text-white font-bold py-3 px-6 rounded-xl shadow-lg z-50 bg-black bg-opacity-70">{feedback.message}</div>}
                    </div>
                </div>
            );
        };

        const AtividadeTemplate = () => {
            const [studentName, setStudentName] = useState(localStorage.getItem('studentName') || '');
            const [font, setFont] = useState(localStorage.getItem('selectedFont') === 'dyslexic' ? 'OpenDyslexic' : 'Comic Sans MS');
            const [currentScreen, setCurrentScreen] = useState('initial');
            const [sessionResults, setSessionResults] = useState([]);
            const [lastResult, setLastResult] = useState(null);

            useEffect(() => {
                document.title = activityConfig.title;
                document.body.className = font === 'OpenDyslexic' ? 'font-dyslexic' : '';
            }, [font]);

            const handleStart = (name) => {
                if (name.trim()) {
                    setStudentName(name);
                    localStorage.setItem('studentName', name);
                    setCurrentScreen('activity');
                }
            };

            const handleCompleteBlock = (result) => {
                const score = Math.round(((result.block.questions.length - result.erros) / result.block.questions.length) * 100);
                const newResult = {
                    Nome: studentName,
                    Materia: activityConfig.subject,
                    Atividade: activityConfig.activity,
                    Bloco: result.block.title,
                    Questao: `${result.block.questions.length}_misterios`,
                    Tempo_Execucao: `${result.tempoTotal}s`,
                    Acertos: result.block.questions.length - result.erros,
                    Erros: result.erros,
                    Score: `${score}%`
                };
                setSessionResults(prev => [...prev, newResult]);
                setLastResult(newResult);
                setCurrentScreen('summary');
            };

            const handleFinishSession = () => {
                if (sessionResults.length === 0) {
                    alert("Nenhuma atividade foi completada para gerar o relat√≥rio.");
                    return;
                }
                const header = 'Nome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score\n';
                const csvContent = sessionResults.map(r => Object.values(r).join(',')).join('\n');
                const blob = new Blob([header + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-') ;
                const studentNameForFile = studentName.replace(/[^a-zA-Z0-9]/g, '_');
                link.download = `${activityConfig.activity}_${studentNameForFile}_${dateStr}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert(`üéâ Dados exportados com sucesso!`);
            };
            
            const restartActivity = () => {
                setCurrentScreen('activity');
            };

            switch (currentScreen) {
                case 'initial':
                    return <InitialScreen onStart={handleStart} studentName={studentName} setStudentName={setStudentName} font={font} setFont={setFont} />;
                case 'activity':
                    return <ActivityScreen block={activityBlocks[0]} onBack={() => setCurrentScreen('initial')} onComplete={handleCompleteBlock} />;
                case 'summary':
                    return <SummaryScreen result={lastResult} onRestart={restartActivity} onBackToInitial={() => setCurrentScreen('initial')} />;
                default:
                    return <InitialScreen onStart={handleStart} studentName={studentName} setStudentName={setStudentName} font={font} setFont={setFont} />;
            }
        };

        ReactDOM.render(<AtividadeTemplate />, document.getElementById('root'));
    </script>
</body>
</html>
