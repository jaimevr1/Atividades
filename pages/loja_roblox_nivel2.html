<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja do Roblox - N√≠vel 2</title>
    
    <!-- Depend√™ncias Padr√£o (React, TailwindCSS, Fontes) -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../js/playlist.js"></script>

    <style>
        /* Defini√ß√£o da fonte local OpenDyslexic */
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Regular.otf') format('opentype');
          font-weight: normal;
          font-style: normal;
        }
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Bold.otf') format('opentype');
          font-weight: bold;
          font-style: normal;
        }
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Italic.otf') format('opentype');
          font-weight: normal;
          font-style: italic;
        }
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('../media/fonts/OpenDyslexic-Bold-Italic.otf') format('opentype');
          font-weight: bold;
          font-style: italic;
        }

        /* Estilos Globais e de Acessibilidade */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        .font-dyslexic {
            font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif;
        }
        /* Anima√ß√µes sutis para feedback */
        .correct-answer-animation {
            animation: pulse-green 0.8s ease-in-out;
        }
        @keyframes pulse-green {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 10px 10px rgba(34, 197, 94, 0); }
        }
        .wrong-answer-animation {
            animation: shake-red 0.5s ease-in-out;
        }
        @keyframes shake-red {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const backgroundMusicPlaylist = [
            '../media/musicas/theme_1.mp3',
            '../media/musicas/theme_2.mp3',
            '../media/musicas/theme_3.mp3'
        ];

        const MusicPlayer = ({ basePath = '../media' }) => {
            const audioRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(() => safeLocalStorage.getItem('musicIsPlaying', false));
            const [currentTrackIndex, setCurrentTrackIndex] = useState(() => 
                safeLocalStorage.getItem('musicTrackIndex', 0)
            );

            // Playlist de m√∫sicas de fundo
            const backgroundMusicPlaylist = [
                `${basePath}/musicas/theme_1.mp3`,
                `${basePath}/musicas/theme_2.mp3`,
                `${basePath}/musicas/theme_3.mp3`
            ];

            useEffect(() => {
                safeLocalStorage.setItem('musicIsPlaying', isPlaying);
                if (isPlaying) {
                    audioRef.current.play().catch(e => console.error("Erro ao tocar m√∫sica:", e));
                } else {
                    audioRef.current.pause();
                }
            }, [isPlaying]);

            useEffect(() => {
                safeLocalStorage.setItem('musicTrackIndex', currentTrackIndex);
                if (audioRef.current) {
                    audioRef.current.src = backgroundMusicPlaylist[currentTrackIndex];
                    if (isPlaying) {
                        audioRef.current.play().catch(e => console.error("Erro ao tocar m√∫sica:", e));
                    }
                }
            }, [currentTrackIndex]);

            const handleNextTrack = () => {
                setCurrentTrackIndex(prevIndex => (prevIndex + 1) % backgroundMusicPlaylist.length);
            };

            const handleAudioEnded = () => {
                handleNextTrack();
            };

            useEffect(() => {
                const audio = audioRef.current;
                if (audio) {
                    audio.volume = 0.5;
                    audio.addEventListener('ended', handleAudioEnded);
                    return () => {
                        audio.removeEventListener('ended', handleAudioEnded);
                    };
                }
            }, []);

            return (
                <div className="fixed bottom-4 right-4 bg-white/20 backdrop-blur-md text-white p-3 rounded-full shadow-lg flex items-center gap-3 z-50">
                    <audio ref={audioRef} src={backgroundMusicPlaylist[currentTrackIndex]} />
                    <button onClick={() => setIsPlaying(!isPlaying)} className="w-12 h-12 rounded-full bg-white/30 hover:bg-white/50 transition-all flex items-center justify-center" aria-label={isPlaying ? "Pausar m√∫sica" : "Tocar m√∫sica"}>
                        {isPlaying ? '‚ùö‚ùö' : '‚ñ∂'}
                    </button>
                    <button onClick={handleNextTrack} className="w-12 h-12 rounded-full bg-white/30 hover:bg-white/50 transition-all flex items-center justify-center" aria-label="Pr√≥xima m√∫sica">
                        {'‚è≠'}
                    </button>
                </div>
            );
        };

        // Componente para exibir uma pergunta e suas op√ß√µes
        const QuestionDisplay = ({ 
            situacao, 
            currentBlock, 
            currentQuestion, 
            showFeedback, 
            isCorrect, 
            feedbackMessage, 
            selectedAnswer,
            onAnswerClick,
            onNextQuestion
        }) => {
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {/* Left side: Context and Fixed Cart */}
                    <div className="space-y-6">
                        <div>
                            <h3 className="text-xl font-bold text-gray-800 mb-2">üìú Contexto</h3>
                            <p className="text-lg text-gray-700 bg-gray-50 p-4 rounded-lg">{situacao.contexto}</p>
                            
                            {/* Controle de √Åudio para Contexto */}
                            <div className="mt-3">
                                <button 
                                    onClick={() => SoundSystem.playContextAudio(situacao)}
                                    className="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                    aria-label="Ouvir o contexto da pergunta"
                                >
                                    üîä Ouvir Contexto
                                </button>
                            </div>
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-gray-800 mb-2">üõí Itens no Carrinho</h3>
                            <div className="space-y-3">
                                {situacao.carrinhoFixo.map(item => (
                                    <div key={item.id} className="flex items-center bg-blue-50 p-3 rounded-lg border-l-4 border-blue-400">
                                        <span className="text-4xl mr-4">{item.emoji}</span>
                                        <div>
                                            <div className="font-bold text-lg text-gray-800">{item.nome}</div>
                                            <div className="text-md text-blue-600 font-semibold">{item.preco} Robux</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Right side: Question and Options */}
                    <div className="space-y-6">
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 p-6 rounded-lg">
                            <h3 className="text-xl font-bold text-yellow-800 mb-3">ü§î Pergunta</h3>
                            <p className="text-lg text-gray-800">{situacao.pergunta}</p>
                            
                            {/* Controle de √Åudio para Enunciado */}
                            <div className="mt-3">
                                <button 
                                    onClick={() => SoundSystem.playStatementAudio(situacao)}
                                    className="bg-yellow-600 text-white px-3 py-1 rounded-lg hover:bg-yellow-700 transition-colors text-sm"
                                    aria-label="Ouvir a pergunta"
                                >
                                    üîä Ouvir Pergunta
                                </button>
                            </div>
                        </div>

                        {!showFeedback ? (
                            <div className="space-y-3">
                                {situacao.opcoes.map(opcao => (
                                    <button 
                                        key={opcao.id} 
                                        onClick={() => { SoundSystem.click(); onAnswerClick(opcao); }}
                                        className="w-full text-left p-4 bg-white rounded-lg border-2 border-gray-300 hover:border-purple-500 hover:bg-purple-50 transition-all transform hover:scale-105"
                                    >
                                        <span className="text-lg font-bold text-purple-700">{opcao.texto}</span>
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <div className={`p-6 rounded-lg border-4 ${isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}`}>
                                <div className="text-6xl mb-4 text-center">{isCorrect ? 'üéâ' : 'ü§î'}</div>
                                <p className="text-lg font-semibold text-gray-800 text-center mb-4">{feedbackMessage}</p>
                                
                                {/* Controle de √Åudio para Explica√ß√£o */}
                                <div className="text-center mb-4">
                                    <button 
                                        onClick={() => SoundSystem.playExplanationAudio(situacao)}
                                        className={`px-4 py-2 rounded-lg text-white transition-colors ${isCorrect ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}
                                        aria-label="Ouvir a explica√ß√£o da resposta"
                                    >
                                        üîä Ouvir Explica√ß√£o
                                    </button>
                                </div>
                                
                                <button onClick={onNextQuestion} className={`w-full py-3 text-white font-bold rounded-lg text-lg ${isCorrect ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}>
                                    {currentQuestion < currentBlock.situacoes.length - 1 ? 'Pr√≥xima Pergunta ‚û°Ô∏è' : 'Ver Resultado üèÜ'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ===================================================================================
        // --- CONFIGURA√á√ÉO DA ATIVIDADE ---
        // ===================================================================================
        // Configura√ß√£o geral da atividade, incluindo t√≠tulo, mat√©ria, e configura√ß√µes visuais
        const activityConfig = {
            title: "Loja do Roblox - N√≠vel 2",
            subject: "Matematica",
            activity: "Loja Roblox Nivel 2",
            emoji: "üéÆ",
            primaryColor: "purple",
        };
        
        // Blocos de atividades com diferentes n√≠veis de dificuldade
        // Cada bloco cont√©m v√°rias situa√ß√µes com perguntas e respostas
        const blocos = [
                {
                  // Bloco 1: Primeiras Compras (N√≠vel F√°cil)
                  // Introduz conceitos b√°sicos de soma e subtra√ß√£o com valores pequenos
                  id: 1,
                  titulo: "Primeiras Compras",
                  subtitulo: "Come√ßando no Roblox",
                  cor: "from-green-400 to-blue-500",
                  dificuldade: "F√°cil",
                  objetivo: "Aquecer com somas simples",
                  robuxInicial: 50,
                  situacoes: [
                    {
                      contexto: "Voc√™ acabou de criar sua conta no Roblox e ganhou 50 Robux de b√¥nus! Hora de personalizar seu avatar.",
                      pergunta: "Compre uma camisa (10 Robux) e um chap√©u (15 Robux). Quanto voc√™ gastar√° no total?",
                      carrinhoFixo: [
                        { id: 1, nome: "Camisa B√°sica", preco: 10, emoji: "üëï" },
                        { id: 2, nome: "Chap√©u Legal", preco: 15, emoji: "üé©" }
                      ],
                      opcoes: [
                        { id: 1, valor: 20, texto: "20 Robux" },
                        { id: 2, valor: 25, texto: "25 Robux" },
                        { id: 3, valor: 30, texto: "30 Robux" },
                        { id: 4, valor: 15, texto: "15 Robux" }
                      ],
                      respostaCorreta: 25,
                      dica: "Some os pre√ßos dos itens no carrinho: 10 + 15 = ?"
                    },
                    {
                      contexto: "Seu avatar est√° ficando massa! Agora voc√™ quer adicionar √≥culos para ficar ainda mais estiloso.",
                      pergunta: "Compre os √≥culos (8 Robux). Somando com suas compras anteriores, quanto gastou no total?",
                      carrinhoFixo: [
                        { id: 1, nome: "Camisa B√°sica", preco: 10, emoji: "üëï" },
                        { id: 2, nome: "Chap√©u Legal", preco: 15, emoji: "üé©" },
                        { id: 3, nome: "√ìculos Cool", preco: 8, emoji: "üï∂Ô∏è" }
                      ],
                      opcoes: [
                        { id: 1, valor: 28, texto: "28 Robux" },
                        { id: 2, valor: 33, texto: "33 Robux" },
                        { id: 3, valor: 38, texto: "38 Robux" },
                        { id: 4, valor: 23, texto: "23 Robux" }
                      ],
                      respostaCorreta: 33,
                      dica: "Voc√™ j√° gastou 25 Robux. Agora adicione mais 8 Robux dos √≥culos: 25 + 8 = ?"
                    },
                    {
                      contexto: "Voc√™ quer saber se ainda tem dinheiro para comprar outras coisas legais.",
                      pergunta: "Voc√™ tinha 50 Robux e j√° gastou 33. Quantos Robux sobraram?",
                      carrinhoFixo: [
                        { id: 1, nome: "Dinheiro Gasto", preco: 33, emoji: "üí∏" }
                      ],
                      opcoes: [
                        { id: 1, valor: 17, texto: "17 Robux" },
                        { id: 2, valor: 12, texto: "12 Robux" },
                        { id: 3, valor: 22, texto: "22 Robux" },
                        { id: 4, valor: 15, texto: "15 Robux" }
                      ],
                      respostaCorreta: 17,
                      dica: "Calcule quanto sobrou: 50 - 33 = ?",
                      tipoCalculo: "sobra",
                      dinheiroInicial: 50
                    },
                    {
                      contexto: "Legal! Voc√™ descobriu que ainda pode comprar mais coisas! Vamos ver se d√° para comprar os t√™nis.",
                      pergunta: "Adicione os t√™nis (12 Robux) ao seu carrinho. Quanto voc√™ gastar√° no total at√© agora?",
                      carrinhoFixo: [
                        { id: 1, nome: "Camisa B√°sica", preco: 10, emoji: "üëï" },
                        { id: 2, nome: "Chap√©u Legal", preco: 15, emoji: "üé©" },
                        { id: 3, nome: "√ìculos Cool", preco: 8, emoji: "üï∂Ô∏è" },
                        { id: 4, nome: "T√™nis Bacana", preco: 12, emoji: "üëü" }
                      ],
                      opcoes: [
                        { id: 1, valor: 40, texto: "40 Robux" },
                        { id: 2, valor: 45, texto: "45 Robux" },
                        { id: 3, valor: 50, texto: "50 Robux" },
                        { id: 4, valor: 35, texto: "35 Robux" }
                      ],
                      respostaCorreta: 45,
                      dica: "Some tudo que voc√™ comprou: 33 + 12 = ?"
                    },
                    {
                      contexto: "Parab√©ns! Voc√™ montou seu primeiro look completo no Roblox! Agora vamos ver quanto dinheiro sobrou.",
                      pergunta: "Depois de gastar 45 Robux dos seus 50 Robux iniciais, quantos sobraram?",
                      carrinhoFixo: [
                        { id: 1, nome: "Total Gasto", preco: 45, emoji: "üí∏" }
                      ],
                      opcoes: [
                        { id: 1, valor: 3, texto: "3 Robux" },
                        { id: 2, valor: 5, texto: "5 Robux" },
                        { id: 3, valor: 8, texto: "8 Robux" },
                        { id: 4, valor: 10, texto: "10 Robux" }
                      ],
                      respostaCorreta: 5,
                      dica: "Quanto sobrou da sua carteira: 50 - 45 = ?",
                      tipoCalculo: "sobra",
                      dinheiroInicial: 50
                    }
                  ]
                },
                {
                  // Bloco 2: Loja de Pets (N√≠vel M√©dio)
                  // Explora problemas com valores maiores, envolvendo tr√™s ou mais itens
                  id: 2,
                  titulo: "Loja de Pets",
                  subtitulo: "Adotando companheiros virtuais",
                  cor: "from-purple-500 to-pink-500",
                  dificuldade: "M√©dio",
                  objetivo: "Resolver problemas com valores maiores",
                  robuxInicial: 150,
                  situacoes: [
                    {
                      contexto: "Voc√™ entrou na loja de pets do Roblox! Tem 150 Robux para adotar bichinhos fofinhos.",
                      pergunta: "Compre um cachorro (45 Robux) e um gato (38 Robux). Quanto voc√™ gastar√°?",
                      carrinhoFixo: [
                        { id: 1, nome: "Cachorro Dourado", preco: 45, emoji: "üê∂" },
                        { id: 2, nome: "Gato Fofo", preco: 38, emoji: "üê±" }
                      ],
                      opcoes: [
                        { id: 1, valor: 75, texto: "75 Robux" },
                        { id: 2, valor: 83, texto: "83 Robux" },
                        { id: 3, valor: 90, texto: "90 Robux" },
                        { id: 4, valor: 78, texto: "78 Robux" }
                      ],
                      respostaCorreta: 83,
                      dica: "Some os pre√ßos dos pets: 45 + 38 = ?"
                    },
                    {
                      contexto: "Seus pets est√£o adorando brincar juntos! Agora voc√™ quer adicionar um coelho para completar a fam√≠lia.",
                      pergunta: "Adicione o coelho (32 Robux) aos seus pets. Quanto voc√™ ter√° gasto no total?",
                      carrinhoFixo: [
                        { id: 1, nome: "Cachorro Dourado", preco: 45, emoji: "üê∂" },
                        { id: 2, nome: "Gato Fofo", preco: 38, emoji: "üê±" },
                        { id: 3, nome: "Coelho Saltitante", preco: 32, emoji: "üê∞" }
                      ],
                      opcoes: [
                        { id: 1, valor: 110, texto: "110 Robux" },
                        { id: 2, valor: 115, texto: "115 Robux" },
                        { id: 3, valor: 120, texto: "120 Robux" },
                        { id: 4, valor: 105, texto: "105 Robux" }
                      ],
                      respostaCorreta: 115,
                      dica: "Voc√™ j√° gastou 83 Robux. Adicione mais 32 Robux: 83 + 32 = ?"
                    },
                    {
                      contexto: "Voc√™ quer saber se ainda tem dinheiro para comprar comida e brinquedos para seus pets.",
                      pergunta: "Dos seus 150 Robux iniciais, quantos sobraram ap√≥s gastar 115?",
                      carrinhoFixo: [
                        { id: 1, nome: "Total Gasto", preco: 115, emoji: "üí∏" }
                      ],
                      opcoes: [
                        { id: 1, valor: 30, texto: "30 Robux" },
                        { id: 2, valor: 35, texto: "35 Robux" },
                        { id: 3, valor: 40, texto: "40 Robux" },
                        { id: 4, valor: 25, texto: "25 Robux" }
                      ],
                      respostaCorreta: 35,
                      dica: "Calcule: 150 - 115 = ?",
                      tipoCalculo: "sobra",
                      dinheiroInicial: 150
                    },
                    {
                      contexto: "Seus pets est√£o com fome! Voc√™ decidiu comprar comida premium para eles.",
                      pergunta: "Adicione a comida premium (35 Robux). Quanto voc√™ ter√° gasto no total?",
                      carrinhoFixo: [
                        { id: 1, nome: "Cachorro Dourado", preco: 45, emoji: "üê∂" },
                        { id: 2, nome: "Gato Fofo", preco: 38, emoji: "üê±" },
                        { id: 3, nome: "Coelho Saltitante", preco: 32, emoji: "üê∞" },
                        { id: 4, nome: "Comida Premium", preco: 35, emoji: "üçñ" }
                      ],
                      opcoes: [
                        { id: 1, valor: 145, texto: "145 Robux" },
                        { id: 2, valor: 150, texto: "150 Robux" },
                        { id: 3, valor: 155, texto: "155 Robux" },
                        { id: 4, valor: 140, texto: "140 Robux" }
                      ],
                      respostaCorreta: 150,
                      dica: "Some todas as suas compras: 115 + 35 = ?"
                    },
                    {
                      contexto: "Incr√≠vel! Voc√™ gastou exatamente todos os seus Robux cuidando bem dos seus pets!",
                      pergunta: "Depois de gastar 150 Robux dos seus 150 Robux iniciais, quantos sobraram?",
                      carrinhoFixo: [
                        { id: 1, nome: "Total Gasto", preco: 150, emoji: "üí∏" }
                      ],
                      opcoes: [
                        { id: 1, valor: 0, texto: "0 Robux" },
                        { id: 2, valor: 5, texto: "5 Robux" },
                        { id: 3, valor: 10, texto: "10 Robux" },
                        { id: 4, valor: 15, texto: "15 Robux" }
                      ],
                      respostaCorreta: 0,
                      dica: "Voc√™ gastou tudo: 150 - 150 = ?",
                      tipoCalculo: "sobra",
                      dinheiroInicial: 150
                    }
                  ]
                },
                {
                  // Bloco 3: Parque de Divers√µes (N√≠vel Avan√ßado)
                  // Desafios complexos com or√ßamento maior e m√∫ltiplas decis√µes de compra
                  id: 3,
                  titulo: "Parque de Divers√µes",
                  subtitulo: "Ingressos e brinquedos",
                  cor: "from-red-500 to-orange-600",
                  dificuldade: "Avan√ßado",
                  objetivo: "Gerenciar or√ßamento com valores maiores",
                  robuxInicial: 200,
                  situacoes: [
                    {
                      contexto: "Voc√™ chegou no parque de divers√µes do Roblox! Tem 200 Robux para se divertir o dia todo.",
                      pergunta: "Compre o ingresso do parque (85 Robux) e um lanche (67 Robux). Quanto voc√™ gastar√°?",
                      carrinhoFixo: [
                        { id: 1, nome: "Ingresso VIP", preco: 85, emoji: "üéüÔ∏è" },
                        { id: 2, nome: "Combo Lanche", preco: 67, emoji: "üçî" }
                      ],
                      opcoes: [
                        { id: 1, valor: 145, texto: "145 Robux" },
                        { id: 2, valor: 152, texto: "152 Robux" },
                        { id: 3, valor: 160, texto: "160 Robux" },
                        { id: 4, valor: 138, texto: "138 Robux" }
                      ],
                      respostaCorreta: 152,
                      dica: "Some o ingresso e o lanche: 85 + 67 = ?"
                    },
                    {
                      contexto: "Depois do lanche, voc√™ quer andar na montanha-russa! Mas primeiro precisa de um refrigerante para se refrescar.",
                      pergunta: "Adicione um refrigerante (25 Robux). Quanto voc√™ ter√° gasto no total?",
                      carrinhoFixo: [
                        { id: 1, nome: "Ingresso VIP", preco: 85, emoji: "üéüÔ∏è" },
                        { id: 2, nome: "Combo Lanche", preco: 67, emoji: "üçî" },
                        { id: 3, nome: "Refrigerante", preco: 25, emoji: "ü•§" }
                      ],
                      opcoes: [
                        { id: 1, valor: 170, texto: "170 Robux" },
                        { id: 2, valor: 177, texto: "177 Robux" },
                        { id: 3, valor: 185, texto: "185 Robux" },
                        { id: 4, valor: 162, texto: "162 Robux" }
                      ],
                      respostaCorreta: 177,
                      dica: "Voc√™ j√° gastou 152 Robux. Adicione mais 25: 152 + 25 = ?"
                    },
                    {
                      contexto: "Agora voc√™ quer saber se ainda tem dinheiro suficiente para comprar souvenirs na sa√≠da.",
                      pergunta: "Dos seus 200 Robux iniciais, quantos sobraram depois de gastar 177?",
                      carrinhoFixo: [
                        { id: 1, nome: "Total Gasto", preco: 177, emoji: "üí∏" }
                      ],
                      opcoes: [
                        { id: 1, valor: 18, texto: "18 Robux" },
                        { id: 2, valor: 23, texto: "23 Robux" },
                        { id: 3, valor: 28, texto: "28 Robux" },
                        { id: 4, valor: 33, texto: "33 Robux" }
                      ],
                      respostaCorreta: 23,
                      dica: "Calcule: 200 - 177 = ?",
                      tipoCalculo: "sobra",
                      dinheiroInicial: 200
                    },
                    {
                      contexto: "Legal! Voc√™ ainda tem dinheiro para comprar um im√£ de lembran√ßa do parque.",
                      pergunta: "Adicione o im√£ (23 Robux) √†s suas compras. Quanto voc√™ ter√° gasto no total?",
                      carrinhoFixo: [
                        { id: 1, nome: "Ingresso VIP", preco: 85, emoji: "üéüÔ∏è" },
                        { id: 2, nome: "Combo Lanche", preco: 67, emoji: "üçî" },
                        { id: 3, nome: "Refrigerante", preco: 25, emoji: "ü•§" },
                        { id: 4, nome: "Im√£", preco: 23, emoji: "üß¢" }
                      ],
                      opcoes: [
                        { id: 1, valor: 195, texto: "195 Robux" },
                        { id: 2, valor: 200, texto: "200 Robux" },
                        { id: 3, valor: 205, texto: "205 Robux" },
                        { id: 4, valor: 190, texto: "190 Robux" }
                      ],
                      respostaCorreta: 200,
                      dica: "Some todas as suas compras: 177 + 23 = ?"
                    },
                    {
                      contexto: "Perfeito! Voc√™ aproveitou o parque ao m√°ximo e gastou exatamente todo o seu dinheiro!",
                      pergunta: "Depois de gastar 200 Robux dos seus 200 Robux iniciais, quantos sobraram?",
                      carrinhoFixo: [
                        { id: 1, nome: "Total Gasto", preco: 200, emoji: "üí∏" }
                      ],
                      opcoes: [
                        { id: 1, valor: 0, texto: "0 Robux" },
                        { id: 2, valor: 5, texto: "5 Robux" },
                        { id: 3, valor: 10, texto: "10 Robux" },
                        { id: 4, valor: 15, texto: "15 Robux" }
                      ],
                      respostaCorreta: 0,
                      dica: "Voc√™ gastou exatamente tudo: 200 - 200 = ?",
                      tipoCalculo: "sobra",
                      dinheiroInicial: 200
                    }
                  ]
                }
            ];
        // ===================================================================================
        // --- FIM DA CONFIGURA√á√ÉO ---
        // ===================================================================================

        // Componente para exibir a tela de sele√ß√£o de blocos
        const BlockSelectionScreen = ({ 
            studentName, 
            blocos, 
            completedBlocks, 
            onBackToStart, 
            onFinalizeSession, 
            onSelectBlock 
        }) => {
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 via-purple-600 to-pink-600 p-4">
                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 mb-6 shadow-lg">
                        <div className="flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-purple-600">üëã Ol√°, {studentName}!</h2>
                                <p className="text-gray-600">Escolha seu pr√≥ximo desafio!</p>
                            </div>
                            <div className="flex space-x-3">
                                <button onClick={onBackToStart} className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all">
                                    üè† In√≠cio
                                </button>
                                <button onClick={onFinalizeSession} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-bold">
                                    üìä Finalizar Sess√£o e Baixar CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div className="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
                        {blocos.map((bloco) => (
                            <div key={bloco.id} className={`bg-gradient-to-br ${bloco.cor} rounded-2xl p-6 text-white shadow-2xl hover:scale-105 transition-all duration-300`}>
                                <h3 className="text-2xl font-bold mb-1">{bloco.titulo}</h3>
                                <p className="text-sm opacity-90 mb-2">{bloco.subtitulo}</p>
                                <div className="inline-block bg-white/20 rounded-full px-3 py-1 text-xs font-bold mt-2">{bloco.dificuldade}</div>
                                {completedBlocks.includes(bloco.id) && <div className="text-2xl mt-2">‚úÖ CONCLU√çDO</div>}
                                <div className="bg-white/10 rounded-lg p-4 my-4">
                                    <p className="text-sm font-semibold mb-2">üéØ Objetivo:</p>
                                    <p className="text-sm">{bloco.objetivo}</p>
                                </div>
                                <button onClick={() => onSelectBlock(bloco)} className="w-full py-3 bg-white text-gray-800 font-bold rounded-lg hover:bg-gray-100 transition-all">
                                    {completedBlocks.includes(bloco.id) ? 'üîÑ Jogar Novamente' : 'üéÆ Come√ßar'}
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ===================================================================================
        // --- SISTEMA DE GERENCIAMENTO DE M√çDIA ---
        // Gerencia caminhos e carregamento de arquivos de √°udio e imagens
        // ===================================================================================
        const MediaManager = {
            basePath: '../media',
            subject: 'matematica',
            activity: 'loja_roblox_nivel2',
            
            getQuestionMedia: function(blockNum, questionNum) {
                const blockPath = `${this.basePath}/audios/${this.subject}/${this.activity}/bloco_${String(blockNum).padStart(2, '0')}`;
                return {
                    audio: {
                        contexto: `${blockPath}/questao_${questionNum}_contexto.mp3`,
                        enunciado: `${blockPath}/questao_${questionNum}_enunciado.mp3`,
                        explicacao: `${blockPath}/questao_${questionNum}_explicacao.mp3`
                    },
                    images: {
                        ilustracao: `${blockPath}/imagens/questao_${questionNum}_ilustracao.png`
                    }
                };
            }
        };
        
        // Adiciona a propriedade 'media' a cada quest√£o dinamicamente
        blocos.forEach(block => {
            block.situacoes.forEach((situacao, index) => {
                situacao.media = MediaManager.getQuestionMedia(block.id, index + 1);
            });
        });

        // ===================================================================================
        // --- SISTEMA DE FEEDBACK SONORO ---
        // Gerencia reprodu√ß√£o de sons e efeitos sonoros da atividade
        // ===================================================================================
        const SoundSystem = {
            // Preloaded audio elements cache
            audioCache: new Map(),
            
            // Preload audio files
            preload: (src) => {
                if (!src || this.audioCache.has(src)) return;
                
                try {
                    const audio = new Audio();
                    audio.src = src;
                    // Don't play, just load
                    audio.preload = 'auto';
                    this.audioCache.set(src, audio);
                } catch (e) {
                    console.warn("Falha ao pr√©-carregar √°udio:", src, e);
                }
            },
            
            play: (src) => {
                try {
                    if (!src) {
                        console.warn("Nenhuma fonte de √°udio fornecida");
                        return;
                    }
                    
                    if (window.musicPlayerSetVolume) {
                        window.musicPlayerSetVolume(0.2); // Reduce background music volume
                    }
                    const audio = new Audio(src);
                    audio.play().catch(e => console.warn("Reprodu√ß√£o de √°udio bloqueada pelo navegador."));
                    audio.onended = () => {
                        if (window.musicPlayerSetVolume) {
                            window.musicPlayerSetVolume(0.5); // Restore background music volume
                        }
                    };
                } catch (e) {
                    console.error("Erro ao tentar tocar o som:", src, e);
                }
            },
            success: () => {
                const soundId = Math.floor(Math.random() * 3) + 1;
                SoundSystem.play(`../media/sons/feedback/acertos/acerto_${soundId}.mp3`);
            },
            error: () => {
                const soundId = Math.floor(Math.random() * 3) + 1;
                SoundSystem.play(`../media/sons/feedback/erros/erro_${soundId}.mp3`);
            },
            click: () => {
                SoundSystem.play('../media/sons/feedback/click.mp3');
            },
            playContextAudio: (situacao) => {
                if (situacao && situacao.media && situacao.media.audio && situacao.media.audio.contexto) {
                    SoundSystem.play(situacao.media.audio.contexto);
                } else {
                    console.warn("√Åudio de contexto n√£o encontrado para esta situa√ß√£o");
                }
            },
            playExplanationAudio: (situacao) => {
                if (situacao && situacao.media && situacao.media.audio && situacao.media.audio.explicacao) {
                    SoundSystem.play(situacao.media.audio.explicacao);
                } else {
                    console.warn("√Åudio de explica√ß√£o n√£o encontrado para esta situa√ß√£o");
                }
            },
            playStatementAudio: (situacao) => {
                if (situacao && situacao.media && situacao.media.audio && situacao.media.audio.enunciado) {
                    SoundSystem.play(situacao.media.audio.enunciado);
                } else {
                    console.warn("√Åudio de enunciado n√£o encontrado para esta situa√ß√£o");
                }
            },
            
            // Preload all audio files for a question
            preloadQuestionAudio: (situacao) => {
                if (situacao && situacao.media && situacao.media.audio) {
                    const { contexto, enunciado, explicacao } = situacao.media.audio;
                    if (contexto) SoundSystem.preload(contexto);
                    if (enunciado) SoundSystem.preload(enunciado);
                    if (explicacao) SoundSystem.preload(explicacao);
                }
            }
        };

        // Componente para exibir a tela inicial
        const StartScreen = ({ 
            studentName, 
            setStudentName, 
            onStart 
        }) => {
            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 flex items-center justify-center p-4">
                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                        <div className="text-6xl mb-4">üéÆ</div>
                        <h1 className="text-4xl font-bold text-purple-600 mb-2">Loja do Roblox - N√≠vel 2</h1>
                        <p className="text-lg text-gray-600 mb-6">Resolva problemas e gerencie seu or√ßamento de Robux!</p>
                        <input
                            type="text"
                            placeholder="Digite seu nome"
                            value={studentName}
                            onChange={(e) => setStudentName(e.target.value)}
                            className="w-full p-4 border-2 border-purple-300 rounded-lg text-xl mb-6 text-center font-bold"
                            aria-label="Digite seu nome para come√ßar a atividade"
                        />
                        <button onClick={onStart} disabled={!studentName.trim()} className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-xl rounded-lg hover:scale-105 transition-all duration-300 shadow-lg disabled:opacity-50">
                            üöÄ Come√ßar Aventura!
                        </button>
                        <a href="../index.html" className="block w-full mt-4 px-6 py-3 text-center bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-lg font-semibold">
                            ‚Üê Voltar ao Portal
                        </a>
                    </div>
                </div>
            );
        };

        // Componente para exibir a tela de resultados
        const ResultsScreen = ({ 
            studentName, 
            score, 
            totalQuestions, 
            onChooseNewBlock 
        }) => {
            const percentage = Math.round((score / totalQuestions) * 100);
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-4 flex items-center justify-center">
                    <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-xl p-8 text-center">
                        <h1 className="text-4xl font-bold mb-4 text-gray-800">üéä Parab√©ns, {studentName}! üéä</h1>
                        <div className="text-8xl mb-6">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üåü' : 'üí™'}</div>
                        <div className="bg-gray-50 rounded-lg p-6 mb-6">
                            <p className="text-3xl font-bold text-gray-800 mb-2">{score} de {totalQuestions} acertos</p>
                            <p className="text-xl text-gray-600 mb-4">{percentage}% de aproveitamento</p>
                        </div>
                        <button onClick={onChooseNewBlock} className="w-full px-8 py-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-xl font-bold">
                            üéØ Escolher Novo Bloco
                        </button>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        const LojaRobloxNivel2 = () => {
            const [studentName, setStudentName] = useState('');
            const [selectedFont, setSelectedFont] = useState(() => 
                safeLocalStorage.getItem('selectedFont', 'comic')
            );
            const [currentPhase, setCurrentPhase] = useState('inicio'); // inicio, selecao, jogo, resultado
            const [currentBlock, setCurrentBlock] = useState(null);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [feedbackMessage, setFeedbackMessage] = useState('');
            const [isCorrect, setIsCorrect] = useState(false);
            const [score, setScore] = useState(0);
            const [quizCompleted, setQuizCompleted] = useState(false);
            const [sessionResults, setSessionResults] = useState(() => 
                safeLocalStorage.getItem('robloxShopSessionResults', [])
            );
            const [startTime, setStartTime] = useState(null);
            const [completedBlocks, setCompletedBlocks] = useState([]);

            useEffect(() => {
                if (currentPhase === 'jogo' && !startTime) {
                    setStartTime(Date.now());
                }
            }, [currentPhase, startTime]);

            const getFontStyle = () => ({
                fontFamily: selectedFont === 'dyslexic' ? "'OpenDyslexic', sans-serif" : "'Comic Sans MS', cursive"
            });
            
            // Save font preference to localStorage
            useEffect(() => {
                safeLocalStorage.setItem('selectedFont', selectedFont);
            }, [selectedFont]);

            const handleStartName = () => {
                if (studentName.trim()) {
                    SoundSystem.click();
                    setCurrentPhase('selecao');
                }
            };

            const selecionarBloco = (bloco) => {
                SoundSystem.click();
                setCurrentBlock(bloco);
                setCurrentQuestion(0);
                setSelectedAnswer(null);
                setScore(0);
                setQuizCompleted(false);
                setShowFeedback(false);
                setCurrentPhase('jogo');
                setStartTime(Date.now());
            };

            const handleAnswerClick = (opcao) => {
                setSelectedAnswer(opcao);
                const situacao = currentBlock.situacoes[currentQuestion];
                const correct = opcao.valor === situacao.respostaCorreta;
                setIsCorrect(correct);
                
                // Play sound feedback
                if (correct) {
                    SoundSystem.success();
                    setScore(prev => prev + 1);
                    setFeedbackMessage("‚úÖ Perfeito! Voc√™ calculou certinho! üéâ");
                } else {
                    SoundSystem.error();
                    setFeedbackMessage(`‚ùå Quase l√°! A resposta correta era ${situacao.respostaCorreta} Robux. ${situacao.dica}`);
                }
                
                setShowFeedback(true);
            };

            const proximaPergunta = () => {
                setShowFeedback(false);
                setSelectedAnswer(null);
                if (currentQuestion < currentBlock.situacoes.length - 1) {
                    setCurrentQuestion(currentQuestion + 1);
                    setStartTime(Date.now());
                } else {
                    setQuizCompleted(true);
                }
            };
            
            const saveResult = () => {
                const timeSpent = Math.round((Date.now() - startTime) / 1000);
                const result = {
                    Nome: studentName,
                    Materia: 'Matematica',
                    Atividade: 'Loja Roblox Nivel 2',
                    Bloco: currentBlock.titulo,
                    Questao: `${currentBlock.titulo}_5_questoes`,
                    Tempo_Execucao: `${timeSpent}s`,
                    Acertos: score,
                    Erros: currentBlock.situacoes.length - score,
                    Score: `${Math.round((score / currentBlock.situacoes.length) * 100)}%`
                };
                const updatedResults = [...sessionResults, result];
                setSessionResults(updatedResults);
                safeLocalStorage.setItem('robloxShopSessionResults', updatedResults);
            };
            
            // Helper function to safely access localStorage
            const safeLocalStorage = {
                getItem: (key, defaultValue = null) => {
                    try {
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : defaultValue;
                    } catch (e) {
                        console.warn(`Erro ao acessar localStorage[${key}]:`, e);
                        return defaultValue;
                    }
                },
                setItem: (key, value) => {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                        return true;
                    } catch (e) {
                        console.warn(`Erro ao salvar em localStorage[${key}]:`, e);
                        return false;
                    }
                },
                removeItem: (key) => {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (e) {
                        console.warn(`Erro ao remover localStorage[${key}]:`, e);
                        return false;
                    }
                }
            };

            const finalizarSessao = () => {
                const resultsToExport = safeLocalStorage.getItem('robloxShopSessionResults', []);
                if (resultsToExport.length === 0) {
                    alert('Nenhum dado para exportar! Jogue pelo menos um bloco.');
                    return;
                }

                const header = 'ÔªøNome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score\n';
                const csvContent = resultsToExport.map(r => `${r.Nome},${r.Materia},${r.Atividade},${r.Bloco},${r.Questao},${r.Tempo_Execucao},${r.Acertos},${r.Erros},${r.Score}`).join('\n');
                const fullContent = header + csvContent;

                const blob = new Blob([fullContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const studentNameForFile = studentName.replace(/[^a-zA-Z0-9√Ä-√ø\s\-_]/g, '_').replace(/\s+/g, '_');
                const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-') ;
                link.setAttribute('href', url);
                link.setAttribute('download', `resultados-loja_roblox-${dateStr}-${studentNameForFile}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                safeLocalStorage.removeItem('robloxShopSessionResults');
                setSessionResults([]);
                setStudentName('');
                setCurrentPhase('inicio');
            };

            if (currentPhase === 'inicio') {
                return (
                    <div style={getFontStyle()}>
                        <MusicPlayer basePath="../media" />
                        <StartScreen 
                            studentName={studentName}
                            setStudentName={setStudentName}
                            onStart={handleStartName}
                        />
                    </div>
                );
            }

            if (currentPhase === 'selecao') {
                return (
                    <div style={getFontStyle()}>
                        <MusicPlayer basePath="../media" />
                        <BlockSelectionScreen 
                            studentName={studentName}
                            blocos={blocos}
                            completedBlocks={completedBlocks}
                            onBackToStart={() => { SoundSystem.click(); setCurrentPhase('inicio'); }}
                            onFinalizeSession={() => { SoundSystem.click(); finalizarSessao(); }}
                            onSelectBlock={selecionarBloco}
                        />
                    </div>
                );
            }

            if (quizCompleted) {
                return (
                    <div style={getFontStyle()}>
                        <MusicPlayer basePath="../media" />
                        <ResultsScreen 
                            studentName={studentName}
                            score={score}
                            totalQuestions={currentBlock.situacoes.length}
                            onChooseNewBlock={() => { saveResult(); setCurrentPhase('selecao'); }}
                        />
                    </div>
                );
            }

            if (currentPhase === 'jogo') {
                const situacao = currentBlock.situacoes[currentQuestion];
                
                // Preload audio files for this question
                useEffect(() => {
                    SoundSystem.preloadQuestionAudio(situacao);
                }, [currentQuestion]);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 p-4 flex items-center justify-center" style={getFontStyle()}>
                        <MusicPlayer basePath="../media" />
                        <div className="w-full max-w-4xl mx-auto">
                            <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-purple-700">{currentBlock.titulo}</h2>
                                    <span className="text-lg font-semibold text-gray-600">Quest√£o {currentQuestion + 1} de {currentBlock.situacoes.length}</span>
                                </div>
                            </div>

                            <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                                <QuestionDisplay 
                                    situacao={situacao}
                                    currentBlock={currentBlock}
                                    currentQuestion={currentQuestion}
                                    showFeedback={showFeedback}
                                    isCorrect={isCorrect}
                                    feedbackMessage={feedbackMessage}
                                    selectedAnswer={selectedAnswer}
                                    onAnswerClick={handleAnswerClick}
                                    onNextQuestion={proximaPergunta}
                                />
                            </div>
                        </div>
                    </div>
                );
            }
        };

        ReactDOM.render(<LojaRobloxNivel2 />, document.getElementById('root'));
    </script>
</body>
</html>