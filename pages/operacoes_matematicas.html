<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Identificação de Operações Matemáticas</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fuzzy+Bubbles:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Database Integration -->
    <script src="../src/data/questionDatabase.js"></script>
    <script src="../src/config/activityMapping.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .font-comic { font-family: 'Comic Neue', 'Comic Sans MS', cursive; }
        .font-bubble { font-family: 'Fuzzy Bubbles', cursive; }
        .font-comic-lg { font-family: 'Comic Neue', 'Comic Sans MS', cursive; font-size: 1.125rem; }
        .font-dyslexic { font-family: 'Comic Neue', 'Comic Sans MS', cursive; font-size: 1.25rem; line-height: 1.6; }
        .celebration-animation {
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0,-30px,0);
            }
            70% {
                transform: translate3d(0,-15px,0);
            }
            90% {
                transform: translate3d(0,-4px,0);
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div class="spinner"></div>
            Carregando Quiz...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Database Integration Manager
        class ActivityDatabaseManager {
            constructor() {
                this.questionDB = null;
                this.activityMapping = null;
                this.isInitialized = false;
                this.activityConfig = null;
                this.questionBlocks = [];
            }

            async initialize() {
                if (this.isInitialized) return true;

                try {
                    // Check if database objects are available
                    if (window.questionDB && window.ActivityMapping) {
                        this.questionDB = window.questionDB;
                        this.activityMapping = window.ActivityMapping;

                        // Get activity configuration
                        this.activityConfig = this.activityMapping.getActivityConfig('operacoes_matematicas');

                        if (this.activityConfig) {
                            await this.loadQuestionBlocks();
                            this.isInitialized = true;
                            return true;
                        }
                    }

                    // Fallback: create sample data
                    console.log('Database not available, creating sample data...');
                    await this.createSampleData();
                    this.isInitialized = true;
                    return true;

                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    await this.createSampleData();
                    this.isInitialized = true;
                    return true;
                }
            }

            async loadQuestionBlocks() {
                this.questionBlocks = [];

                for (let i = 0; i < this.activityConfig.questionBlocks.length; i++) {
                    const blockConfig = this.activityConfig.questionBlocks[i];
                    const blockData = this.activityMapping.getBlockQuestions(blockConfig.blockId);

                    const blockQuestions = [];

                    if (blockData && blockData.questions) {
                        // Load questions from database
                        for (let j = 0; j < Math.min(blockConfig.questions, blockData.questions.length); j++) {
                            const questionId = blockData.questions[j];

                            // Try to get from database, fallback to sample
                            let question = this.questionDB?.questions?.get(questionId);
                            if (!question) {
                                question = this.createSampleQuestion(questionId, blockConfig.blockId, j + 1, blockData.difficulty);
                            }

                            blockQuestions.push(this.formatQuestionForActivity(question, i, j));
                        }
                    }

                    // Fill remaining slots with sample data if needed
                    while (blockQuestions.length < 5) {
                        const sampleQuestion = this.createSampleQuestion(
                            `sample_${i}_${blockQuestions.length}`,
                            blockConfig.blockId,
                            blockQuestions.length + 1,
                            blockData?.difficulty || 'easy'
                        );
                        blockQuestions.push(this.formatQuestionForActivity(sampleQuestion, i, blockQuestions.length));
                    }

                    this.questionBlocks.push(blockQuestions.slice(0, 5));
                }
            }

            formatQuestionForActivity(question, blockIndex, questionIndex) {
                return {
                    text: question.statement || question.text,
                    operation: question.mathematics?.operation || question.operation,
                    explanation: question.mathematics?.explanation || question.explanation,
                    calculation: question.mathematics?.calculation || question.calculation,
                    competencyData: {
                        operation_identification: question.competencies?.operation_identification,
                        text_interpretation: question.competencies?.text_interpretation
                    },
                    audio: {
                        enunciado: this.generateAudioPath(blockIndex + 1, questionIndex + 1, 'enunciado'),
                        explicacao: this.generateAudioPath(blockIndex + 1, questionIndex + 1, 'explicacao')
                    },
                    metadata: {
                        difficulty: question.metadata?.difficulty || question.difficulty || 'easy',
                        blockIndex,
                        questionIndex,
                        originalId: question.id
                    }
                };
            }

            generateAudioPath(blockNumber, questionNumber, audioType) {
                const blockStr = String(blockNumber).padStart(2, '0');
                return `../media/audios/matematica/bloco_${blockStr}/bloco_${blockStr}_questao_${questionNumber}_${audioType}.mp3`;
            }

            async createSampleData() {
                // Sample question data organized by blocks with progressive difficulty
                const sampleBlocks = [
                    // Block 1: Easy Addition and Subtraction
                    [
                        {
                            text: "João tem 3 carros de brinquedo no Roblox e ganhou mais 2. Quantos carros ele tem agora?",
                            operation: "adição",
                            explanation: "A palavra 'ganhou MAIS' indica que estamos SOMANDO.",
                            calculation: "3 + 2 = 5",
                            difficulty: "easy"
                        },
                        {
                            text: "Maria tinha 8 doces e comeu 3. Quantos doces sobraram?",
                            operation: "subtração",
                            explanation: "Ela COMEU alguns doces, então eles SAÍRAM.",
                            calculation: "8 - 3 = 5",
                            difficulty: "easy"
                        },
                        {
                            text: "Pedro viu 6 vídeos do Diário do Bananinha e sua irmã viu mais 4. Quantos vídeos eles viram juntos?",
                            operation: "adição",
                            explanation: "Estamos JUNTANDO os vídeos dos dois.",
                            calculation: "6 + 4 = 10",
                            difficulty: "easy"
                        },
                        {
                            text: "Ana tinha 9 pipas e 4 voaram no vento. Quantas pipas ficaram?",
                            operation: "subtração",
                            explanation: "As pipas VOARAM, então SAÍRAM.",
                            calculation: "9 - 4 = 5",
                            difficulty: "easy"
                        },
                        {
                            text: "Lucas tem 5 tênis e ganhou 3 novos. Quantos tênis ele possui agora?",
                            operation: "adição",
                            explanation: "Ele GANHOU mais tênis, então SOMAMOS.",
                            calculation: "5 + 3 = 8",
                            difficulty: "easy"
                        }
                    ],
                    // Block 2: Easy Multiplication and Division
                    [
                        {
                            text: "Carla comprou 4 pacotes de figurinhas com 6 figurinhas cada. Quantas figurinhas ela tem?",
                            operation: "multiplicação",
                            explanation: "Várias vezes a mesma quantidade = MULTIPLICAR.",
                            calculation: "4 × 6 = 24",
                            difficulty: "easy"
                        },
                        {
                            text: "Bruno tinha 12 balas e dividiu igualmente entre 3 amigos. Quantas balas cada um recebeu?",
                            operation: "divisão",
                            explanation: "DIVIDIR igualmente = DIVISÃO.",
                            calculation: "12 ÷ 3 = 4",
                            difficulty: "easy"
                        },
                        {
                            text: "Sofia coleciona 15 adesivos e sua prima coleciona o dobro. Quantos adesivos a prima tem?",
                            operation: "multiplicação",
                            explanation: "DOBRO = multiplicar por 2.",
                            calculation: "15 × 2 = 30",
                            difficulty: "easy"
                        },
                        {
                            text: "Ricardo tem 20 cards e quer formar grupos de 4. Quantos grupos ele consegue formar?",
                            operation: "divisão",
                            explanation: "Formar GRUPOS de uma quantidade = DIVISÃO.",
                            calculation: "20 ÷ 4 = 5",
                            difficulty: "easy"
                        },
                        {
                            text: "Luana comprou 3 caixas de lápis com 8 lápis cada. Quantos lápis ela comprou?",
                            operation: "multiplicação",
                            explanation: "Várias caixas com a mesma quantidade = MULTIPLICAR.",
                            calculation: "3 × 8 = 24",
                            difficulty: "easy"
                        }
                    ],
                    // Block 3: Medium Complexity
                    [
                        {
                            text: "Daniel gastou R$ 45 em jogos e ainda sobrou R$ 23. Quanto dinheiro ele tinha?",
                            operation: "adição",
                            explanation: "Gastou + sobrou = total que tinha.",
                            calculation: "45 + 23 = 68",
                            difficulty: "medium"
                        },
                        {
                            text: "Isabella coletou 36 estrelas em um jogo e perdeu 1/4 delas. Quantas estrelas ela perdeu?",
                            operation: "divisão",
                            explanation: "1/4 significa dividir por 4.",
                            calculation: "36 ÷ 4 = 9",
                            difficulty: "medium"
                        },
                        {
                            text: "Gabriel tem 7 anos e seu pai tem 5 vezes a idade dele. Quantos anos tem o pai?",
                            operation: "multiplicação",
                            explanation: "5 VEZES a idade = MULTIPLICAR por 5.",
                            calculation: "7 × 5 = 35",
                            difficulty: "medium"
                        },
                        {
                            text: "Amanda comprou 48 bombons e quer guardar 6 em cada potinho. Quantos potinhos ela precisa?",
                            operation: "divisão",
                            explanation: "Total dividido pela quantidade por grupo.",
                            calculation: "48 ÷ 6 = 8",
                            difficulty: "medium"
                        },
                        {
                            text: "Felipe economizou R$ 12 por semana durante 6 semanas. Quanto ele economizou?",
                            operation: "multiplicação",
                            explanation: "Mesma quantia por várias semanas = MULTIPLICAR.",
                            calculation: "12 × 6 = 72",
                            difficulty: "medium"
                        }
                    ],
                    // Block 4: Medium-Hard Mixed Operations
                    [
                        {
                            text: "Beatriz comprou 5 pacotes de balas por R$ 8 cada e pagou com R$ 50. Quanto recebeu de troco?",
                            operation: "subtração",
                            explanation: "Primeiro calcule 5 × 8 = 40, depois 50 - 40 = 10.",
                            calculation: "50 - (5 × 8) = 10",
                            difficulty: "medium"
                        },
                        {
                            text: "Rodrigo tem 144 cards e quer organizar em álbuns de 12 páginas com 6 cards por página. Quantos álbuns ele precisa?",
                            operation: "divisão",
                            explanation: "Cada álbum tem 12 × 6 = 72 cards. Então 144 ÷ 72 = 2.",
                            calculation: "144 ÷ (12 × 6) = 2",
                            difficulty: "medium"
                        },
                        {
                            text: "Camila economiza R$ 15 por mês. Em quanto tempo ela terá R$ 180?",
                            operation: "divisão",
                            explanation: "Total desejado dividido pela economia mensal.",
                            calculation: "180 ÷ 15 = 12",
                            difficulty: "medium"
                        },
                        {
                            text: "Thiago comprou 3 jogos por R$ 25 cada e 2 acessórios por R$ 15 cada. Quanto gastou?",
                            operation: "adição",
                            explanation: "Primeiro calcule cada grupo: (3 × 25) + (2 × 15).",
                            calculation: "75 + 30 = 105",
                            difficulty: "medium"
                        },
                        {
                            text: "Mariana tem 84 adesivos e quer dar o mesmo tanto para 7 amigas. Quantos adesivos cada uma receberá?",
                            operation: "divisão",
                            explanation: "Dividir igualmente entre várias pessoas.",
                            calculation: "84 ÷ 7 = 12",
                            difficulty: "medium"
                        }
                    ],
                    // Block 5: Hard Multi-step Problems
                    [
                        {
                            text: "Nicolas compra 6 pacotes de figurinhas por R$ 4 cada. Ele paga com uma nota de R$ 50. Se cada pacote tem 8 figurinhas, quantas figurinhas ele comprou?",
                            operation: "multiplicação",
                            explanation: "Para figurinhas: 6 × 8 = 48. Para o troco: 50 - (6 × 4) = 26.",
                            calculation: "6 × 8 = 48 figurinhas",
                            difficulty: "hard"
                        },
                        {
                            text: "Valentina quer organizar 180 cartas em caixas. Cada caixa tem 4 divisórias e cada divisória cabe 15 cartas. Quantas caixas ela precisa?",
                            operation: "divisão",
                            explanation: "Cada caixa guarda 4 × 15 = 60 cartas. Então 180 ÷ 60 = 3 caixas.",
                            calculation: "180 ÷ (4 × 15) = 3",
                            difficulty: "hard"
                        },
                        {
                            text: "Eduardo coleciona 24 miniaturas por mês há 8 meses e quer chegar a 300. Quantas ainda precisa?",
                            operation: "subtração",
                            explanation: "Já tem: 24 × 8 = 192. Ainda precisa: 300 - 192 = 108.",
                            calculation: "300 - (24 × 8) = 108",
                            difficulty: "hard"
                        },
                        {
                            text: "Larissa economiza R$ 8 por semana para comprar um presente de R$ 120. Ela já economizou por 9 semanas. Quanto ainda precisa?",
                            operation: "subtração",
                            explanation: "Já economizou: 8 × 9 = 72. Ainda precisa: 120 - 72 = 48.",
                            calculation: "120 - (8 × 9) = 48",
                            difficulty: "hard"
                        },
                        {
                            text: "Matheus tem 240 cards. Quer trocar 1/3 deles por outros na proporção de 2 para 3. Quantos cards novos receberá?",
                            operation: "multiplicação",
                            explanation: "Vai trocar: 240 ÷ 3 = 80. Receberá: (80 ÷ 2) × 3 = 120.",
                            calculation: "(240 ÷ 3 ÷ 2) × 3 = 120",
                            difficulty: "hard"
                        }
                    ]
                ];

                // Format sample data for the activity
                this.questionBlocks = sampleBlocks.map((block, blockIndex) =>
                    block.map((question, questionIndex) =>
                        this.formatQuestionForActivity(question, blockIndex, questionIndex)
                    )
                );

                this.activityConfig = {
                    name: 'Quiz de Identificação de Operações Matemáticas',
                    subject: 'matematica',
                    competencies: ['operation_identification', 'text_interpretation'],
                    questionBlocks: [
                        { blockId: 'matematica_basica_01', questions: 5 },
                        { blockId: 'matematica_basica_02', questions: 5 },
                        { blockId: 'matematica_basica_03', questions: 5 },
                        { blockId: 'matematica_basica_04', questions: 5 },
                        { blockId: 'matematica_basica_05', questions: 5 }
                    ]
                };
            }

            createSampleQuestion(questionId, blockId, questionIndex, difficulty = 'easy') {
                // This creates a basic question structure
                return {
                    id: questionId,
                    statement: `Questão exemplo ${questionIndex} do bloco ${blockId}`,
                    operation: 'adição',
                    explanation: 'Explicação da questão exemplo.',
                    calculation: '1 + 1 = 2',
                    difficulty: difficulty
                };
            }

            getQuestionBlock(blockIndex) {
                return this.questionBlocks[blockIndex] || [];
            }

            getCompetencyConfig() {
                return this.activityConfig?.competencies || ['operation_identification', 'text_interpretation'];
            }

            getAllQuestionBlocks() {
                return this.questionBlocks;
            }
        }

        const QuizOperacoes = () => {
          // Core state management
          const [database] = useState(new ActivityDatabaseManager());
          const [databaseReady, setDatabaseReady] = useState(false);
          const [studentName, setStudentName] = useState('');
          const [fontSize, setFontSize] = useState(localStorage.getItem('selectedFont') || 'dyslexic');
          const [quizStarted, setQuizStarted] = useState(false);
          const [currentQuestion, setCurrentQuestion] = useState(0);
          const [score, setScore] = useState(0);

          // Multi-competency scoring
          const [competencyScores, setCompetencyScores] = useState({
            operation_identification: { correct: 0, total: 0 },
            text_interpretation: { correct: 0, total: 0 }
          });

          const [selectedAnswer, setSelectedAnswer] = useState('');
          const [showFeedback, setShowFeedback] = useState(false);
          const [isCorrect, setIsCorrect] = useState(false);
          const [quizCompleted, setQuizCompleted] = useState(false);
          const [sessionActive, setSessionActive] = useState(false);
          const [sessionResults, setSessionResults] = useState([]);
          const [showBlockSelection, setShowBlockSelection] = useState(false);
          const [selectedBlock, setSelectedBlock] = useState(0);
          const [showCelebration, setShowCelebration] = useState(false);
          const [celebrationMessage, setCelebrationMessage] = useState('');

          // Audio state
          const [currentAudio, setCurrentAudio] = useState(null);
          const [backgroundMusic, setBackgroundMusic] = useState(null);
          const [musicPlaying, setMusicPlaying] = useState(true);

          // Initialize database
          useEffect(() => {
            const initDatabase = async () => {
              try {
                const success = await database.initialize();
                if (success) {
                  setDatabaseReady(true);
                  console.log('Database initialized successfully');
                } else {
                  throw new Error('Database initialization failed');
                }
              } catch (error) {
                console.error('Database initialization failed:', error);
                setDatabaseReady(true); // Continue with fallback data
              }
            };

            initDatabase();
          }, [database]);

          // Audio files configuration
          const backgroundMusicFiles = [
            'musica_fundo_1.mp3',
            'musica_fundo_2.mp3',
            'musica_fundo_3.mp3',
            'musica_fundo_4.mp3',
            'musica_fundo_5.mp3'
          ];

          const feedbackSounds = {
            acertos: ['acerto_1.mp3', 'acerto_2.mp3', 'acerto_3.mp3', 'acerto_4.mp3'],
            erros: ['erro_1.mp3', 'erro_2.mp3', 'erro_3.mp3', 'erro_4.mp3']
          };

          // Initialize background music
          useEffect(() => {
            if (databaseReady && !backgroundMusic) {
              const initBackgroundMusic = () => {
                try {
                  const randomIndex = Math.floor(Math.random() * backgroundMusicFiles.length);
                  const musicPath = `../media/musicas/fundo/${backgroundMusicFiles[randomIndex]}`;

                  const music = new Audio(musicPath);
                  music.volume = 0.15;
                  music.loop = true;

                  setBackgroundMusic(music);

                  music.play().catch(error => {
                    console.log('Música de fundo não pôde ser iniciada automaticamente:', error);
                  });
                } catch (error) {
                  console.log('Erro ao inicializar música de fundo:', error);
                }
              };

              initBackgroundMusic();
            }

            return () => {
              if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
              }
            };
          }, [databaseReady]);

          // Audio control functions
          const playAudio = (blockIndex, questionIndex, audioType = 'enunciado') => {
            try {
              if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
              }

              const blockStr = String(blockIndex + 1).padStart(2, '0');
              const questionStr = String(questionIndex + 1);
              const audioPath = `../media/audios/matematica/bloco_${blockStr}/bloco_${blockStr}_questao_${questionStr}_${audioType}.mp3`;

              const audio = new Audio(audioPath);
              audio.volume = 0.8;
              setCurrentAudio(audio);

              audio.addEventListener('ended', () => {
                setCurrentAudio(null);
              });

              audio.play().catch(error => {
                console.log('Áudio não encontrado:', audioPath);
                setCurrentAudio(null);
              });
            } catch (error) {
              console.log('Erro ao reproduzir áudio:', error);
            }
          };

          const playFeedbackSound = (isCorrect) => {
            try {
              const soundType = isCorrect ? 'acertos' : 'erros';
              const sounds = feedbackSounds[soundType];
              const randomIndex = Math.floor(Math.random() * sounds.length);
              const soundPath = `../media/sons/feedback/${soundType}/${sounds[randomIndex]}`;

              const audio = new Audio(soundPath);
              audio.volume = 0.6;
              audio.play().catch(error => {
                console.log('Som de feedback não encontrado:', soundPath);
              });
            } catch (error) {
              console.log('Erro ao reproduzir som de feedback:', error);
            }
          };

          // Block titles
          const blockTitles = [
            '🎮 Nível Iniciante - Soma e Subtração',
            '🏆 Nível Aventureiro - Multiplicação e Divisão',
            '⭐ Nível Explorador - Problemas Médios',
            '🎯 Nível Estrategista - Operações Mistas',
            '🚀 Nível Construtor - Desafios Avançados'
          ];

          const celebrationMessages = [
              '🎉 Fantástico! Bate palma bem suave! 👏',
              '⭐ Sensacional! Mãos ao alto comemorando! 🙌',
              '🏆 Incrível! Faz um soquinho no ar! ✊',
              '🚀 Arrasou! Dá um sorriso enorme! 😄',
              '✨ Perfeito! Bate o pé no chão de alegria! 🦶'
          ];

          // Get current question from database
          const getCurrentQuestion = () => {
            if (!databaseReady) return null;
            const block = database.getQuestionBlock(selectedBlock);
            return block[currentQuestion] || null;
          };

          // Enhanced answer handling with competency tracking
          const handleAnswerSubmit = (operation) => {
            const currentProblem = getCurrentQuestion();
            if (!currentProblem) return;

            const correct = operation === currentProblem.operation;
            setSelectedAnswer(operation);
            setIsCorrect(correct);
            setShowFeedback(true);

            playFeedbackSound(correct);

            // Update competency scores
            setCompetencyScores(prev => {
              const updated = { ...prev };

              // Operation identification competency
              updated.operation_identification.total += 1;
              if (correct) {
                updated.operation_identification.correct += 1;
              }

              // Text interpretation competency (assume correct if operation is right)
              updated.text_interpretation.total += 1;
              if (correct) {
                updated.text_interpretation.correct += 1;
              }

              return updated;
            });

            setTimeout(() => {
              playAudio(selectedBlock, currentQuestion, 'explicacao');
            }, 1000);

            if (correct) {
              setScore(score + 1);
              const randomMessage = celebrationMessages[Math.floor(Math.random() * celebrationMessages.length)];
              setCelebrationMessage(randomMessage);
              setShowCelebration(true);
              setTimeout(() => setShowCelebration(false), 2500);
            }
          };

          const handleNext = () => {
            if (currentQuestion < 4) {
              setCurrentQuestion(currentQuestion + 1);
              setSelectedAnswer('');
              setShowFeedback(false);
              setIsCorrect(false);
            } else {
              setQuizCompleted(true);

              // Save results with competency breakdown
              const results = {
                studentName,
                blockTitle: blockTitles[selectedBlock],
                score,
                totalQuestions: 5,
                percentage: Math.round((score / 5) * 100),
                competencyScores,
                timestamp: new Date().toISOString(),
                blockIndex: selectedBlock
              };

              const savedResults = JSON.parse(localStorage.getItem('quizSessionResults') || '[]');
              savedResults.push(results);
              localStorage.setItem('quizSessionResults', JSON.stringify(savedResults));
              setSessionResults(savedResults);
            }
          };

          const startNewSession = () => {
            setSessionActive(true);
            setShowBlockSelection(true);
          };

          const handleStartQuiz = (blockIndex) => {
            setSelectedBlock(blockIndex);
            setQuizStarted(true);
            setShowBlockSelection(false);
            setCurrentQuestion(0);
            setScore(0);
            setCompetencyScores({
              operation_identification: { correct: 0, total: 0 },
              text_interpretation: { correct: 0, total: 0 }
            });
            setSelectedAnswer('');
            setShowFeedback(false);
            setIsCorrect(false);
            setQuizCompleted(false);

            // Auto-play first question audio
            setTimeout(() => {
              playAudio(blockIndex, 0, 'enunciado');
            }, 1000);
          };

          const resetQuiz = () => {
            setQuizStarted(false);
            setShowBlockSelection(false);
            setSessionActive(false);
            setCurrentQuestion(0);
            setScore(0);
            setCompetencyScores({
              operation_identification: { correct: 0, total: 0 },
              text_interpretation: { correct: 0, total: 0 }
            });
            setSelectedAnswer('');
            setShowFeedback(false);
            setIsCorrect(false);
            setQuizCompleted(false);
          };

          // Enhanced CSV export with competency data
          const generateCSV = () => {
            if (sessionResults.length === 0) {
              alert('Nenhum resultado para exportar!');
              return;
            }

            let csvContent = 'Nome do Aluno,Bloco,Pontuação,Total de Questões,Porcentagem,Identificação de Operações (Acertos/Total),Interpretação de Texto (Acertos/Total),Data e Hora\n';

            sessionResults.forEach(result => {
              const opIdentification = `${result.competencyScores?.operation_identification?.correct || 0}/${result.competencyScores?.operation_identification?.total || 0}`;
              const textInterpretation = `${result.competencyScores?.text_interpretation?.correct || 0}/${result.competencyScores?.text_interpretation?.total || 0}`;

              csvContent += `"${result.studentName}","${result.blockTitle}",${result.score},${result.totalQuestions},${result.percentage}%,"${opIdentification}","${textInterpretation}","${new Date(result.timestamp).toLocaleString('pt-BR')}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `quiz_operacoes_resultados_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          const getFontStyle = () => {
            switch (fontSize) {
              case 'comic':
                return { fontFamily: "'Comic Neue', 'Comic Sans MS', cursive" };
              case 'bubble':
                return { fontFamily: "'Fuzzy Bubbles', cursive" };
              case 'comic-lg':
                return { fontFamily: "'Comic Neue', 'Comic Sans MS', cursive", fontSize: '1.125rem' };
              case 'dyslexic':
                return { fontFamily: "'Comic Neue', 'Comic Sans MS', cursive", fontSize: '1.25rem', lineHeight: '1.6' };
              default:
                return { fontFamily: "'Comic Neue', 'Comic Sans MS', cursive", fontSize: '1.25rem', lineHeight: '1.6' };
            }
          };

          // Loading state
          if (!databaseReady) {
            return React.createElement('div', { className: "loading" },
              React.createElement('div', { className: "spinner" }),
              'Carregando banco de dados...'
            );
          }

          // Login Screen
          if (!sessionActive) {
            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 flex items-center justify-center p-4",
              style: getFontStyle()
            },
              React.createElement('div', {
                className: "bg-white rounded-lg shadow-xl p-8 max-w-md w-full"
              },
                React.createElement('div', { className: "text-center mb-6" },
                  React.createElement('h1', {
                    className: "text-3xl font-bold text-gray-800 mb-2"
                  }, "🧮 Quiz de Operações"),
                  React.createElement('p', {
                    className: "text-gray-600"
                  }, "Identifique as operações matemáticas com sistema multi-competência!")
                ),

                React.createElement('div', { className: "mb-6" },
                  React.createElement('label', {
                    className: "block text-sm font-medium text-gray-700 mb-2"
                  }, "Digite seu nome:"),
                  React.createElement('input', {
                    type: "text",
                    value: studentName,
                    onChange: (e) => setStudentName(e.target.value),
                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                    placeholder: "Seu nome aqui...",
                    onKeyPress: (e) => {
                      if (e.key === 'Enter' && studentName.trim()) {
                        startNewSession();
                      }
                    }
                  })
                ),

                React.createElement('div', { className: "mb-6" },
                  React.createElement('label', {
                    className: "block text-sm font-medium text-gray-700 mb-2"
                  }, "Tamanho da fonte:"),
                  React.createElement('select', {
                    value: fontSize,
                    onChange: (e) => {
                      setFontSize(e.target.value);
                      localStorage.setItem('selectedFont', e.target.value);
                    },
                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  },
                    React.createElement('option', { value: "comic" }, "Comic - Normal"),
                    React.createElement('option', { value: "bubble" }, "Bubble - Divertida"),
                    React.createElement('option', { value: "comic-lg" }, "Comic - Grande"),
                    React.createElement('option', { value: "dyslexic" }, "Dislexia - Extra Grande")
                  )
                ),

                React.createElement('button', {
                  onClick: startNewSession,
                  disabled: !studentName.trim(),
                  className: `w-full py-3 px-4 rounded-md font-semibold transition-colors ${
                    studentName.trim()
                      ? 'bg-blue-500 hover:bg-blue-600 text-white'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`
                }, "🚀 Começar Quiz"),

                sessionResults.length > 0 && React.createElement('div', { className: "mt-4" },
                  React.createElement('button', {
                    onClick: generateCSV,
                    className: "w-full py-2 px-4 bg-green-500 hover:bg-green-600 text-white rounded-md font-semibold transition-colors"
                  }, "📊 Exportar Resultados Multi-Competência (CSV)")
                )
              )
            );
          }

          // Block Selection Screen
          if (showBlockSelection && !quizStarted) {
            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-4",
              style: getFontStyle()
            },
              React.createElement('div', { className: "max-w-4xl mx-auto" },
                React.createElement('div', { className: "bg-white rounded-lg shadow-xl p-6" },
                  React.createElement('div', { className: "text-center mb-8" },
                    React.createElement('h1', {
                      className: "text-3xl font-bold text-gray-800 mb-2"
                    }, `Olá, ${studentName}! 👋`),
                    React.createElement('p', {
                      className: "text-gray-600 text-lg"
                    }, "Escolha um nível de dificuldade:"),
                    React.createElement('p', {
                      className: "text-sm text-blue-600 mt-2"
                    }, "Sistema Multi-Competência: Identifica Operações + Interpreta Texto")
                  ),

                  React.createElement('div', { className: "grid md:grid-cols-2 lg:grid-cols-3 gap-4" },
                    blockTitles.map((title, index) =>
                      React.createElement('button', {
                        key: index,
                        onClick: () => handleStartQuiz(index),
                        className: "bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white p-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200"
                      },
                        React.createElement('div', { className: "text-center" },
                          React.createElement('div', { className: "text-2xl mb-2" }, title),
                          React.createElement('p', { className: "text-xs text-gray-200 mt-2" }, "5 questões com avaliação dupla")
                        )
                      )
                    )
                  ),

                  React.createElement('div', { className: "text-center mt-6" },
                    React.createElement('button', {
                      onClick: resetQuiz,
                      className: "px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
                    }, "← Voltar")
                  )
                )
              )
            );
          }

          // Quiz Completed Screen
          if (quizCompleted) {
            const percentage = Math.round((score / 5) * 100);
            const opPercentage = Math.round((competencyScores.operation_identification.correct / competencyScores.operation_identification.total) * 100) || 0;
            const textPercentage = Math.round((competencyScores.text_interpretation.correct / competencyScores.text_interpretation.total) * 100) || 0;

            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-4",
              style: getFontStyle()
            },
              React.createElement('div', { className: "max-w-2xl mx-auto" },
                React.createElement('div', { className: "bg-white rounded-lg shadow-xl p-8 text-center" },
                  React.createElement('div', { className: "mb-6" },
                    React.createElement('div', { className: "text-6xl mb-4" },
                      percentage >= 80 ? "🏆" : percentage >= 60 ? "⭐" : "🎯"
                    ),
                    React.createElement('h2', {
                      className: "text-3xl font-bold text-gray-800 mb-2"
                    }, percentage >= 80 ? "Excelente!" : percentage >= 60 ? "Muito Bem!" : "Continue Praticando!"),
                    React.createElement('p', {
                      className: "text-xl text-gray-600"
                    }, `${studentName}, você acertou ${score} de 5 questões!`)
                  ),

                  React.createElement('div', { className: "bg-gray-50 rounded-lg p-6 mb-6" },
                    React.createElement('h3', { className: "text-lg font-bold text-gray-800 mb-4" }, "📊 Análise Multi-Competência"),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4 text-center" },
                      React.createElement('div', {},
                        React.createElement('div', { className: "text-3xl font-bold text-blue-600" }, `${percentage}%`),
                        React.createElement('div', { className: "text-sm text-gray-600" }, "Pontuação Geral")
                      ),
                      React.createElement('div', {},
                        React.createElement('div', { className: "text-3xl font-bold text-purple-600" }, `${opPercentage}%`),
                        React.createElement('div', { className: "text-sm text-gray-600" }, "Identificação de Operações")
                      ),
                      React.createElement('div', {},
                        React.createElement('div', { className: "text-3xl font-bold text-green-600" }, `${textPercentage}%`),
                        React.createElement('div', { className: "text-sm text-gray-600" }, "Interpretação de Texto")
                      )
                    )
                  ),

                  React.createElement('div', { className: "flex gap-4 justify-center" },
                    React.createElement('button', {
                      onClick: () => setShowBlockSelection(true),
                      className: "px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold"
                    }, "🎮 Jogar Novamente"),
                    React.createElement('button', {
                      onClick: resetQuiz,
                      className: "px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold"
                    }, "🏠 Menu Principal")
                  )
                )
              )
            );
          }

          // Quiz Screen
          const currentProblem = getCurrentQuestion();
          if (!currentProblem) {
            return React.createElement('div', { className: "loading" },
              React.createElement('div', { className: "spinner" }),
              'Carregando questão...'
            );
          }

          return React.createElement('div', {
            className: "min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-4",
            style: getFontStyle()
          },
            React.createElement('div', {
              className: "max-w-2xl mx-auto bg-white rounded-lg shadow-xl p-6"
            },
              // Header with competency indicators
              React.createElement('div', { className: "mb-6" },
                React.createElement('div', { className: "flex justify-between items-center mb-4" },
                  React.createElement('div', {},
                    React.createElement('div', {
                      className: "font-semibold text-gray-800"
                    }, `Aluno: ${studentName}`),
                    React.createElement('div', {
                      className: "text-sm text-blue-600 font-medium"
                    }, blockTitles[selectedBlock]),
                    React.createElement('div', {
                      className: "text-xs text-purple-600"
                    }, "Avaliação: Operações + Interpretação")
                  ),
                  React.createElement('span', {
                    className: "text-sm text-gray-600"
                  }, `Questão ${currentQuestion + 1} de 5`)
                ),

                React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-3" },
                  React.createElement('div', {
                    className: "bg-blue-500 h-3 rounded-full transition-all duration-300",
                    style: { width: `${((currentQuestion + 1) / 5) * 100}%` }
                  })
                )
              ),

              // Question
              React.createElement('div', { className: "mb-8" },
                React.createElement('div', { className: "flex items-center justify-between mb-4" },
                  React.createElement('h2', {
                    className: "text-xl font-bold text-gray-800"
                  }, "🧮 Qual operação usar?"),
                  React.createElement('button', {
                    onClick: () => playAudio(selectedBlock, currentQuestion, 'enunciado'),
                    className: "px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-sm"
                  }, "🔊 Ouvir")
                ),
                React.createElement('p', {
                  className: "text-lg text-gray-700 bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500"
                }, currentProblem.text)
              ),

              // Answer Options
              React.createElement('div', { className: "grid grid-cols-2 gap-4 mb-6" },
                [
                  { label: 'Adição', emoji: '➕', value: 'adição' },
                  { label: 'Subtração', emoji: '➖', value: 'subtração' },
                  { label: 'Multiplicação', emoji: '✖️', value: 'multiplicação' },
                  { label: 'Divisão', emoji: '➗', value: 'divisão' }
                ].map((operation, index) =>
                  React.createElement('button', {
                    key: index,
                    onClick: () => !showFeedback && handleAnswerSubmit(operation.value),
                    disabled: showFeedback,
                    className: `p-4 border-2 rounded-lg transition-all duration-200 ${
                      selectedAnswer === operation.value
                        ? isCorrect
                          ? 'bg-green-100 border-green-500 ring-2 ring-green-200'
                          : 'bg-red-100 border-red-500 ring-2 ring-red-200'
                        : showFeedback && operation.value === currentProblem.operation
                          ? 'bg-green-100 border-green-500 ring-2 ring-green-200'
                          : showFeedback
                            ? 'bg-gray-100 border-gray-300'
                            : 'bg-white border-gray-300 hover:border-blue-500 hover:bg-blue-50'
                    }`
                  },
                    React.createElement('div', { className: "flex items-center" },
                      React.createElement('span', { className: "text-2xl mr-3" }, operation.emoji),
                      React.createElement('span', { className: "font-semibold text-lg" },
                        `${index + 1}. ${operation.label}`
                      )
                    )
                  )
                )
              ),

              // Feedback
              showFeedback && React.createElement('div', {
                className: `mb-6 p-4 rounded-lg ${
                  isCorrect ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'
                }`
              },
                React.createElement('div', { className: "flex items-center mb-2" },
                  React.createElement('span', { className: "text-2xl mr-2" }, isCorrect ? '✅' : '❌'),
                  React.createElement('span', { className: "font-semibold" },
                    isCorrect ? 'Parabéns! Resposta correta!' : 'Ops! Resposta incorreta.'
                  ),
                  React.createElement('span', { className: "text-xs text-gray-600 ml-2" }, "(+2 competências avaliadas)")
                ),
                React.createElement('p', { className: "text-sm text-gray-700" },
                  currentProblem.explanation
                ),
                currentProblem.calculation && React.createElement('p', {
                  className: "text-sm text-gray-600 mt-2 font-mono bg-white p-2 rounded border"
                }, currentProblem.calculation)
              ),

              // Celebration Animation
              showCelebration && React.createElement('div', {
                className: "celebration-animation text-center mb-4 p-4 bg-yellow-100 border border-yellow-300 rounded-lg"
              },
                React.createElement('p', { className: "text-lg font-bold text-yellow-800" },
                  celebrationMessage
                )
              ),

              // Next Button
              showFeedback && React.createElement('div', { className: "text-center" },
                React.createElement('button', {
                  onClick: handleNext,
                  className: "px-8 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold text-lg transition-colors"
                }, currentQuestion < 4 ? "Próxima Questão ➡️" : "Ver Resultado Multi-Competência 🏆")
              )
            )
          );
        };

        ReactDOM.render(React.createElement(QuizOperacoes), document.getElementById('root'));
    </script>
</body>
</html>