<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz de Identificação de Operações Matemáticas</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Fuzzy+Bubbles:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --success-color: #10b981;
        --error-color: #ef4444;
        --warning-color: #f59e0b;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --bg-light: #f9fafb;
        --border-color: #e5e7eb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Comic Neue", "Comic Sans MS", cursive, sans-serif;
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--secondary-color) 100%
        );
        min-height: 100vh;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin: 0 0 10px 0;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .progress-bar {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        height: 15px;
        margin: 20px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(90deg, #10b981, #059669);
        height: 100%;
        border-radius: 25px;
        transition: width 0.3s ease;
        width: 0%;
      }

      .progress-text {
        color: white;
        text-align: center;
        margin-top: 10px;
        font-weight: 600;
      }

      .quiz-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .block-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .block-button {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border: none;
        padding: 20px;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .block-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .block-button.completed {
        background: linear-gradient(135deg, var(--success-color), #059669);
      }

      .block-button.current {
        background: linear-gradient(135deg, var(--warning-color), #d97706);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .question-container {
        margin-bottom: 30px;
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .question-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .audio-button {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .audio-button:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
      }

      .problem-text {
        font-size: 1.2rem;
        color: var(--text-primary);
        background: var(--bg-light);
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid var(--primary-color);
        margin-bottom: 25px;
      }

      .options-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 25px;
      }

      .option-button {
        background: white;
        border: 2px solid var(--border-color);
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        display: flex;
        align-items: center;
        font-size: 1.1rem;
      }

      .option-button:hover {
        border-color: var(--primary-color);
        background: rgba(102, 126, 234, 0.05);
        transform: translateY(-2px);
      }

      .option-button.selected {
        background: rgba(102, 126, 234, 0.1);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      }

      .option-emoji {
        font-size: 2rem;
        margin-right: 15px;
      }

      .feedback-container {
        background: var(--bg-light);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
      }

      .feedback-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .feedback-icon {
        font-size: 2.5rem;
        margin-right: 15px;
      }

      .feedback-title {
        font-size: 1.3rem;
        font-weight: 700;
      }

      .feedback-correct {
        color: var(--success-color);
        border-left: 4px solid var(--success-color);
      }

      .feedback-incorrect {
        color: var(--error-color);
        border-left: 4px solid var(--error-color);
      }

      .explanation {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border-left: 3px solid var(--primary-color);
      }

      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: auto;
      }

      .btn {
        padding: 15px 25px;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        text-align: center;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--error-color), #dc2626);
        color: white;
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
      }

      .btn-success {
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
      }

      .results-container {
        text-align: center;
      }

      .score-display {
        font-size: 3rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 20px 0;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 25px 0;
      }

      .stat-card {
        background: var(--bg-light);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 5px;
      }

      .celebration {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        animation: celebrationBounce 0.6s ease-out;
      }

      @keyframes celebrationBounce {
        0% {
          transform: translate(-50%, -50%) scale(0.3);
        }
        50% {
          transform: translate(-50%, -50%) scale(1.1);
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .hidden {
        display: none !important;
      }

      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        min-height: 100vh;
      }

      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .quiz-card {
          padding: 20px;
        }

        .block-selector {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .option-button {
          padding: 15px;
          font-size: 1rem;
        }

        .action-buttons {
          flex-direction: column;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.5rem;
        }

        .quiz-card {
          padding: 15px;
        }

        .option-emoji {
          font-size: 1.5rem;
          margin-right: 10px;
        }

        .score-display {
          font-size: 2.5rem;
        }
      }

      /* Accessibility */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .option-button:focus,
      .btn:focus,
      .audio-button:focus,
      .block-button:focus {
        outline: 3px solid #fbbf24;
        outline-offset: 2px;
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        :root {
          --primary-color: #000080;
          --secondary-color: #000040;
          --success-color: #006400;
          --error-color: #8b0000;
          --text-primary: #000000;
          --text-secondary: #333333;
        }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Carregando Quiz...</div>
      </div>

      <div class="container hidden" id="main-container">
        <header class="header">
          <h1>Quiz de Operações Matemáticas</h1>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-text" id="progress-text">
            Selecione um bloco para começar
          </div>
        </header>

        <main class="quiz-card">
          <!-- Block Selection Screen -->
          <section id="block-selection" class="block-selector">
            <!-- Blocks will be generated here -->
          </section>

          <!-- Question Screen -->
          <section id="question-screen" class="hidden">
            <div class="question-container">
              <div class="question-header">
                <h2 class="question-title" id="question-title">Questão 1</h2>
                <button
                  class="audio-button"
                  id="audio-btn"
                  aria-label="Ouvir enunciado da questão"
                >
                  🔊
                </button>
              </div>

              <div class="problem-text" id="problem-text">
                <!-- Problem text will be inserted here -->
              </div>

              <div id="options-container" class="options-grid">
                <!-- Options will be generated here -->
              </div>

              <div id="feedback-container" class="feedback-container hidden">
                <!-- Feedback will be shown here -->
              </div>
            </div>

            <div class="action-buttons" id="action-buttons">
              <!-- Action buttons will be generated here -->
            </div>
          </section>

          <!-- Results Screen -->
          <section id="results-screen" class="results-container hidden">
            <h2>Parabéns! Você completou o bloco!</h2>
            <div class="score-display" id="final-score">0%</div>

            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="correct-answers">0</div>
                <div class="stat-label">Acertos</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="wrong-answers">0</div>
                <div class="stat-label">Erros</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="total-time">0s</div>
                <div class="stat-label">Tempo Total</div>
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn btn-primary" id="try-again-btn">
                🔄 Tentar Novamente
              </button>
              <button class="btn btn-success" id="export-csv-btn">
                📊 Exportar Resultado
              </button>
              <button class="btn btn-secondary" id="back-to-blocks-btn">
                🏠 Voltar aos Blocos
              </button>
            </div>
          </section>
        </main>
      </div>

      <!-- Celebration overlay -->
      <div id="celebration" class="celebration hidden">
        <div id="celebration-message">Excelente!</div>
      </div>
    </div>

    <script>
      // Educational content structure with 9 progressive blocks
      const QUIZ_DATA = {
        subject: "matematica",
        activity: "operacoes_basicas",
        blocks: [
          // BLOCO 1 - Básico: Soma simples (números pequenos)
          {
            id: 1,
            name: "Bloco 1: Soma Básica",
            level: "básico",
            questions: [
              {
                text: "João tem 2 maçãs e ganhou mais 3 maçãs. Quantas maçãs ele tem agora?",
                operation: "soma",
                calculation: "2 + 3 = 5",
                explanation:
                  "Quando ganhamos mais algo, usamos a soma para juntar as quantidades.",
              },
              {
                text: "Maria comprou 4 balas e depois comprou mais 2 balas. Quantas balas ela tem?",
                operation: "soma",
                calculation: "4 + 2 = 6",
                explanation:
                  "Quando compramos mais de algo, somamos as quantidades.",
              },
              {
                text: "No parque há 3 pássaros. Chegaram mais 2 pássaros. Quantos pássaros há agora?",
                operation: "soma",
                calculation: "3 + 2 = 5",
                explanation: "Quando chegam mais, usamos a soma.",
              },
              {
                text: "Ana desenhou 1 estrela e depois desenhou mais 4 estrelas. Quantas estrelas ela desenhou?",
                operation: "soma",
                calculation: "1 + 4 = 5",
                explanation: "Quando desenhamos mais, somamos tudo.",
              },
            ],
          },
          // BLOCO 2 - Básico: Subtração simples
          {
            id: 2,
            name: "Bloco 2: Subtração Básica",
            level: "básico",
            questions: [
              {
                text: "Pedro tinha 5 carrinhos e perdeu 2 carrinhos. Com quantos carrinhos ele ficou?",
                operation: "subtracao",
                calculation: "5 - 2 = 3",
                explanation:
                  "Quando perdemos algo, usamos a subtração para tirar a quantidade.",
              },
              {
                text: "Havia 6 flores no jardim. 3 flores murcharam. Quantas flores restaram?",
                operation: "subtracao",
                calculation: "6 - 3 = 3",
                explanation: "Quando algo some ou murcha, subtraímos.",
              },
              {
                text: "Laura comeu 2 dos seus 7 doces. Quantos doces sobraram?",
                operation: "subtracao",
                calculation: "7 - 2 = 5",
                explanation:
                  "Quando comemos algo, subtraímos o que foi consumido.",
              },
              {
                text: "Havia 8 balões. 3 balões voaram. Quantos balões restaram?",
                operation: "subtracao",
                calculation: "8 - 3 = 5",
                explanation: "Quando algo vai embora, usamos subtração.",
              },
            ],
          },
          // BLOCO 3 - Básico: Multiplicação simples (tabuada básica)
          {
            id: 3,
            name: "Bloco 3: Multiplicação Básica",
            level: "básico",
            questions: [
              {
                text: "Cada caixa tem 3 lápis. Se temos 2 caixas, quantos lápis temos ao todo?",
                operation: "multiplicacao",
                calculation: "3 × 2 = 6",
                explanation:
                  "Quando temos grupos iguais, multiplicamos para saber o total.",
              },
              {
                text: "Um prato tem 4 cookies. Quantos cookies há em 3 pratos iguais?",
                operation: "multiplicacao",
                calculation: "4 × 3 = 12",
                explanation:
                  "Quando repetimos uma quantidade várias vezes, usamos multiplicação.",
              },
              {
                text: "Cada criança tem 2 mãos. Quantas mãos têm 5 crianças juntas?",
                operation: "multiplicacao",
                calculation: "2 × 5 = 10",
                explanation:
                  "Para contar grupos iguais rapidamente, multiplicamos.",
              },
              {
                text: "Cada casa tem 3 janelas. Em uma rua com 4 casas iguais, quantas janelas há?",
                operation: "multiplicacao",
                calculation: "3 × 4 = 12",
                explanation:
                  "Quando todas as partes são iguais, multiplicamos.",
              },
            ],
          },
          // BLOCO 4 - Intermediário: Operações combinadas simples
          {
            id: 4,
            name: "Bloco 4: Operações Combinadas",
            level: "intermediário",
            questions: [
              {
                text: "Carlos tinha 10 figurinhas, ganhou 5 novas figurinhas de um amigo e depois deu 3 figurinhas para sua irmã. Quantas figurinhas ele tem agora?",
                operation: "soma",
                calculation: "10 + 5 - 3 = 12",
                explanation:
                  "Primeiro somamos o que ganhou, depois subtraímos o que deu. O resultado final é soma porque ganhou mais do que deu.",
              },
              {
                text: "Em uma festa havia 20 balões decorativos. Durante a festa, 8 balões estouraram e depois foram colocados mais 6 balões novos. Quantos balões há agora?",
                operation: "subtracao",
                calculation: "20 - 8 + 6 = 18",
                explanation:
                  "Primeiro subtraímos os que estouraram, depois somamos os novos. Como perdemos mais do que ganhamos, é subtração.",
              },
              {
                text: "Marina organizou seus livros em 4 pilhas, cada uma com 6 livros. Depois emprestou 8 livros para amigos. Quantos livros ela ainda tem?",
                operation: "subtracao",
                calculation: "4 × 6 - 8 = 24 - 8 = 16",
                explanation:
                  "Primeiro multiplicamos para saber o total, depois subtraímos os emprestados.",
              },
              {
                text: "Um padeiro fez 15 pães pela manhã e mais 12 pães à tarde. Se ele vendeu 20 pães durante o dia, quantos pães sobraram?",
                operation: "subtracao",
                calculation: "15 + 12 - 20 = 27 - 20 = 7",
                explanation:
                  "Primeiro somamos todos os pães feitos, depois subtraímos os vendidos.",
              },
            ],
          },
          // BLOCO 5 - Intermediário: Divisão simples
          {
            id: 5,
            name: "Bloco 5: Divisão Básica",
            level: "intermediário",
            questions: [
              {
                text: "A professora tem 12 lápis para distribuir igualmente entre 4 alunos. Quantos lápis cada aluno receberá?",
                operation: "divisao",
                calculation: "12 ÷ 4 = 3",
                explanation:
                  "Quando dividimos algo igualmente entre pessoas, usamos divisão.",
              },
              {
                text: "Um jardineiro plantou 18 mudas em fileiras, colocando 6 mudas em cada fileira. Quantas fileiras ele fez?",
                operation: "divisao",
                calculation: "18 ÷ 6 = 3",
                explanation:
                  "Para descobrir quantos grupos podemos formar, dividimos o total pelo tamanho de cada grupo.",
              },
              {
                text: "Uma pizza foi cortada em 8 pedaços iguais. Se 4 crianças vão dividir a pizza igualmente, quantos pedaços cada uma comerá?",
                operation: "divisao",
                calculation: "8 ÷ 4 = 2",
                explanation:
                  "Quando repartimos algo em partes iguais, usamos divisão.",
              },
              {
                text: "Em uma caixa há 20 chocolates. Se queremos fazer pacotes com 5 chocolates cada, quantos pacotes conseguiremos fazer?",
                operation: "divisao",
                calculation: "20 ÷ 5 = 4",
                explanation:
                  "Para saber quantos grupos de tamanho fixo podemos fazer, dividimos.",
              },
            ],
          },
          // BLOCO 6 - Intermediário: Problemas de comparação
          {
            id: 6,
            name: "Bloco 6: Comparações",
            level: "intermediário",
            questions: [
              {
                text: "Joana tem 15 adesivos e sua amiga Carla tem 9 adesivos. Quantos adesivos Joana tem a mais que Carla?",
                operation: "subtracao",
                calculation: "15 - 9 = 6",
                explanation:
                  "Para descobrir a diferença entre duas quantidades, subtraímos a menor da maior.",
              },
              {
                text: "Roberto fez 25 pontos no jogo e Pedro fez 18 pontos. Quantos pontos Roberto precisa perder para ficar com a mesma pontuação que Pedro?",
                operation: "subtracao",
                calculation: "25 - 18 = 7",
                explanation:
                  "Para igualar quantidades diferentes, calculamos a diferença usando subtração.",
              },
              {
                text: "Uma escola tem 3 vezes mais alunos que outra escola. Se a escola menor tem 45 alunos, quantos alunos tem a escola maior?",
                operation: "multiplicacao",
                calculation: "45 × 3 = 135",
                explanation:
                  'Quando uma quantidade é "vezes maior", multiplicamos.',
              },
              {
                text: "Em um concurso, Ana acertou o dobro de questões que Bruno. Se Bruno acertou 12 questões, quantas questões Ana acertou?",
                operation: "multiplicacao",
                calculation: "12 × 2 = 24",
                explanation: "O dobro significa multiplicar por 2.",
              },
            ],
          },
          // BLOCO 7 - Avançado: Problemas com frações simples
          {
            id: 7,
            name: "Bloco 7: Problemas Avançados",
            level: "avançado",
            questions: [
              {
                text: "Uma fábrica de brinquedos produz 240 carrinhos por dia. Se ela funciona 6 dias por semana, quantos carrinhos produz por semana? E se metade da produção semanal for exportada, quantos carrinhos ficam no país?",
                operation: "multiplicacao",
                calculation: "240 × 6 = 1440, depois 1440 ÷ 2 = 720",
                explanation:
                  "Primeiro multiplicamos para a produção semanal, depois dividimos por 2 para encontrar a metade.",
              },
              {
                text: "Um agricultor plantou 180 pés de tomate em fileiras iguais. Se cada fileira tem 15 pés de tomate, quantas fileiras ele fez? Se cada pé produzir 8 tomates, quantos tomates ele colherá ao todo?",
                operation: "divisao",
                calculation:
                  "180 ÷ 15 = 12 fileiras, depois 180 × 8 = 1440 tomates",
                explanation:
                  "Primeiro dividimos para encontrar as fileiras, depois multiplicamos para a produção total.",
              },
              {
                text: "Em uma biblioteca há 450 livros organizados em 15 estantes iguais. Se cada estante tem 5 prateleiras iguais, quantos livros há em cada prateleira?",
                operation: "divisao",
                calculation:
                  "450 ÷ 15 = 30 livros por estante, depois 30 ÷ 5 = 6 livros por prateleira",
                explanation:
                  "Primeiro dividimos pelos grupos maiores, depois pelos grupos menores dentro deles.",
              },
              {
                text: "Carlos economiza R$ 15 por semana. Depois de 8 semanas, ele gastou R$ 75 em um presente e depois economizou mais R$ 25. Quanto dinheiro ele tem agora?",
                operation: "soma",
                calculation: "15 × 8 - 75 + 25 = 120 - 75 + 25 = 70",
                explanation:
                  "Calculamos total economizado, subtraímos o gasto e somamos a economia adicional.",
              },
            ],
          },
          // BLOCO 8 - Avançado: Problemas de proporção
          {
            id: 8,
            name: "Bloco 8: Proporções",
            level: "avançado",
            questions: [
              {
                text: "Uma receita de bolo usa 3 ovos para fazer 1 bolo que serve 8 pessoas. Se queremos fazer bolos para uma festa de 24 pessoas, mantendo a mesma proporção, quantos ovos precisaremos?",
                operation: "multiplicacao",
                calculation: "24 ÷ 8 = 3 bolos, então 3 × 3 = 9 ovos",
                explanation:
                  "Primeiro descobrimos quantos bolos precisamos, depois multiplicamos pelos ovos de cada bolo.",
              },
              {
                text: "Em uma escola, a razão entre meninos e meninas é de 3 para 2. Se há 15 meninos na classe, quantas meninas há? Qual é o total de alunos na classe?",
                operation: "divisao",
                calculation:
                  "15 ÷ 3 = 5 grupos, então 5 × 2 = 10 meninas, total = 15 + 10 = 25",
                explanation:
                  "Usamos a proporção para encontrar o número de grupos e depois calculamos as meninas.",
              },
              {
                text: "Um mapa tem escala 1:50, ou seja, cada centímetro no mapa representa 50 centímetros na realidade. Se a distância entre duas cidades no mapa é 12 cm, qual é a distância real entre elas em metros?",
                operation: "multiplicacao",
                calculation: "12 × 50 = 600 cm = 6 metros",
                explanation:
                  "Multiplicamos pela escala e convertemos centímetros para metros.",
              },
              {
                text: "Uma máquina produz 120 peças em 4 horas trabalhando na mesma velocidade constante. Quantas peças ela produzirá em 7 horas? E em quantas horas ela produzirá 180 peças?",
                operation: "divisao",
                calculation:
                  "120 ÷ 4 = 30 peças/hora, então 30 × 7 = 210 peças em 7h, e 180 ÷ 30 = 6 horas",
                explanation:
                  "Primeiro encontramos a velocidade de produção, depois usamos para os outros cálculos.",
              },
            ],
          },
          // BLOCO 9 - Avançado: Problemas complexos com múltiplas operações
          {
            id: 9,
            name: "Bloco 9: Desafios Complexos",
            level: "avançado",
            questions: [
              {
                text: "Uma loja vende camisetas por R$ 25 cada uma. Durante uma promoção, quem comprar 3 camisetas ganha uma quarta grátis. Se um cliente quer levar 12 camisetas, quanto ele pagará aproveitando a promoção ao máximo?",
                operation: "multiplicacao",
                calculation:
                  "12 ÷ 4 = 3 promoções (9 pagas + 3 grátis), então 9 × 25 = 225",
                explanation:
                  "Calculamos quantas promoções cabem e quantas camisetas realmente precisa pagar.",
              },
              {
                text: "Um ônibus escolar faz 4 viagens por dia, transportando 32 alunos por viagem. Se o ônibus funciona 5 dias por semana durante 36 semanas no ano, quantos alunos-viagem ele transporta no ano todo?",
                operation: "multiplicacao",
                calculation: "4 × 32 × 5 × 36 = 128 × 180 = 23.040",
                explanation:
                  "Multiplicamos viagens por dia × alunos por viagem × dias por semana × semanas por ano.",
              },
              {
                text: "Uma pizzaria oferece pizza individual por R$ 18 ou pizza família (que serve 4 pessoas) por R$ 65. Uma família de 6 pessoas quer economizar o máximo possível. Qual combinação de pizzas deve escolher e quanto gastará?",
                operation: "subtracao",
                calculation:
                  "1 família + 2 individuais = 65 + 36 = 101, vs 6 individuais = 108, economia de 7",
                explanation:
                  "Comparamos diferentes combinações para encontrar a mais econômica: uma pizza família mais duas individuais.",
              },
              {
                text: "Um jardineiro planta flores em canteiros retangulares. Cada canteiro tem 8 fileiras com 12 flores cada uma. Se ele tem 15 canteiros iguais e cada muda de flor custa R$ 3, quanto ele gastou em flores? Se 5% das flores não vingaram e precisaram ser replantadas, qual foi o gasto total?",
                operation: "multiplicacao",
                calculation:
                  "8 × 12 × 15 = 1440 flores, × 3 = 4320. 5% = 72 flores extras × 3 = 216. Total = 4536",
                explanation:
                  "Calculamos total de flores, custo inicial, flores que não vingaram e custo adicional.",
              },
            ],
          },
        ],
      };

      // Operations available for selection
      const OPERATIONS = [
        { value: "soma", label: "Adição (+)", emoji: "➕" },
        { value: "subtracao", label: "Subtração (-)", emoji: "➖" },
        { value: "multiplicacao", label: "Multiplicação (×)", emoji: "✖️" },
        { value: "divisao", label: "Divisão (÷)", emoji: "➗" },
      ];

      // Game state
      let currentState = {
        selectedBlock: null,
        currentQuestion: 0,
        selectedAnswer: null,
        showFeedback: false,
        correctAnswers: 0,
        wrongAnswers: 0,
        startTime: null,
        questionStartTime: null,
        responses: [],
        blockStartTime: null,
      };

      // Initialize the application
      function initApp() {
        setTimeout(() => {
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("main-container").classList.remove("hidden");
          generateBlockButtons();
          setupEventListeners();
        }, 1000);
      }

      // Generate block selection buttons
      function generateBlockButtons() {
        const container = document.getElementById("block-selection");
        container.innerHTML = "";

        QUIZ_DATA.blocks.forEach((block) => {
          const button = document.createElement("button");
          button.className = "block-button";
          button.innerHTML = `
                    <div>${block.name}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">
                        Nível: ${block.level}
                    </div>
                `;
          button.onclick = () => startBlock(block.id);
          container.appendChild(button);
        });
      }

      // Start a specific block
      function startBlock(blockId) {
        currentState.selectedBlock = blockId;
        currentState.currentQuestion = 0;
        currentState.correctAnswers = 0;
        currentState.wrongAnswers = 0;
        currentState.responses = [];
        currentState.blockStartTime = new Date();

        document.getElementById("block-selection").classList.add("hidden");
        document.getElementById("question-screen").classList.remove("hidden");

        showQuestion();
        updateProgress();
      }

      // Show current question
      function showQuestion() {
        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );
        const question = block.questions[currentState.currentQuestion];

        currentState.selectedAnswer = null;
        currentState.showFeedback = false;
        currentState.questionStartTime = new Date();

        // Update question title
        document.getElementById("question-title").textContent =
          `Questão ${currentState.currentQuestion + 1} de ${block.questions.length}`;

        // Update problem text
        document.getElementById("problem-text").textContent = question.text;

        // Generate options
        generateOptions();

        // Hide feedback and show options
        document.getElementById("feedback-container").classList.add("hidden");
        document.getElementById("options-container").classList.remove("hidden");

        // Update action buttons
        updateActionButtons();

        // Setup audio button
        setupAudioButton();
      }

      // Generate answer options
      function generateOptions() {
        const container = document.getElementById("options-container");
        container.innerHTML = "";

        OPERATIONS.forEach((operation, index) => {
          const button = document.createElement("button");
          button.className = "option-button";
          button.innerHTML = `
                    <span class="option-emoji">${operation.emoji}</span>
                    <span>${index + 1}. ${operation.label}</span>
                `;
          button.onclick = () => selectAnswer(operation.value, button);
          container.appendChild(button);
        });
      }

      // Select an answer
      function selectAnswer(value, buttonElement) {
        // Remove previous selection
        document.querySelectorAll(".option-button").forEach((btn) => {
          btn.classList.remove("selected");
        });

        // Add selection to clicked button
        buttonElement.classList.add("selected");
        currentState.selectedAnswer = value;

        // Show feedback after a short delay
        setTimeout(() => {
          showFeedback();
        }, 500);
      }

      // Show feedback for the answer
      function showFeedback() {
        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );
        const question = block.questions[currentState.currentQuestion];
        const isCorrect = currentState.selectedAnswer === question.operation;
        const questionTime = new Date() - currentState.questionStartTime;

        // Update statistics
        if (isCorrect) {
          currentState.correctAnswers++;
          showCelebration("Excelente! 🎉");
        } else {
          currentState.wrongAnswers++;
        }

        // Record response
        currentState.responses.push({
          question: currentState.currentQuestion + 1,
          correct: isCorrect,
          timeSpent: questionTime,
          selectedAnswer: currentState.selectedAnswer,
          correctAnswer: question.operation,
        });

        // Hide options and show feedback
        document.getElementById("options-container").classList.add("hidden");
        const feedbackContainer = document.getElementById("feedback-container");
        feedbackContainer.classList.remove("hidden");

        // Generate feedback content
        const correctOperation = OPERATIONS.find(
          (op) => op.value === question.operation,
        );
        feedbackContainer.className = `feedback-container ${isCorrect ? "feedback-correct" : "feedback-incorrect"}`;
        feedbackContainer.innerHTML = `
                <div class="feedback-header">
                    <span class="feedback-icon">${isCorrect ? "✅" : "❌"}</span>
                    <span class="feedback-title">${isCorrect ? "Correto!" : "Não é essa operação..."}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Resposta correta:</strong> ${correctOperation.label}
                </div>
                <div class="explanation">
                    <strong>Explicação:</strong> ${question.explanation}
                </div>
                <div class="explanation" style="margin-top: 10px;">
                    <strong>Cálculo:</strong> ${question.calculation}
                </div>
            `;

        currentState.showFeedback = true;
        updateActionButtons();
      }

      // Show celebration message
      function showCelebration(message) {
        const celebration = document.getElementById("celebration");
        document.getElementById("celebration-message").textContent = message;
        celebration.classList.remove("hidden");

        setTimeout(() => {
          celebration.classList.add("hidden");
        }, 2000);
      }

      // Update action buttons based on current state
      function updateActionButtons() {
        const container = document.getElementById("action-buttons");
        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );
        const isLastQuestion =
          currentState.currentQuestion >= block.questions.length - 1;

        if (currentState.showFeedback) {
          container.innerHTML = `
                    <button class="btn btn-primary" onclick="handleNext()">
                        ${isLastQuestion ? "🏁 Ver Resultado" : "➡️ Próxima Questão"}
                    </button>
                    <button class="btn btn-secondary" onclick="backToBlocks()">
                        🏠 Voltar aos Blocos
                    </button>
                `;
        } else {
          container.innerHTML = `
                    <button class="btn btn-secondary" onclick="backToBlocks()">
                        ← Voltar
                    </button>
                `;
        }
      }

      // Handle next question or show results
      function handleNext() {
        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );

        if (currentState.currentQuestion < block.questions.length - 1) {
          currentState.currentQuestion++;
          showQuestion();
          updateProgress();
        } else {
          showResults();
        }
      }

      // Show results screen
      function showResults() {
        document.getElementById("question-screen").classList.add("hidden");
        document.getElementById("results-screen").classList.remove("hidden");

        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );
        const totalQuestions = block.questions.length;
        const score = Math.round(
          (currentState.correctAnswers / totalQuestions) * 100,
        );
        const totalTime = Math.round(
          (new Date() - currentState.blockStartTime) / 1000,
        );

        document.getElementById("final-score").textContent = `${score}%`;
        document.getElementById("correct-answers").textContent =
          currentState.correctAnswers;
        document.getElementById("wrong-answers").textContent =
          currentState.wrongAnswers;
        document.getElementById("total-time").textContent = `${totalTime}s`;

        setupResultButtons();
      }

      // Setup result screen buttons
      function setupResultButtons() {
        document.getElementById("try-again-btn").onclick = () => {
          startBlock(currentState.selectedBlock);
        };

        document.getElementById("export-csv-btn").onclick = exportCSV;
        document.getElementById("back-to-blocks-btn").onclick = backToBlocks;
      }

      // Export results to CSV
      function exportCSV() {
        const studentName =
          prompt("Digite seu nome para o relatório:") || "Aluno";
        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );
        const totalTime = Math.round(
          (new Date() - currentState.blockStartTime) / 1000,
        );
        const score = Math.round(
          (currentState.correctAnswers / block.questions.length) * 100,
        );

        let csvContent =
          "Nome,Materia,Atividade,Bloco,Questao,Tempo_Execucao,Acertos,Erros,Score\n";

        currentState.responses.forEach((response) => {
          csvContent +=
            [
              studentName,
              QUIZ_DATA.subject,
              QUIZ_DATA.activity,
              currentState.selectedBlock,
              response.question,
              Math.round(response.timeSpent / 1000),
              response.correct ? 1 : 0,
              response.correct ? 0 : 1,
              response.correct ? 100 : 0,
            ].join(",") + "\n";
        });

        // Add summary row
        csvContent +=
          [
            studentName,
            QUIZ_DATA.subject,
            QUIZ_DATA.activity,
            currentState.selectedBlock,
            "TOTAL",
            totalTime,
            currentState.correctAnswers,
            currentState.wrongAnswers,
            score,
          ].join(",") + "\n";

        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `operacoes_matematicas_bloco_${currentState.selectedBlock}_${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      // Go back to block selection
      function backToBlocks() {
        currentState.selectedBlock = null;
        currentState.currentQuestion = 0;

        document.getElementById("question-screen").classList.add("hidden");
        document.getElementById("results-screen").classList.add("hidden");
        document.getElementById("block-selection").classList.remove("hidden");

        updateProgress();
      }

      // Update progress bar
      function updateProgress() {
        const progressFill = document.getElementById("progress-fill");
        const progressText = document.getElementById("progress-text");

        if (!currentState.selectedBlock) {
          progressFill.style.width = "0%";
          progressText.textContent = "Selecione um bloco para começar";
          return;
        }

        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );
        const progress =
          ((currentState.currentQuestion + 1) / block.questions.length) * 100;

        progressFill.style.width = `${progress}%`;
        progressText.textContent = `${block.name} - Questão ${currentState.currentQuestion + 1} de ${block.questions.length}`;
      }

      // Setup audio button functionality
      function setupAudioButton() {
        const audioButton = document.getElementById("audio-btn");
        audioButton.onclick = () => playAudio();
      }

      // Play audio for current question
      function playAudio() {
        const block = QUIZ_DATA.blocks.find(
          (b) => b.id === currentState.selectedBlock,
        );
        const audioPath = `../media/${QUIZ_DATA.subject}/${QUIZ_DATA.activity}/bloco_${currentState.selectedBlock}/questao_${currentState.currentQuestion + 1}_enunciado.mp3`;

        // Try to play audio, fallback to text-to-speech if available
        const audio = new Audio(audioPath);
        audio.onerror = () => {
          // Fallback: try text-to-speech if supported
          if ("speechSynthesis" in window) {
            const utterance = new SpeechSynthesisUtterance(
              block.questions[currentState.currentQuestion].text,
            );
            utterance.lang = "pt-BR";
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
          } else {
            console.log(
              "Audio file not found and text-to-speech not supported",
            );
          }
        };
        audio.play().catch(() => {
          // Fallback to text-to-speech
          if ("speechSynthesis" in window) {
            const utterance = new SpeechSynthesisUtterance(
              block.questions[currentState.currentQuestion].text,
            );
            utterance.lang = "pt-BR";
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
          }
        });
      }

      // Setup global event listeners
      function setupEventListeners() {
        // Keyboard navigation
        document.addEventListener("keydown", (e) => {
          if (currentState.selectedBlock && !currentState.showFeedback) {
            const key = e.key;
            if (["1", "2", "3", "4"].includes(key)) {
              const index = parseInt(key) - 1;
              const buttons = document.querySelectorAll(".option-button");
              if (buttons[index]) {
                buttons[index].click();
              }
            }
          }

          // Space bar for audio
          if (e.code === "Space" && currentState.selectedBlock) {
            e.preventDefault();
            playAudio();
          }

          // Enter for next question (when feedback is shown)
          if (e.code === "Enter" && currentState.showFeedback) {
            handleNext();
          }

          // Escape to go back
          if (e.code === "Escape") {
            backToBlocks();
          }
        });

        // Prevent context menu on right click for better mobile experience
        document.addEventListener("contextmenu", (e) => {
          e.preventDefault();
        });
      }

      // Initialize the app when DOM is loaded
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
